generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id                 String   @id @default(cuid())
  email              String   @unique
  name               String
  passwordHash       String
  accountType        String   @default("user")
  creditTier         Int      @default(1)
  creditLimit        Float    @default(100)
  lastTierUpdate     DateTime?
  onboardingComplete Boolean  @default(false)
  interests          String?   // Comma-separated interest tags
  lastLoginAt        DateTime?
  archivedAt         DateTime?
  profileVisibility  String   @default("private") // private, community, public
  bio                String?
  avatarUrl          String?
  followerCount      Int      @default(0)
  followingCount     Int      @default(0)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  watershed          Watershed?
  allocations        Allocation[]
  adViews            AdView[]
  contributions      Contribution[]
  borrowerLoans      Loan[]      @relation("BorrowerLoans")
  fundedShares       LoanShare[] @relation("FunderShares")
  referrals          Referral[]  @relation("Referrals")
  referredBy         Referral?   @relation("ReferredBy")
  badges             UserBadge[]
  streaks            Streak[]
  communities        CommunityMember[]
  createdCommunities Community[] @relation("CreatedCommunities")
  adPreference       AdPreference?
  notifications      Notification[]
  discussions        Discussion[]
  comments           Comment[]
  projectVotes       ProjectVote[]
  tierHistory        LoanTierHistory[]
  roles              UserRole[]
  sponsorships           LoanSponsorship[] @relation("SponsorShips")
  aquiferContributions   AquiferContribution[]
  flagshipVotes          FlagshipVote[]
  flagshipSponsors       FlagshipSponsor[]
  loanQuestions          LoanQuestion[]    @relation("LoanQuestionsAsked")
  businessListings          BusinessListing[]
  businessViews             BusinessView[]    @relation("BusinessViews")
  savedBusinesses           SavedBusiness[]   @relation("SavedBusinesses")
  businessRecommendations   BusinessRecommendation[] @relation("BusinessRecommendations")
  grantVolunteering         CommunityGrantVolunteer[] @relation("GrantVolunteers")
  notificationPreference    NotificationPreference?
  proposals                 ProjectProposal[] @relation("ProposedProjects")
  deadlineExtensions        LoanDeadlineExtension[] @relation("DeadlineExtensions")
  projectFollows            ProjectFollow[]
  ralliesCreated            Rally[]             @relation("RalliesCreated")
  rallyParticipations       RallyParticipant[]  @relation("RallyParticipations")
  following                 UserFollow[]        @relation("Following")
  followers                 UserFollow[]        @relation("Followers")
  communityFollows          CommunityFollow[]   @relation("CommunityFollows")
  feedItems                 FeedItem[]          @relation("FeedItems")
  mentionedIn               DiscussionMention[] @relation("DiscussionMentions")
  badgeProgress             BadgeProgress[]
  pushSubscriptions         PushSubscription[]
  familyMembership          FamilyMember?
  receipts                  ContributionReceipt[]
  annualSummaries           AnnualGivingSummary[]
  recurringContributions    RecurringContribution[]
  projectSubscriptions      ProjectSubscription[]
  communitySubscriptions    CommunitySubscription[]
  givingGoals               PersonalGivingGoal[]
  volunteerSignups          VolunteerSignup[]
  volunteerLogs             VolunteerLog[]
  skills                    UserSkill[]
  inKindDonations           InKindDonation[]
  totalVerifiedHours        Float     @default(0)
  corporateEmployee         CorporateEmployee?
  circleMemberships         CircleMember[]
  giftContributions         GiftContribution[]
  birthdayFundraisers       BirthdayFundraiser[]
  scheduledGifts            ScheduledGift[]
  creditReportingConsents   CreditReportingConsent[]
  creditDisputes            CreditDispute[]
  advocateProfile           CommunityAdvocate?
  advocateInterest          AdvocateInterest?
  identityVerifications     IdentityVerification[]
  auditorProfile            Auditor?
  apiKeys                   ApiKey[]
  webhooks                  Webhook[]
  oauthApps                 OAuthApp[]
  oauthAuthorizations       OAuthAuthorization[]
  // Plan 20: Smart Discovery
  interestProfile           UserInterestProfile?
  digestPreferences         DigestPreferences?
  discoveryChallenges       DiscoveryChallenge[]
  // Plan 21: Learning Resources
  givingPlan                GivingPlan?
  reflections               ReflectionEntry[]
  certificates              LearningCertificate[]
  // Plan 22: Institutional Partnerships
  institutionAdmins         InstitutionAdmin[]
  // Plan 23: Mentorship & Community Support
  mentorProfile             Mentor?
  menteeProfile             Mentee?
  // Plan 25: Accessibility & i18n
  localePreferences         UserLocale?
  accessibilityPreferences  AccessibilityPreferences?
  // Plan 26: Grants & Large Funding
  grantApplications         GrantApplication[]
  // Plan 27: Blockchain Transparency
  impactCertificates        ImpactCertificate[]
  // Plan 29: Community Marketplace
  sellerListings            MarketplaceListing[]  @relation("SellerListings")
  buyerTransactions         MarketplaceTransaction[] @relation("BuyerTransactions")
  sellerTransactions        MarketplaceTransaction[] @relation("SellerTransactions")
  // Plan 30: Fundraising Events
  auctionBids               AuctionBid[]
  // Plan 31: Pledge Campaigns
  campaignsCreated          PledgeCampaign[] @relation("CampaignsCreated")
  pledges                   Pledge[]         @relation("Pledges")
  campaignComments          CampaignComment[] @relation("CampaignComments")
  // Plan 32: Gift Cards & Store Credit
  purchasedGiftCards        GiftCard[]       @relation("PurchasedGiftCards")
  redeemedGiftCards         GiftCard[]       @relation("RedeemedGiftCards")
  storeCredit               StoreCredit?
  // Plan 33: Nonprofit Partner Portal
  organizationMemberships   OrganizationMember[]
  // Plan 35: Multi-Currency & Global
  currencyPreference        UserCurrencyPreference?
  userRegion                UserRegion?
  paymentMethods            UserPaymentMethod[]
  // Plan 36: Notification Center
  notificationChannels      NotificationChannel[]
  notificationDigests       NotificationDigest[]
  // Plan 37: Social Integrations
  socialAccounts            SocialAccount[]
  socialPosts               SocialPost[]
  importedContacts          ImportedContact[]
  // Plan 38: Community Celebrations
  reflectionCards           ReflectionCard[]
  journeyMemberships        JourneyMember[]
  // Plan 39: Privacy & Security
  consents                  UserConsent[]
  privacySettings           PrivacySettings?
  dataRequests              DataRequest[]
  securityEvents            SecurityEvent[]
  securitySessions          SecuritySession[]
  twoFactorAuth             TwoFactorAuth?
  recoveryRequests          AccountRecovery[]
}

model Watershed {
  id               String   @id @default(cuid())
  userId           String   @unique
  balance          Float    @default(0)
  totalInflow      Float    @default(0)
  totalOutflow     Float    @default(0)
  floatContributed Float    @default(0) // Cumulative float interest attributed to this watershed
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  user         User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions WatershedTransaction[]
  familyShared Family[]
}

model WatershedTransaction {
  id           String   @id @default(cuid())
  watershedId  String
  type         String // ad_credit, cash_contribution, project_allocation
  amount       Float
  description  String?
  balanceAfter Float
  createdAt    DateTime @default(now())

  watershed Watershed @relation(fields: [watershedId], references: [id], onDelete: Cascade)
}

model Project {
  id                 String   @id @default(cuid())
  title              String
  description        String
  category           String
  fundingGoal        Float
  fundingRaised      Float    @default(0)
  backerCount        Int      @default(0)
  status             String   @default("active") // active, funded, completed
  location           String
  imageUrl           String?
  isFlagship         Boolean  @default(false)
  disbursedAmount    Float    @default(0)
  disbursementStatus String   @default("none") // "none" | "partial" | "disbursed"
  completedAt        DateTime?
  impactSummary      String?
  // Tax info
  taxDeductible      Boolean  @default(false)
  ein                String?  // Employer Identification Number
  orgName            String?  // Legal organization name
  orgType            String?  // 501c3, 501c4, government, etc.
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  allocations    Allocation[]
  communities    CommunityProject[]
  votes          ProjectVote[]
  flagship       FlagshipProject?
  disbursements  ProjectDisbursement[]
  updates        ProjectUpdate[]
  grant          CommunityGrant?
  proposal       ProjectProposal?
  impactMetrics  ImpactMetric[]
  followers      ProjectFollow[]
  rallies               Rally[]
  shareEvents           ShareEvent[]
  momentumScore         Float     @default(0)
  momentumUpdatedAt     DateTime?
  cascadeSponsorEvents  CascadeSponsorEvent[]
  subscriptions         ProjectSubscription[]
  volunteerOpportunities VolunteerOpportunity[]
  inKindDonations        InKindDonation[]
  needs                  ProjectNeed[]
  birthdayFundraisers    BirthdayFundraiser[]
  verification           ProjectVerification?
  outcomeVerifications   OutcomeVerification[]
  flags                  ProjectFlag[]
  // Plan 24: Impact Storytelling
  impactStories          ImpactStory[]
  beforeAfters           BeforeAfter[]
  // Plan 31: Pledge Campaigns
  pledgeCampaigns        PledgeCampaign[]
}

model Allocation {
  id             String    @id @default(cuid())
  userId         String
  projectId      String
  amount         Float
  status         String    @default("pledged") // "pledged" | "disbursed"
  disbursedAt    DateTime?
  disbursementId String?
  createdAt      DateTime  @default(now())

  user         User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  project      Project              @relation(fields: [projectId], references: [id], onDelete: Cascade)
  disbursement ProjectDisbursement? @relation(fields: [disbursementId], references: [id], onDelete: SetNull)

  @@index([status])
}

model AdView {
  id               String   @id @default(cuid())
  userId           String
  grossRevenue     Float
  platformCut      Float
  watershedCredit  Float
  completionRate   Float    @default(1.0)
  provider         String   @default("demo")
  format           String   @default("video")
  adUnitId         String?
  eCPM             Float?
  impressionId     String?
  settlementId     String?
  settlementStatus String   @default("pending") // "pending" | "cleared"
  createdAt        DateTime @default(now())

  user       User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  settlement RevenueSettlement? @relation(fields: [settlementId], references: [id], onDelete: SetNull)

  @@index([settlementStatus])
}

model Contribution {
  id              String   @id @default(cuid())
  userId          String
  amount          Float
  type            String // cash, simulated
  watershedCredit Float
  createdAt       DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Loan {
  id              String   @id @default(cuid())
  borrowerId      String
  amount          Float
  totalShares     Int
  sharesRemaining Int
  purpose         String
  purposeCategory String
  story           String?
  location        String
  status          String   @default("funding") // funding, active, repaying, completed, defaulted, expired, recovering
  tier            Int      @default(1)
  latePayments    Int      @default(0)
  fundingDeadline DateTime
  repaymentMonths Int
  monthlyPayment  Float
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  seekingSponsor    Boolean  @default(false)
  sponsorshipAmount Float    @default(0)

  // Default/recovery tracking
  recoveryStartedAt DateTime?
  defaultedAt       DateTime?
  recoveryPayments  Int       @default(0) // Consecutive on-time payments during recovery

  borrower           User                    @relation("BorrowerLoans", fields: [borrowerId], references: [id])
  shares             LoanShare[]
  repayments         LoanRepayment[]
  sponsorships       LoanSponsorship[]
  stretchGoals       LoanStretchGoal[]
  questions          LoanQuestion[]
  goalVerification   GoalVerification?
  refinances         LoanRefinance[]
  deadlineExtensions LoanDeadlineExtension[]
  creditReportingConsent CreditReportingConsent?
  creditReportingStatus  CreditReportingStatus?
  metro2Records          Metro2Record[]
  creditDisputes         CreditDispute[]
}

model LoanStretchGoal {
  id        String   @id @default(cuid())
  loanId    String
  priority  Int      // 1, 2, or 3
  amount    Float
  purpose   String
  funded    Boolean  @default(false)
  createdAt DateTime @default(now())

  loan Loan @relation(fields: [loanId], references: [id], onDelete: Cascade)

  @@unique([loanId, priority])
}

model LoanQuestion {
  id         String    @id @default(cuid())
  loanId     String
  askerId    String
  question   String    // max 280 chars
  answer     String?
  answeredAt DateTime?
  flagCount  Int       @default(0)
  hidden     Boolean   @default(false)
  createdAt  DateTime  @default(now())

  loan  Loan @relation(fields: [loanId], references: [id], onDelete: Cascade)
  asker User @relation("LoanQuestionsAsked", fields: [askerId], references: [id])

  @@index([loanId])
}

model GoalVerification {
  id          String   @id @default(cuid())
  loanId      String   @unique
  photoUrls   String   // JSON array of URLs
  receiptUrls String?  // JSON array of URLs
  description String?
  status      String   @default("pending") // pending, approved, flagged
  flagCount   Int      @default(0)
  submittedAt DateTime @default(now())

  loan Loan @relation(fields: [loanId], references: [id], onDelete: Cascade)
}

model LoanRefinance {
  id              String   @id @default(cuid())
  loanId          String
  previousPayment Float
  newPayment      Float
  previousTerm    Int
  newTerm         Int
  fee             Float
  reason          String?
  createdAt       DateTime @default(now())

  loan Loan @relation(fields: [loanId], references: [id], onDelete: Cascade)
}

model LoanDeadlineExtension {
  id            String   @id @default(cuid())
  loanId        String
  sponsorId     String
  extensionDays Int
  extendedAt    DateTime @default(now())

  loan    Loan @relation(fields: [loanId], references: [id], onDelete: Cascade)
  sponsor User @relation("DeadlineExtensions", fields: [sponsorId], references: [id])

  @@index([loanId])
}

model LoanShare {
  id        String   @id @default(cuid())
  loanId    String
  funderId  String
  count     Int
  amount    Float
  repaid    Float    @default(0)
  createdAt DateTime @default(now())

  loan   Loan @relation(fields: [loanId], references: [id], onDelete: Cascade)
  funder User @relation("FunderShares", fields: [funderId], references: [id])
}

model LoanRepayment {
  id            String   @id @default(cuid())
  loanId        String
  amount        Float
  principalPaid Float
  servicingFee  Float
  createdAt     DateTime @default(now())

  loan Loan @relation(fields: [loanId], references: [id], onDelete: Cascade)
}

model LoanTierHistory {
  id        String   @id @default(cuid())
  userId    String
  fromTier  Int
  toTier    Int
  reason    String
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Referral {
  id                  String    @id @default(cuid())
  referrerId          String
  referredId          String?   @unique
  code                String    @unique
  status              String    @default("pending") // pending, signed_up, activated, expired
  signupCredit        Float     @default(0)
  actionCredit        Float     @default(0)
  retentionCredit     Float     @default(0)
  retentionCheckedAt  DateTime?
  createdAt           DateTime  @default(now())
  activatedAt         DateTime?

  referrer User  @relation("Referrals", fields: [referrerId], references: [id])
  referred User? @relation("ReferredBy", fields: [referredId], references: [id])
}

model Badge {
  id          String @id @default(cuid())
  key         String @unique
  name        String
  description String
  tier        String
  icon        String
  createdAt   DateTime @default(now())

  userBadges UserBadge[]
}

model UserBadge {
  id       String   @id @default(cuid())
  userId   String
  badgeId  String
  earnedAt DateTime @default(now())
  featured Boolean  @default(false) // Show on profile

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  badge Badge @relation(fields: [badgeId], references: [id], onDelete: Cascade)

  @@unique([userId, badgeId])
  @@index([userId])
}

model BadgeProgress {
  id           String   @id @default(cuid())
  userId       String
  badgeKey     String   // Badge key (e.g., "projects_10")
  currentValue Float    @default(0)
  targetValue  Float
  updatedAt    DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, badgeKey])
  @@index([userId])
}

model Streak {
  id              String    @id @default(cuid())
  userId          String
  type            String
  currentDays     Int       @default(0)
  longestDays     Int       @default(0)
  lastActiveDate  DateTime?
  gracePeriodUsed Boolean   @default(false)
  graceExpiresAt  DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, type])
}

model Community {
  id           String   @id @default(cuid())
  name         String
  description  String
  location     String?
  category     String?
  imageUrl     String?
  createdBy    String
  memberCount  Int      @default(1)
  followerCount Int     @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Type: geographic (uses hierarchy) or interest (flat, no hierarchy)
  type        String   @default("geographic")

  // Hierarchy (geographic communities only)
  parentId    String?
  level       String?  // country, state, county, city, district, neighborhood (null for interest)
  slug        String?  @unique // url-friendly: "usa/idaho/ada-county/boise"

  // Geographic coordinates
  latitude    Float?
  longitude   Float?
  bounds      String?  // GeoJSON polygon for map rendering (JSON string)

  // Relations
  creator     User              @relation("CreatedCommunities", fields: [createdBy], references: [id])
  members     CommunityMember[]
  projects    CommunityProject[]
  discussions Discussion[]
  votes       ProjectVote[]    @relation("CommunityVotes")
  elections   CommunityElection[]

  // Hierarchy relations
  parent      Community?  @relation("CommunityHierarchy", fields: [parentId], references: [id])
  children    Community[] @relation("CommunityHierarchy")

  // Community Enhancement Features
  goals              CommunityGoal[]
  milestones         CommunityMilestone[]
  events             CommunityEvent[]
  flagshipNominations FlagshipProject[]
  followers          CommunityFollow[] @relation("CommunityFollowers")
  subscriptions      CommunitySubscription[]
  // Plan 24: Impact Storytelling
  impactStories      ImpactStory[]
  // Plan 29: Community Marketplace
  marketplaceListings MarketplaceListing[]
  // Plan 30: Fundraising Events
  fundraisingEvents FundraisingEvent[]

  @@index([parentId])
  @@index([level])
  @@index([type])
}

model CommunityMember {
  id          String   @id @default(cuid())
  communityId String
  userId      String
  role        String   @default("member") // member, admin
  joinedAt    DateTime @default(now())

  community Community @relation(fields: [communityId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([communityId, userId])
}

model CommunityProject {
  id          String   @id @default(cuid())
  communityId String
  projectId   String
  addedBy     String
  createdAt   DateTime @default(now())

  community Community @relation(fields: [communityId], references: [id], onDelete: Cascade)
  project   Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([communityId, projectId])
}

// --- Notifications System (Plan 22) ---
model Notification {
  id        String   @id @default(cuid())
  userId    String
  type      String   // loan_funded, loan_payment_received, badge_earned, project_milestone, referral_signup, referral_activated
  title     String
  message   String
  data      String?  // JSON string for navigation/context data
  read      Boolean  @default(false)
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, read])
}

// --- Voting & Discussions (Plan 21) ---
model Discussion {
  id          String   @id @default(cuid())
  communityId String
  userId      String
  title       String
  body        String
  parentId    String?  // For threaded replies
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  community Community @relation(fields: [communityId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  comments  Comment[]
  parent    Discussion?  @relation("DiscussionReplies", fields: [parentId], references: [id])
  replies   Discussion[] @relation("DiscussionReplies")
  mentions  DiscussionMention[]

  @@index([parentId])
}

model Comment {
  id           String   @id @default(cuid())
  discussionId String
  userId       String
  body         String
  createdAt    DateTime @default(now())

  discussion Discussion @relation(fields: [discussionId], references: [id], onDelete: Cascade)
  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model ProjectVote {
  id          String @id @default(cuid())
  communityId String
  projectId   String
  userId      String
  vote        Int    // 1 = up, -1 = down

  community Community @relation("CommunityVotes", fields: [communityId], references: [id], onDelete: Cascade)
  project   Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([communityId, projectId, userId])
}

model AdPreference {
  id                String   @id @default(cuid())
  userId            String   @unique
  blockedCategories String   @default("") // comma-separated category keys
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model AuditLog {
  id         String   @id @default(cuid())
  adminId    String
  adminEmail String
  action     String
  targetType String?
  targetId   String?
  details    String?
  createdAt  DateTime @default(now())

  @@index([adminId])
  @@index([action])
  @@index([createdAt])
}

// --- Admin Invites (Phase 2) ---
model AdminInvite {
  id         String    @id @default(cuid())
  email      String    @unique
  invitedBy  String
  token      String    @unique
  status     String    @default("pending") // pending, accepted, expired
  expiresAt  DateTime
  acceptedAt DateTime?
  createdAt  DateTime  @default(now())

  @@index([token])
  @@index([email])
}

// --- Platform Roles (Phase 3) ---
model UserRole {
  id        String    @id @default(cuid())
  userId    String
  role      String    // verified_giver, sponsor, trusted_borrower, mentor
  grantedAt DateTime  @default(now())
  revokedAt DateTime?
  isActive  Boolean   @default(true)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, role])
  @@index([role])
}

model RoleConfig {
  id          String   @id @default(cuid())
  role        String   @unique // verified_giver, sponsor, trusted_borrower, mentor
  displayName String
  description String
  thresholds  String   // JSON string: configurable criteria
  isAutomatic Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// --- Loan Sponsorship (Phase 5) ---
model LoanSponsorship {
  id        String   @id @default(cuid())
  loanId    String
  sponsorId String
  amount    Float
  message   String?
  status    String   @default("active") // active, withdrawn
  createdAt DateTime @default(now())

  loan    Loan @relation(fields: [loanId], references: [id], onDelete: Cascade)
  sponsor User @relation("SponsorShips", fields: [sponsorId], references: [id])

  @@unique([loanId, sponsorId])
}

// --- Community Elections (Phase 6) ---
model CommunityElection {
  id            String   @id @default(cuid())
  communityId   String
  role          String   // steward, steward:projects, steward:finance, steward:membership, champion
  status        String   @default("nominating") // nominating, voting, completed, cancelled
  nominationEnd DateTime
  votingEnd     DateTime
  termEnd       DateTime
  winnerId      String?
  createdAt     DateTime @default(now())

  community   Community             @relation(fields: [communityId], references: [id], onDelete: Cascade)
  nominations ElectionNomination[]
  votes       ElectionVote[]

  @@index([communityId, status])
}

model ElectionNomination {
  id          String   @id @default(cuid())
  electionId  String
  nomineeId   String
  nominatedBy String
  createdAt   DateTime @default(now())

  election CommunityElection @relation(fields: [electionId], references: [id], onDelete: Cascade)

  @@unique([electionId, nomineeId])
}

model ElectionVote {
  id         String   @id @default(cuid())
  electionId String
  voterId    String
  nomineeId  String
  createdAt  DateTime @default(now())

  election CommunityElection @relation(fields: [electionId], references: [id], onDelete: Cascade)

  @@unique([electionId, voterId])
}

// --- Aquifer System ---
model StrategicPlan {
  id          String   @id @default(cuid())
  title       String
  description String
  vision      String   // Long-form explanation of what we're building and why
  fundingGoal Float
  status      String   @default("active") // active, funded, completed, archived
  order       Int      @default(0) // For queuing next plans
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  flagships FlagshipProject[]
}

model Aquifer {
  id        String   @id @default(cuid())
  type      String   @unique // "reserve" or "pool"
  balance   Float    @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  contributions AquiferContribution[]
}

model AquiferContribution {
  id         String   @id @default(cuid())
  aquiferId  String
  userId     String?  // null if Deluge contribution
  amount     Float
  isDeluge   Boolean  @default(false)
  note       String?
  createdAt  DateTime @default(now())

  aquifer Aquifer @relation(fields: [aquiferId], references: [id], onDelete: Cascade)
  user    User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([aquiferId])
}

model FlagshipProject {
  id                    String    @id @default(cuid())
  projectId             String    @unique
  strategicPlanId       String?   // Required for reserve-funded, null for pool-funded
  nominatingCommunityId String?   // Community that nominated this for Aquifer (Phase 7)
  status                String    @default("active") // active, voting, funded, tabled, rejected
  fundingSource         String    @default("reserve") // reserve, pool
  votingEndsAt          DateTime?
  tabledAt              DateTime?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  project             Project          @relation(fields: [projectId], references: [id], onDelete: Cascade)
  strategicPlan       StrategicPlan?   @relation(fields: [strategicPlanId], references: [id], onDelete: SetNull)
  nominatingCommunity Community?       @relation(fields: [nominatingCommunityId], references: [id], onDelete: SetNull)
  votes               FlagshipVote[]
  sponsors            FlagshipSponsor[]

  @@index([strategicPlanId])
  @@index([nominatingCommunityId])
}

model FlagshipVote {
  id                String   @id @default(cuid())
  flagshipProjectId String
  userId            String
  vote              String   // approve, reject, table
  createdAt         DateTime @default(now())

  flagshipProject FlagshipProject @relation(fields: [flagshipProjectId], references: [id], onDelete: Cascade)
  user            User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([flagshipProjectId, userId])
}

model FlagshipSponsor {
  id                String   @id @default(cuid())
  flagshipProjectId String
  userId            String
  createdAt         DateTime @default(now())

  flagshipProject FlagshipProject @relation(fields: [flagshipProjectId], references: [id], onDelete: Cascade)
  user            User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([flagshipProjectId, userId])
}

// --- Revenue Settlement & Reserve System ---

model RevenueSettlement {
  id                    String    @id @default(cuid())
  batchDate             DateTime  @default(now())
  totalGross            Float
  totalPlatformCut      Float
  totalWatershedCredit  Float
  adViewCount           Int
  status                String    @default("pending") // "pending" | "cleared"
  netTermDays           Int       @default(30)
  expectedClearDate     DateTime
  clearedAt             DateTime?
  providerRef           String?
  notes                 String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  adViews AdView[]

  @@index([status])
}

model PlatformReserve {
  id               String   @id @default(cuid())
  balance          Float    @default(0)
  totalInflow      Float    @default(0)
  totalOutflow     Float    @default(0)
  totalReplenished Float    @default(0)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  transactions ReserveTransaction[]
}

model ReserveTransaction {
  id            String   @id @default(cuid())
  reserveId     String
  type          String   // "platform_cut_accrual" | "disbursement_fronted" | "revenue_cleared" | "manual_adjustment"
  amount        Float
  balanceAfter  Float
  referenceType String?  // "settlement" | "disbursement" | null
  referenceId   String?
  description   String?
  createdAt     DateTime @default(now())

  reserve PlatformReserve @relation(fields: [reserveId], references: [id], onDelete: Cascade)

  @@index([reserveId])
  @@index([type])
}

model ProjectDisbursement {
  id          String    @id @default(cuid())
  projectId   String
  amount      Float
  source      String    // "reserve_fronted" | "cleared_revenue" | "direct"
  status      String    @default("pending") // "pending" | "processing" | "completed" | "failed"
  initiatedBy String?
  paymentRef  String?
  notes       String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  project     Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  allocations Allocation[]

  @@index([projectId])
  @@index([status])
}

// --- Project Updates ---
model ProjectUpdate {
  id        String   @id @default(cuid())
  projectId String
  type      String   @default("text") // text, photo, milestone, completion
  title     String
  body      String
  imageUrls String?  // JSON array
  createdAt DateTime @default(now())

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId, createdAt])
}

model ImpactMetric {
  id         String   @id @default(cuid())
  projectId  String
  name       String   // e.g., "Students Served", "Trees Planted"
  value      Float
  unit       String   // e.g., "students", "trees"
  reportedAt DateTime @default(now())

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
}

model ProjectFollow {
  id        String   @id @default(cuid())
  userId    String
  projectId String
  createdAt DateTime @default(now())

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([userId, projectId])
}

model Rally {
  id          String   @id @default(cuid())
  projectId   String
  creatorId   String
  title       String   // "Let's get 50 backers by Friday!"
  targetType  String   // "backers" or "amount"
  targetValue Float    // 50 backers or $500
  deadline    DateTime
  status      String   @default("active") // active, succeeded, failed
  createdAt   DateTime @default(now())

  project      Project            @relation(fields: [projectId], references: [id], onDelete: Cascade)
  creator      User               @relation("RalliesCreated", fields: [creatorId], references: [id])
  participants RallyParticipant[]

  @@index([projectId, status])
  @@index([deadline])
}

model RallyParticipant {
  id       String   @id @default(cuid())
  rallyId  String
  userId   String
  joinedAt DateTime @default(now())

  rally Rally @relation(fields: [rallyId], references: [id], onDelete: Cascade)
  user  User  @relation("RallyParticipations", fields: [userId], references: [id])

  @@unique([rallyId, userId])
}

model ShareEvent {
  id        String   @id @default(cuid())
  projectId String
  userId    String?  // null for anonymous shares
  platform  String   // twitter, facebook, email, copy, other
  createdAt DateTime @default(now())

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId, createdAt])
}

// --- Activity Feed ---
model ActivityFeedItem {
  id          String   @id @default(cuid())
  type        String   // cascade, loan_funded, milestone, community_join
  actorId     String?
  subjectType String   // project, loan, community
  subjectId   String
  metadata    String?  // JSON
  isPublic    Boolean  @default(true)
  createdAt   DateTime @default(now())

  @@index([subjectType, subjectId])
  @@index([createdAt])
}

// --- Notification Preferences ---
model NotificationPreference {
  id            String  @id @default(cuid())
  userId        String  @unique
  cascades      String  @default("all") // all, push, in_app, none
  loanUpdates   String  @default("all")
  referrals     String  @default("all")
  communityNews String  @default("in_app")
  weeklyDigest  Boolean @default(true)
  pushToken     String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// --- Business Card Directory ---
model BusinessListing {
  id          String   @id @default(cuid())
  ownerId     String
  name        String
  category    String
  description String   // max 50 words
  location    String
  address     String?
  latitude    Float?
  longitude   Float?
  phone       String?
  website     String?
  imageUrl    String?
  tier        String   @default("basic") // basic, enhanced
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  owner           User           @relation(fields: [ownerId], references: [id])
  views           BusinessView[]
  saves           SavedBusiness[]
  recommendations BusinessRecommendation[]
  cascadeSponsors     CascadeSponsor[]
  notificationSponsors NotificationSponsor[]

  @@index([category])
  @@index([location])
}

model BusinessView {
  id          String   @id @default(cuid())
  listingId   String
  viewerId    String
  revenue     Float    // ~$0.001-0.003
  platformCut Float
  projectId   String?  // Where revenue flows (optional)
  createdAt   DateTime @default(now())

  listing BusinessListing @relation(fields: [listingId], references: [id], onDelete: Cascade)
  viewer  User            @relation("BusinessViews", fields: [viewerId], references: [id])

  @@index([listingId])
  @@index([viewerId, createdAt])
}

model SavedBusiness {
  id        String   @id @default(cuid())
  userId    String
  listingId String
  savedAt   DateTime @default(now())

  user    User            @relation("SavedBusinesses", fields: [userId], references: [id], onDelete: Cascade)
  listing BusinessListing @relation(fields: [listingId], references: [id], onDelete: Cascade)

  @@unique([userId, listingId])
}

model BusinessRecommendation {
  id        String   @id @default(cuid())
  userId    String
  listingId String
  note      String
  createdAt DateTime @default(now())

  user    User            @relation("BusinessRecommendations", fields: [userId], references: [id], onDelete: Cascade)
  listing BusinessListing @relation(fields: [listingId], references: [id], onDelete: Cascade)

  @@unique([userId, listingId])
}

// --- Corporate Matching Campaigns ---
model MatchingCampaign {
  id              String    @id @default(cuid())
  name            String
  corporateName   String
  description     String
  logoUrl         String?
  matchRatio      Float     @default(1.0) // 2x = 2.0, 3x = 3.0
  totalBudget     Float
  remainingBudget Float
  targetType      String    // all, category, project
  targetValue     String?   // category name or project ID
  startsAt        DateTime
  endsAt          DateTime
  status          String    @default("active") // draft, active, paused, completed
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  matches         MatchingContribution[]
  cascadeSponsors CascadeSponsor[]
}

model MatchingContribution {
  id          String   @id @default(cuid())
  campaignId  String
  userId      String
  projectId   String
  userAmount  Float
  matchAmount Float
  createdAt   DateTime @default(now())

  campaign MatchingCampaign @relation(fields: [campaignId], references: [id])
}

// --- Community Grants ---
model CommunityGrant {
  id             String    @id @default(cuid())
  projectId      String    @unique
  volunteerSlots Int
  watershedCredit Float    // Credit per volunteer
  requirements   String    // What volunteers need to do
  beforePhotos   String?   // JSON array
  afterPhotos    String?   // JSON array
  completedAt    DateTime?
  createdAt      DateTime  @default(now())

  project    Project                   @relation(fields: [projectId], references: [id])
  volunteers CommunityGrantVolunteer[]
}

model CommunityGrantVolunteer {
  id          String    @id @default(cuid())
  grantId     String
  userId      String
  status      String    @default("claimed") // claimed, completed, verified, cancelled
  completedAt DateTime?
  verifiedAt  DateTime?
  createdAt   DateTime  @default(now())

  grant CommunityGrant @relation(fields: [grantId], references: [id], onDelete: Cascade)
  user  User           @relation("GrantVolunteers", fields: [userId], references: [id])

  @@unique([grantId, userId])
}

// --- Community Enhancement Features ---

// Community Goals/Campaigns (Phase 2)
model CommunityGoal {
  id            String   @id @default(cuid())
  communityId   String
  title         String
  description   String
  targetAmount  Float
  currentAmount Float    @default(0)
  deadline      DateTime
  status        String   @default("active") // active, completed, expired
  category      String?
  createdBy     String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  community Community @relation(fields: [communityId], references: [id], onDelete: Cascade)

  @@index([communityId, status])
}

// Community Milestones (Phase 4)
model CommunityMilestone {
  id          String   @id @default(cuid())
  communityId String
  type        String   // funding_1k, funding_5k, members_100, projects_10
  reachedAt   DateTime @default(now())

  community Community @relation(fields: [communityId], references: [id], onDelete: Cascade)

  @@unique([communityId, type])
}

// Community Events (Phase 5)
model CommunityEvent {
  id           String    @id @default(cuid())
  communityId  String
  title        String
  description  String
  date         DateTime
  endDate      DateTime?
  location     String?
  type         String    // meetup, volunteer, celebration, launch
  createdBy    String
  createdAt    DateTime  @default(now())

  community Community   @relation(fields: [communityId], references: [id], onDelete: Cascade)
  rsvps     EventRSVP[]

  @@index([communityId, date])
}

model EventRSVP {
  id        String   @id @default(cuid())
  eventId   String
  userId    String
  status    String   @default("attending") // attending, maybe, declined
  createdAt DateTime @default(now())

  event CommunityEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@unique([eventId, userId])
}

// Community Challenges (Phase 8)
model CommunityChallenge {
  id          String   @id @default(cuid())
  title       String
  description String
  startDate   DateTime
  endDate     DateTime
  category    String?
  metric      String   // funding_amount, projects_funded
  status      String   @default("active") // draft, active, completed
  createdBy   String
  createdAt   DateTime @default(now())

  entries ChallengeEntry[]

  @@index([status, startDate])
}

model ChallengeEntry {
  id           String   @id @default(cuid())
  challengeId  String
  communityId  String
  currentValue Float    @default(0)
  updatedAt    DateTime @updatedAt

  challenge CommunityChallenge @relation(fields: [challengeId], references: [id], onDelete: Cascade)

  @@unique([challengeId, communityId])
}

// --- Project Proposals (Plan 1) ---
model ProjectProposal {
  id             String    @id @default(cuid())
  proposerId     String
  title          String
  description    String
  fundingGoal    Float
  deadline       DateTime
  category       String
  location       String
  imageUrl       String?
  gallery        String?   // JSON array of URLs

  // Organization info
  orgName        String
  orgType        String    // nonprofit, school, community_org, small_business, individual
  ein            String?   // if nonprofit
  verificationDocs String? // JSON array of URLs

  // Impact plan
  fundsCover     String    // What the funds will cover
  successMetrics String    // How success will be measured
  reportingPlan  String    // Commitment to reporting

  // Review workflow
  status         String    @default("draft") // draft, submitted, in_review, approved, rejected
  reviewerNotes  String?
  reviewedBy     String?
  reviewedAt     DateTime?

  // Converted project (after approval)
  projectId      String?   @unique

  submittedAt    DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  proposer User     @relation("ProposedProjects", fields: [proposerId], references: [id], onDelete: Cascade)
  project  Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)

  @@index([proposerId])
  @@index([status])
}

// --- Social Features (Plan 4) ---

model UserFollow {
  id         String   @id @default(cuid())
  followerId String
  followeeId String
  createdAt  DateTime @default(now())

  follower User @relation("Following", fields: [followerId], references: [id], onDelete: Cascade)
  followee User @relation("Followers", fields: [followeeId], references: [id], onDelete: Cascade)

  @@unique([followerId, followeeId])
  @@index([followerId])
  @@index([followeeId])
}

model CommunityFollow {
  id          String   @id @default(cuid())
  userId      String
  communityId String
  createdAt   DateTime @default(now())

  user      User      @relation("CommunityFollows", fields: [userId], references: [id], onDelete: Cascade)
  community Community @relation("CommunityFollowers", fields: [communityId], references: [id], onDelete: Cascade)

  @@unique([userId, communityId])
  @@index([userId])
  @@index([communityId])
}

model FeedItem {
  id          String   @id @default(cuid())
  userId      String   // Who this feed item is for

  // Activity details
  actorId     String?  // Who did the action (null for system)
  actionType  String   // funded, cascaded, posted_update, joined, proposed, rally_created, loan_funded, milestone

  // Target references
  projectId   String?
  communityId String?
  loanId      String?
  updateId    String?

  // Denormalized for fast display
  title       String
  description String?

  read        Boolean  @default(false)
  createdAt   DateTime @default(now())

  user User @relation("FeedItems", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([userId, read])
}

model DiscussionMention {
  id           String   @id @default(cuid())
  discussionId String
  userId       String
  createdAt    DateTime @default(now())

  discussion Discussion @relation(fields: [discussionId], references: [id], onDelete: Cascade)
  user       User       @relation("DiscussionMentions", fields: [userId], references: [id])

  @@unique([discussionId, userId])
}

// --- Sponsorship & Push Notifications (Plan 6) ---

model CascadeSponsor {
  id            String    @id @default(cuid())

  // Sponsor details
  sponsorType   String    // business, corporate, matching_campaign
  businessId    String?
  campaignId    String?
  corporateName String?

  // Sponsorship configuration
  tier          String    // basic ($100), featured ($250), premium ($500)
  logoUrl       String?
  message       String?
  linkUrl       String?

  // Targeting (JSON arrays)
  categories    String?
  locations     String?

  // Budget & scheduling
  budgetTotal   Float
  budgetUsed    Float     @default(0)
  costPerCascade Float
  startDate     DateTime
  endDate       DateTime?

  status        String    @default("active") // active, paused, exhausted, expired
  createdAt     DateTime  @default(now())

  business      BusinessListing?  @relation(fields: [businessId], references: [id])
  campaign      MatchingCampaign? @relation(fields: [campaignId], references: [id])
  cascades      CascadeSponsorEvent[]

  @@index([status, startDate])
}

model CascadeSponsorEvent {
  id          String   @id @default(cuid())
  sponsorId   String
  projectId   String

  impressions Int      @default(0)
  clicks      Int      @default(0)

  createdAt   DateTime @default(now())

  sponsor     CascadeSponsor @relation(fields: [sponsorId], references: [id], onDelete: Cascade)
  project     Project        @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([sponsorId])
}

model NotificationSponsor {
  id            String   @id @default(cuid())
  businessId    String

  message       String
  linkUrl       String?

  // Hyperlocal targeting
  latitude      Float
  longitude     Float
  radiusMeters  Int      @default(1000)

  notificationTypes String  // JSON array

  budgetTotal   Float
  budgetUsed    Float    @default(0)
  costPerNotification Float

  status        String   @default("active")
  createdAt     DateTime @default(now())

  business      BusinessListing @relation(fields: [businessId], references: [id])
  events        NotificationSponsorEvent[]

  @@index([status])
}

model NotificationSponsorEvent {
  id          String   @id @default(cuid())
  sponsorId   String
  userId      String

  notificationType String
  delivered   Boolean  @default(false)
  clicked     Boolean  @default(false)

  createdAt   DateTime @default(now())

  sponsor     NotificationSponsor @relation(fields: [sponsorId], references: [id], onDelete: Cascade)

  @@index([sponsorId])
}

model PushSubscription {
  id          String   @id @default(cuid())
  userId      String

  endpoint    String
  p256dh      String
  auth        String

  userAgent   String?

  createdAt   DateTime @default(now())

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// --- Financial Transparency (Plan 7) ---

model FloatSnapshot {
  id              String   @id @default(cuid())
  date            DateTime @unique
  totalWatersheds Float
  totalReserve    Float
  interestRate    Float
  dailyInterest   Float
  createdAt       DateTime @default(now())

  @@index([date])
}

model RevenueRecord {
  id            String   @id @default(cuid())
  date          DateTime
  source        String   // ads, directory, float, corporate, loans, cascade_sponsor, notification_sponsor
  amount        Float
  adViewCount   Int?
  businessCount Int?
  loanVolume    Float?
  createdAt     DateTime @default(now())

  @@index([date, source])
}

model CostRecord {
  id          String   @id @default(cuid())
  date        DateTime
  category    String   // infrastructure, payment_processing, legal, marketing, staffing, other
  description String
  amount      Float
  createdAt   DateTime @default(now())

  @@index([date, category])
}

model TransparencyReport {
  id                String    @id @default(cuid())
  period            String    // "2026-Q1", "2026"
  periodType        String    // quarterly, annual
  totalRevenue      Float
  totalCosts        Float
  netMargin         Float
  revenueBreakdown  String    // JSON
  totalFunded       Float
  totalLoansIssued  Float
  totalUsersActive  Int
  pdfUrl            String?
  publishedAt       DateTime?
  createdAt         DateTime  @default(now())

  @@unique([period, periodType])
}

// --- Family Accounts (Plan 8) ---

model Family {
  id                     String   @id @default(cuid())
  name                   String
  sharedWatershedEnabled Boolean  @default(false)
  sharedWatershedId      String?
  createdAt              DateTime @default(now())

  members         FamilyMember[]
  sharedWatershed Watershed?     @relation(fields: [sharedWatershedId], references: [id])
  goals           FamilyGoal[]

  @@index([sharedWatershedId])
}

model FamilyMember {
  id                String   @id @default(cuid())
  familyId          String
  userId            String   @unique
  role              String   // admin, adult, child
  nickname          String?
  monthlyLimit      Float?
  requireApproval   Boolean  @default(false)
  allowedCategories String?  // JSON array
  joinedAt          DateTime @default(now())

  family Family @relation(fields: [familyId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([familyId])
}

model FamilyGoal {
  id           String    @id @default(cuid())
  familyId     String
  title        String
  description  String?
  targetType   String    // projects_funded, amount_given, categories_supported
  targetValue  Float
  currentValue Float     @default(0)
  deadline     DateTime?
  status       String    @default("active")
  createdAt    DateTime  @default(now())

  family Family @relation(fields: [familyId], references: [id], onDelete: Cascade)

  @@index([familyId, status])
}

model FamilyActivity {
  id          String   @id @default(cuid())
  familyId    String
  memberId    String
  actionType  String
  description String
  projectId   String?
  communityId String?
  badgeId     String?
  amount      Float?
  createdAt   DateTime @default(now())

  @@index([familyId, createdAt])
}

model PendingFamilyAction {
  id         String    @id @default(cuid())
  familyId   String
  memberId   String
  approverId String?
  actionType String
  targetId   String
  amount     Float
  status     String    @default("pending")
  note       String?
  createdAt  DateTime  @default(now())
  resolvedAt DateTime?

  @@index([familyId, status])
}

model FamilyBadge {
  id            String @id @default(cuid())
  slug          String @unique
  name          String
  description   String
  icon          String
  criteriaType  String
  criteriaValue String
}

model FamilyBadgeEarned {
  id       String   @id @default(cuid())
  familyId String
  badgeId  String
  earnedAt DateTime @default(now())

  @@unique([familyId, badgeId])
}

model FamilyInvite {
  id        String   @id @default(cuid())
  familyId  String
  email     String
  role      String   // adult, child
  token     String   @unique
  status    String   @default("pending") // pending, accepted, expired
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([token])
}

// --- Tax & Giving Documentation (Plan 10) ---

model ContributionReceipt {
  id              String    @id @default(cuid())
  userId          String
  contributionId  String?   // For cash contributions
  allocationId    String?   // For project funding
  type            String    // cash, ad_funded, referral, matching
  amount          Float
  date            DateTime
  projectName     String?
  communityName   String?
  receiptNumber   String    @unique
  downloadedAt    DateTime?
  createdAt       DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, date])
  @@index([receiptNumber])
}

model AnnualGivingSummary {
  id                    String    @id @default(cuid())
  userId                String
  year                  Int
  totalCashContributed  Float     @default(0)
  totalAdFunded         Float     @default(0)
  totalReferralCredits  Float     @default(0)
  totalMatchingReceived Float     @default(0)
  totalAllocated        Float     @default(0)
  projectsFunded        Int       @default(0)
  loansFunded           Int       @default(0)
  loansRepaid           Float     @default(0)
  communitiesSupported  Int       @default(0)
  deductibleAmount      Float     @default(0)
  nonDeductibleAmount   Float     @default(0)
  generatedAt           DateTime?
  pdfUrl                String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, year])
}

model FamilyAnnualSummary {
  id                String    @id @default(cuid())
  familyId          String
  year              Int
  totalFamilyGiving Float     @default(0)
  memberBreakdown   String    // JSON: { memberId: amount }
  projectsFunded    Int       @default(0)
  generatedAt       DateTime?
  pdfUrl            String?
  createdAt         DateTime  @default(now())

  @@unique([familyId, year])
}

// ==========================================
// PLAN 11: RECURRING GIVING & SUBSCRIPTIONS
// ==========================================

model RecurringContribution {
  id              String    @id @default(cuid())
  userId          String
  amount          Float     // Amount per charge
  frequency       String    @default("monthly") // monthly, weekly, biweekly
  nextChargeDate  DateTime
  lastChargeDate  DateTime?
  status          String    @default("active") // active, paused, cancelled
  paymentMethodId String?   // Stripe payment method ID
  failureCount    Int       @default(0)
  pausedUntil     DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  user    User                          @relation(fields: [userId], references: [id], onDelete: Cascade)
  history RecurringContributionHistory[]

  @@index([userId, status])
  @@index([nextChargeDate, status])
}

model RecurringContributionHistory {
  id                      String   @id @default(cuid())
  recurringContributionId String
  amount                  Float
  status                  String   // succeeded, failed, pending
  chargeDate              DateTime
  failureReason           String?
  contributionId          String?  // Reference to actual contribution created
  createdAt               DateTime @default(now())

  recurringContribution RecurringContribution @relation(fields: [recurringContributionId], references: [id], onDelete: Cascade)

  @@index([recurringContributionId, chargeDate])
}

model ProjectSubscription {
  id              String    @id @default(cuid())
  userId          String
  projectId       String
  amount          Float
  frequency       String    @default("monthly")
  nextChargeDate  DateTime
  lastChargeDate  DateTime?
  status          String    @default("active") // active, paused, cancelled, completed
  pausedUntil     DateTime?
  pauseReason     String?   // user_paused, project_funded, no_payment_method
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([userId, projectId])
  @@index([nextChargeDate, status])
}

model CommunitySubscription {
  id              String    @id @default(cuid())
  userId          String
  communityId     String
  amount          Float
  frequency       String    @default("monthly")
  allocationRule  String    @default("neediest") // newest, neediest, random
  nextChargeDate  DateTime
  lastChargeDate  DateTime?
  status          String    @default("active")
  pausedUntil     DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  community Community @relation(fields: [communityId], references: [id], onDelete: Cascade)

  @@unique([userId, communityId])
  @@index([nextChargeDate, status])
}

model PersonalGivingGoal {
  id            String   @id @default(cuid())
  userId        String
  targetAmount  Float
  currentAmount Float    @default(0)
  period        String   // monthly, quarterly, yearly
  periodStart   DateTime
  periodEnd     DateTime
  status        String   @default("active") // active, completed, expired
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, status])
  @@index([periodEnd, status])
}

// ==========================================
// PLAN 12: VOLUNTEER & IN-KIND CONTRIBUTIONS
// ==========================================

model VolunteerOpportunity {
  id              String    @id @default(cuid())
  projectId       String
  title           String
  description     String
  hoursNeeded     Float?    // Target hours (optional)
  hoursLogged     Float     @default(0)
  skillsRequired  String?   // JSON array: ["construction", "teaching", "admin"]
  location        String?
  isRemote        Boolean   @default(false)
  startDate       DateTime?
  endDate         DateTime?
  status          String    @default("open") // open, filled, closed
  maxVolunteers   Int?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  project  Project           @relation(fields: [projectId], references: [id], onDelete: Cascade)
  signups  VolunteerSignup[]
  logs     VolunteerLog[]

  @@index([projectId, status])
  @@index([status, startDate])
}

model VolunteerSignup {
  id            String   @id @default(cuid())
  opportunityId String
  userId        String
  status        String   @default("interested") // interested, confirmed, completed, cancelled
  message       String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  opportunity VolunteerOpportunity @relation(fields: [opportunityId], references: [id], onDelete: Cascade)
  user        User                 @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([opportunityId, userId])
}

model VolunteerLog {
  id            String    @id @default(cuid())
  opportunityId String
  userId        String
  hours         Float
  date          DateTime
  description   String?
  verified      Boolean   @default(false)
  verifiedBy    String?
  verifiedAt    DateTime?
  createdAt     DateTime  @default(now())

  opportunity VolunteerOpportunity @relation(fields: [opportunityId], references: [id], onDelete: Cascade)
  user        User                 @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, date])
  @@index([opportunityId])
}

model UserSkill {
  id          String   @id @default(cuid())
  userId      String
  skill       String
  category    String   // technical, professional, trade, education, administrative
  level       String   @default("intermediate") // beginner, intermediate, expert
  description String?
  isPublic    Boolean  @default(true)
  createdAt   DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, skill])
  @@index([skill])
  @@index([category])
}

model InKindDonation {
  id          String    @id @default(cuid())
  projectId   String
  userId      String
  type        String    // materials, equipment, space, services
  description String
  value       Float?    // Estimated value (optional)
  status      String    @default("offered") // offered, accepted, received, declined
  receivedAt  DateTime?
  notes       String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([projectId, status])
  @@index([userId])
}

model ProjectNeed {
  id             String   @id @default(cuid())
  projectId      String
  type           String   // materials, equipment, space, services, volunteer_hours
  description    String
  quantity       Int?
  estimatedValue Float?
  fulfilled      Boolean  @default(false)
  fulfilledBy    String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId, fulfilled])
}

// ==================== Corporate Portal ====================

model CorporateAccount {
  id                String    @id @default(cuid())
  name              String    // Company name
  slug              String    @unique
  logoUrl           String?
  primaryColor      String?   // Brand color hex
  secondaryColor    String?
  adminEmail        String
  tier              String    @default("starter") // starter, growth, enterprise
  employeeLimit     Int?
  matchingBudget    Float     @default(0)
  matchingSpent     Float     @default(0)
  matchingRatio     Float     @default(1) // 1:1, 2:1, etc.
  matchingCategories String?  // JSON array of categories, empty = all
  billingEmail      String?
  contractStart     DateTime?
  contractEnd       DateTime?
  status            String    @default("active") // active, suspended, expired
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  employees       CorporateEmployee[]
  invites         CorporateInvite[]
  campaigns       CorporateCampaign[]
  reports         CorporateReport[]
  matchingHistory CorporateMatchingRecord[]

  @@index([status])
}

model CorporateEmployee {
  id                 String   @id @default(cuid())
  corporateAccountId String
  userId             String   @unique
  employeeId         String?  // Internal employee ID (optional)
  department         String?
  isAdmin            Boolean  @default(false)
  joinedAt           DateTime @default(now())
  status             String   @default("active") // active, inactive

  corporateAccount CorporateAccount @relation(fields: [corporateAccountId], references: [id], onDelete: Cascade)
  user             User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([corporateAccountId, employeeId])
  @@index([corporateAccountId, status])
}

model CorporateInvite {
  id                 String    @id @default(cuid())
  corporateAccountId String
  email              String
  token              String    @unique
  expiresAt          DateTime
  usedAt             DateTime?
  usedBy             String?
  createdAt          DateTime  @default(now())

  corporateAccount CorporateAccount @relation(fields: [corporateAccountId], references: [id], onDelete: Cascade)

  @@index([corporateAccountId])
  @@index([token])
}

model CorporateMatchingRecord {
  id                 String   @id @default(cuid())
  corporateAccountId String
  userId             String
  originalAmount     Float
  matchedAmount      Float
  projectId          String?
  loanId             String?
  category           String?
  matchDate          DateTime @default(now())

  corporateAccount CorporateAccount @relation(fields: [corporateAccountId], references: [id], onDelete: Cascade)

  @@index([corporateAccountId, matchDate])
  @@index([userId])
}

model CorporateCampaign {
  id                 String   @id @default(cuid())
  corporateAccountId String
  name               String
  description        String?
  startDate          DateTime
  endDate            DateTime
  targetAmount       Float?
  currentAmount      Float    @default(0)
  matchingBonus      Float?   // Extra matching during campaign
  featuredProjects   String?  // JSON array of project IDs
  categories         String?  // JSON array of focus categories
  status             String   @default("draft") // draft, active, completed
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  corporateAccount CorporateAccount @relation(fields: [corporateAccountId], references: [id], onDelete: Cascade)

  @@index([corporateAccountId, status])
  @@index([status, startDate])
}

model CorporateReport {
  id                 String   @id @default(cuid())
  corporateAccountId String
  type               String   // monthly, quarterly, annual, custom
  startDate          DateTime
  endDate            DateTime
  data               String   // JSON aggregated metrics
  pdfUrl             String?
  generatedAt        DateTime @default(now())

  corporateAccount CorporateAccount @relation(fields: [corporateAccountId], references: [id], onDelete: Cascade)

  @@index([corporateAccountId, type])
}

// ============================================================================
// GIVING CIRCLES
// ============================================================================

model GivingCircle {
  id               String   @id @default(cuid())
  name             String
  slug             String   @unique
  description      String?
  imageUrl         String?
  isPrivate        Boolean  @default(false)
  memberLimit      Int?     // null = unlimited
  minContribution  Float?   // Monthly minimum (optional)
  pooledBalance    Float    @default(0)
  totalContributed Float    @default(0)
  totalDeployed    Float    @default(0)
  votingThreshold  Float    @default(0.5) // % needed to approve
  votingPeriod     Int      @default(7) // days
  focusCategories  String?  // JSON array of preferred categories
  focusCommunities String?  // JSON array of preferred community IDs
  status           String   @default("active") // active, paused, archived
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  members       CircleMember[]
  contributions CircleContribution[]
  proposals     CircleProposal[]
  activity      CircleActivity[]
  invites       CircleInvite[]
  discussions   CircleDiscussion[]
  recurring     CircleRecurring[]

  @@index([status])
}

model CircleMember {
  id               String   @id @default(cuid())
  circleId         String
  userId           String
  role             String   @default("member") // founder, admin, member
  totalContributed Float    @default(0)
  joinedAt         DateTime @default(now())
  status           String   @default("active") // active, inactive, left

  circle GivingCircle @relation(fields: [circleId], references: [id], onDelete: Cascade)
  user   User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([circleId, userId])
  @@index([userId])
}

model CircleContribution {
  id        String   @id @default(cuid())
  circleId  String
  userId    String
  amount    Float
  note      String?
  createdAt DateTime @default(now())

  circle GivingCircle @relation(fields: [circleId], references: [id], onDelete: Cascade)

  @@index([circleId, createdAt])
  @@index([userId])
}

model CircleInvite {
  id        String    @id @default(cuid())
  circleId  String
  email     String?
  token     String    @unique
  invitedBy String
  expiresAt DateTime
  usedAt    DateTime?
  usedBy    String?
  createdAt DateTime  @default(now())

  circle GivingCircle @relation(fields: [circleId], references: [id], onDelete: Cascade)

  @@index([circleId])
  @@index([token])
}

model CircleProposal {
  id           String    @id @default(cuid())
  circleId     String
  proposerId   String
  projectId    String?   // For project funding
  loanId       String?   // For loan funding
  type         String    // project, loan, custom
  title        String
  description  String?
  amount       Float
  votingEnds   DateTime
  status       String    @default("voting") // voting, approved, rejected, funded, expired
  yesVotes     Int       @default(0)
  noVotes      Int       @default(0)
  abstainVotes Int       @default(0)
  fundedAt     DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  circle GivingCircle @relation(fields: [circleId], references: [id], onDelete: Cascade)
  votes  CircleVote[]

  @@index([circleId, status])
  @@index([votingEnds])
}

model CircleVote {
  id         String   @id @default(cuid())
  proposalId String
  userId     String
  vote       String   // yes, no, abstain
  comment    String?
  createdAt  DateTime @default(now())

  proposal CircleProposal @relation(fields: [proposalId], references: [id], onDelete: Cascade)

  @@unique([proposalId, userId])
}

model CircleActivity {
  id        String   @id @default(cuid())
  circleId  String
  type      String   // contribution, proposal_created, vote_cast, proposal_funded, member_joined, member_left, discussion
  actorId   String?
  data      String   // JSON data
  createdAt DateTime @default(now())

  circle GivingCircle @relation(fields: [circleId], references: [id], onDelete: Cascade)

  @@index([circleId, createdAt])
}

model CircleDiscussion {
  id        String   @id @default(cuid())
  circleId  String
  userId    String
  content   String
  parentId  String?  // For threading
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  circle GivingCircle @relation(fields: [circleId], references: [id], onDelete: Cascade)

  @@index([circleId, createdAt])
  @@index([parentId])
}

model CircleRecurring {
  id             String   @id @default(cuid())
  circleId       String
  userId         String
  amount         Float
  frequency      String   @default("monthly")
  nextChargeDate DateTime
  status         String   @default("active") // active, paused, cancelled
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  circle GivingCircle @relation(fields: [circleId], references: [id], onDelete: Cascade)

  @@unique([circleId, userId])
  @@index([nextChargeDate, status])
}

// ============================================
// Plan 15: Seasonal & Event-Driven Giving
// ============================================

model GivingOccasion {
  id              String   @id @default(cuid())
  name            String
  slug            String   @unique
  type            String   // holiday, awareness, disaster, personal, local
  description     String?
  startDate       DateTime
  endDate         DateTime
  imageUrl        String?
  iconName        String?  // Lucide icon name
  color           String?  // Theme color
  isRecurring     Boolean  @default(false)
  recurrenceRule  String?  // iCal RRULE for annual events
  matchingBonus   Float?   // Extra matching during occasion
  featuredProjects String? // Comma-separated project IDs
  categories      String?  // Comma-separated categories
  isGlobal        Boolean  @default(true) // vs community-specific
  communityId     String?  // For local occasions
  status          String   @default("active") // draft, active, completed
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  scheduledGifts ScheduledGift[]

  @@index([status, startDate])
  @@index([type])
}

model GiftContribution {
  id               String    @id @default(cuid())
  contributorId    String
  recipientName    String
  recipientEmail   String?
  occasionType     String    // birthday, memorial, celebration, thank_you, holiday
  message          String?
  amount           Float
  projectId        String?
  communityId      String?
  isAnonymous      Boolean   @default(false)
  notificationSent Boolean   @default(false)
  notificationDate DateTime?
  certificateUrl   String?
  createdAt        DateTime  @default(now())

  contributor User @relation(fields: [contributorId], references: [id], onDelete: Cascade)

  @@index([contributorId])
  @@index([notificationDate])
}

model BirthdayFundraiser {
  id            String   @id @default(cuid())
  userId        String
  projectId     String?
  communityId   String?
  title         String
  description   String
  birthdayDate  DateTime
  goalAmount    Float
  currentAmount Float    @default(0)
  backerCount   Int      @default(0)
  status        String   @default("active") // active, completed, cancelled
  shareUrl      String   @unique
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  project Project? @relation(fields: [projectId], references: [id])

  @@index([userId])
  @@index([birthdayDate])
  @@index([shareUrl])
  @@index([status])
}

model EmergencyCampaign {
  id              String    @id @default(cuid())
  title           String
  slug            String    @unique
  description     String
  type            String    // natural_disaster, crisis, emergency, humanitarian
  location        String?
  affectedArea    String?   // GeoJSON as string
  startDate       DateTime  @default(now())
  endDate         DateTime?
  targetAmount    Float?
  currentAmount   Float     @default(0)
  backerCount     Int       @default(0)
  verifiedOrgs    String?   // Comma-separated organization IDs
  status          String    @default("active") // active, resolved, closed
  updateFrequency String    @default("daily") // How often updates are posted
  priority        Int       @default(0) // For ordering (higher = more urgent)
  createdBy       String    // Admin who created
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  updates EmergencyUpdate[]

  @@index([status])
  @@index([priority])
}

model EmergencyUpdate {
  id         String   @id @default(cuid())
  campaignId String
  title      String
  content    String
  authorId   String
  createdAt  DateTime @default(now())

  campaign EmergencyCampaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@index([campaignId, createdAt])
}

model ScheduledGift {
  id             String    @id @default(cuid())
  userId         String
  occasionId     String?   // Link to GivingOccasion
  customOccasion String?   // User-defined occasion
  scheduledDate  DateTime
  amount         Float
  projectId      String?
  communityId    String?
  recipientName  String?   // For gift contributions
  recipientEmail String?
  message        String?
  status         String    @default("scheduled") // scheduled, completed, skipped, failed
  completedAt    DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  user     User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  occasion GivingOccasion? @relation(fields: [occasionId], references: [id], onDelete: SetNull)

  @@index([userId, scheduledDate])
  @@index([scheduledDate, status])
}

model SeasonalCampaign {
  id               String   @id @default(cuid())
  name             String
  slug             String   @unique
  tagline          String?
  description      String
  startDate        DateTime
  endDate          DateTime
  platformGoal     Float?
  platformProgress Float    @default(0)
  matchingPartner  String?
  matchingRatio    Float?
  heroImageUrl     String?
  themeColor       String?
  featuredProjects String?  // Comma-separated project IDs
  badges           String?  // Comma-separated badge keys for this campaign
  status           String   @default("draft") // draft, active, completed
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([status, startDate])
}

// ==========================================
// Credit Bureau Reporting (Plan 16)
// ==========================================

model CreditReportingConsent {
  id              String    @id @default(cuid())
  userId          String
  loanId          String    @unique
  consentGiven    Boolean
  consentDate     DateTime
  consentVersion  String    // Version of consent form
  ipAddress       String?
  userAgent       String?
  withdrawnAt     DateTime?
  withdrawnReason String?
  createdAt       DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  loan Loan @relation(fields: [loanId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model CreditReportingStatus {
  id              String    @id @default(cuid())
  loanId          String    @unique
  isReporting     Boolean   @default(false)
  bureaus         String?   // Comma-separated: experian,transunion,equifax
  firstReportDate DateTime?
  lastReportDate  DateTime?
  reportingErrors String?   // JSON string for errors
  status          String    @default("pending") // pending, active, completed, error
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  loan Loan @relation(fields: [loanId], references: [id], onDelete: Cascade)
}

model Metro2Record {
  id              String    @id @default(cuid())
  loanId          String
  recordType      String    // header, base, trailer
  reportingPeriod DateTime
  accountStatus   String    // 11=current, 71=30days, 78=60days, etc.
  paymentHistory  String    // 24-month payment pattern
  currentBalance  Float
  amountPastDue   Float     @default(0)
  dateOpened      DateTime
  scheduledPayment Float
  actualPayment   Float?
  rawData         String    // The formatted Metro 2 record
  submitted       Boolean   @default(false)
  submittedAt     DateTime?
  accepted        Boolean?
  rejectionReason String?
  createdAt       DateTime  @default(now())

  loan Loan @relation(fields: [loanId], references: [id], onDelete: Cascade)

  @@index([loanId, reportingPeriod])
  @@index([submitted, reportingPeriod])
}

model BureauConnection {
  id              String    @id @default(cuid())
  bureau          String    @unique // experian, transunion, equifax
  furnisherId     String    // Deluge's furnisher ID with this bureau
  apiEndpoint     String
  apiKeyEncrypted String    // Encrypted API credentials
  status          String    @default("pending") // pending, active, suspended
  lastSubmission  DateTime?
  lastSuccess     DateTime?
  lastError       String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

model BureauSubmission {
  id              String    @id @default(cuid())
  bureau          String
  reportingPeriod DateTime
  recordCount     Int
  fileReference   String    // Submission file ID
  status          String    @default("pending") // pending, submitted, accepted, rejected
  submittedAt     DateTime?
  responseAt      DateTime?
  acceptedCount   Int?
  rejectedCount   Int?
  errorDetails    String?   // JSON string for error details
  createdAt       DateTime  @default(now())

  @@index([bureau, reportingPeriod])
  @@index([status])
}

model CreditDispute {
  id               String    @id @default(cuid())
  loanId           String
  userId           String
  disputeType      String    // balance, payment_history, account_status, identity
  description      String
  evidence         String?   // JSON string for uploaded documents
  status           String    @default("open") // open, investigating, resolved, escalated
  resolution       String?
  resolvedAt       DateTime?
  resolvedBy       String?
  bureauNotified   Boolean   @default(false)
  bureauNotifiedAt DateTime?
  dueDate          DateTime  // 30 days from creation
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  loan  Loan               @relation(fields: [loanId], references: [id], onDelete: Cascade)
  user  User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  notes CreditDisputeNote[]

  @@index([status, dueDate])
  @@index([loanId])
  @@index([userId])
}

model CreditDisputeNote {
  id         String   @id @default(cuid())
  disputeId  String
  authorId   String
  content    String
  isInternal Boolean  @default(true)
  createdAt  DateTime @default(now())

  dispute CreditDispute @relation(fields: [disputeId], references: [id], onDelete: Cascade)

  @@index([disputeId])
}

// ============================================================================
// COMMUNITY ADVOCATES
// Natural leaders who help others - no tiers, points, or gamification
// ============================================================================

model CommunityAdvocate {
  id            String   @id @default(cuid())
  userId        String   @unique
  status        String   @default("active") // active, paused, alumni
  region        String?  // Geographic focus
  communityIds  String?  // Comma-separated community IDs they support
  interests     String?  // Comma-separated areas (events, onboarding, content)
  bio           String?
  publicProfile Boolean  @default(true)
  joinedAt      DateTime @default(now())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user       User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  activities AdvocateActivity[]
  events     AdvocateEvent[]

  @@index([status])
  @@index([region])
}

model AdvocateInterest {
  id           String    @id @default(cuid())
  userId       String    @unique
  motivation   String    // Why they want to help
  interests    String?   // Comma-separated interests
  availability String?   // General availability
  region       String?
  status       String    @default("pending") // pending, welcomed, declined
  welcomedBy   String?
  welcomedAt   DateTime?
  createdAt    DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([status])
}

model AdvocateActivity {
  id          String   @id @default(cuid())
  advocateId  String
  type        String   // welcome, event, content, support, outreach
  description String
  communityId String?  // Which community this was for
  createdAt   DateTime @default(now())

  advocate CommunityAdvocate @relation(fields: [advocateId], references: [id], onDelete: Cascade)

  @@index([advocateId, type])
  @@index([createdAt])
}

model AdvocateEvent {
  id          String    @id @default(cuid())
  advocateId  String
  communityId String?
  title       String
  description String
  type        String    // meetup, workshop, welcome_session, info_session
  date        DateTime
  endDate     DateTime?
  location    String?
  isVirtual   Boolean   @default(false)
  virtualLink String?
  recap       String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  advocate CommunityAdvocate   @relation(fields: [advocateId], references: [id], onDelete: Cascade)
  rsvps    AdvocateEventRSVP[]

  @@index([advocateId, date])
  @@index([communityId, date])
  @@index([date])
}

model AdvocateEventRSVP {
  id        String   @id @default(cuid())
  eventId   String
  userId    String?
  email     String?  // For non-users
  name      String?
  attended  Boolean  @default(false)
  createdAt DateTime @default(now())

  event AdvocateEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@unique([eventId, userId])
  @@index([eventId])
}

model AdvocateResource {
  id          String   @id @default(cuid())
  title       String
  description String?
  type        String   // presentation, flyer, video, guide, template
  category    String   // welcome, events, outreach
  fileUrl     String?
  content     String?  // For text-based resources
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([category, type])
}

model AdvocateAppreciation {
  id          String   @id @default(cuid())
  advocateId  String
  type        String   // thank_you, highlight, invite, swag
  message     String?
  sentBy      String   // Admin who sent it
  sentAt      DateTime @default(now())

  @@index([advocateId])
}

// =============================================================================
// Project Verification & Auditing (Plan 18)
// =============================================================================

model ProjectVerification {
  id                   String    @id @default(cuid())
  projectId            String    @unique
  level                String    @default("unverified") // unverified, basic, verified, audited
  organizationVerified Boolean   @default(false)
  documentsVerified    Boolean   @default(false)
  outcomeVerified      Boolean   @default(false)
  trustScore           Float?    // Calculated trust score 0-100
  lastVerifiedAt       DateTime?
  lastVerifiedBy       String?
  expiresAt            DateTime?
  notes                String?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  project Project             @relation(fields: [projectId], references: [id], onDelete: Cascade)
  checks  VerificationCheck[]
  audits  ProjectAudit[]
}

model VerificationCheck {
  id             String    @id @default(cuid())
  verificationId String
  checkType      String    // identity, documents, location, organization, outcome
  status         String    @default("pending") // pending, passed, failed, expired
  evidence       String?   // JSON string of submitted evidence
  reviewedBy     String?
  reviewedAt     DateTime?
  reviewNotes    String?
  expiresAt      DateTime?
  createdAt      DateTime  @default(now())

  verification ProjectVerification @relation(fields: [verificationId], references: [id], onDelete: Cascade)

  @@index([verificationId, checkType])
  @@index([status])
}

model IdentityVerification {
  id              String    @id @default(cuid())
  userId          String
  type            String    // personal, business
  status          String    @default("pending") // pending, verified, rejected, expired
  provider        String?   // stripe_identity, manual
  providerRef     String?   // External verification ID
  documentType    String?   // drivers_license, passport, ein
  verifiedName    String?
  verifiedAddress String?
  verifiedAt      DateTime?
  expiresAt       DateTime?
  rejectionReason String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, status])
}

model OrganizationVerification {
  id                  String    @id @default(cuid())
  projectId           String?
  businessId          String?   // For business directory
  organizationName    String
  ein                 String?
  registrationNumber  String?
  registrationType    String?   // 501c3, 501c4, government, llc
  verificationStatus  String    @default("pending") // pending, verified, rejected, expired
  verifiedAt          DateTime?
  verifiedBy          String?
  documents           String?   // JSON string of document URLs
  notes               String?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  @@index([ein])
  @@index([verificationStatus])
  @@index([projectId])
}

model OutcomeVerification {
  id                  String    @id @default(cuid())
  projectId           String
  outcomeType         String    // completion, impact_metric, milestone
  description         String
  targetValue         Float?
  actualValue         Float?
  evidence            String?   // JSON string of evidence (photos, receipts, documents)
  status              String    @default("pending") // pending, verified, disputed, unverified
  verifiedBy          String?
  verifiedAt          DateTime?
  verificationMethod  String?   // self_reported, community, third_party
  notes               String?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  project              Project                 @relation(fields: [projectId], references: [id], onDelete: Cascade)
  communityVerifications CommunityVerification[]

  @@index([projectId, status])
}

model CommunityVerification {
  id           String   @id @default(cuid())
  outcomeId    String
  userId       String
  relationship String   // beneficiary, witness, neighbor, volunteer
  verification String   // confirmed, disputed
  comment      String?
  evidence     String?  // JSON string of evidence
  createdAt    DateTime @default(now())

  outcome OutcomeVerification @relation(fields: [outcomeId], references: [id], onDelete: Cascade)

  @@unique([outcomeId, userId])
  @@index([outcomeId])
}

model ProjectAudit {
  id             String    @id @default(cuid())
  verificationId String
  auditorId      String    // User who conducted audit
  auditorOrg     String?   // Auditing organization
  auditType      String    // financial, impact, compliance
  scope          String    // What was audited
  findings       String?   // JSON string of audit findings
  rating         String?   // pass, conditional, fail
  reportUrl      String?
  startDate      DateTime
  completedDate  DateTime?
  status         String    @default("scheduled") // scheduled, in_progress, completed, cancelled
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  verification ProjectVerification @relation(fields: [verificationId], references: [id], onDelete: Cascade)

  @@index([verificationId])
  @@index([status])
}

model Auditor {
  id              String    @id @default(cuid())
  userId          String    @unique
  organization    String
  credentials     String    // Comma-separated credentials
  specialties     String    // Comma-separated specialties/categories
  status          String    @default("pending") // pending, approved, suspended
  approvedAt      DateTime?
  approvedBy      String?
  auditsCompleted Int       @default(0)
  averageRating   Float?
  bio             String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([status])
}

model ProjectFlag {
  id          String    @id @default(cuid())
  projectId   String
  type        String    // duplicate, suspicious_funding, unresponsive, misuse, fraud
  severity    String    // low, medium, high, critical
  description String
  evidence    String?   // JSON string of evidence
  status      String    @default("open") // open, investigating, resolved, dismissed
  reportedBy  String?   // User ID or "system"
  assignedTo  String?   // Admin investigating
  resolvedBy  String?
  resolvedAt  DateTime?
  resolution  String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId, status])
  @@index([severity, status])
  @@index([type])
}

// =============================================================================
// Developer API & Integrations (Plan 19)
// =============================================================================

model ApiKey {
  id           String    @id @default(cuid())
  userId       String
  name         String
  keyHash      String    @unique // Hashed key for lookup
  keyPrefix    String    // First 8 chars for identification
  scopes       String    // Comma-separated: read, write, webhooks
  rateLimit    Int       @default(1000) // Requests per hour
  status       String    @default("active") // active, revoked, expired
  lastUsedAt   DateTime?
  usageCount   Int       @default(0)
  expiresAt    DateTime?
  createdAt    DateTime  @default(now())
  revokedAt    DateTime?
  revokedReason String?

  user User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  logs ApiRequestLog[]

  @@index([keyHash])
  @@index([userId, status])
}

model ApiRequestLog {
  id           String   @id @default(cuid())
  apiKeyId     String
  endpoint     String
  method       String
  statusCode   Int
  responseTime Int      // ms
  ipAddress    String?
  userAgent    String?
  createdAt    DateTime @default(now())

  apiKey ApiKey @relation(fields: [apiKeyId], references: [id], onDelete: Cascade)

  @@index([apiKeyId, createdAt])
  @@index([endpoint, createdAt])
}

model Webhook {
  id              String    @id @default(cuid())
  userId          String
  name            String
  url             String
  secret          String    // For signature verification
  events          String    // Comma-separated: project.funded, loan.repaid, etc.
  status          String    @default("active") // active, paused, failed
  failureCount    Int       @default(0)
  lastTriggeredAt DateTime?
  lastSuccessAt   DateTime?
  lastErrorAt     DateTime?
  lastError       String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  user       User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  deliveries WebhookDelivery[]

  @@index([userId, status])
}

model WebhookDelivery {
  id           String    @id @default(cuid())
  webhookId    String
  event        String
  payload      String    // JSON string
  statusCode   Int?
  responseBody String?
  duration     Int?      // ms
  status       String    @default("pending") // pending, delivered, failed
  attempts     Int       @default(0)
  nextRetry    DateTime?
  createdAt    DateTime  @default(now())

  webhook Webhook @relation(fields: [webhookId], references: [id], onDelete: Cascade)

  @@index([webhookId, createdAt])
  @@index([status, nextRetry])
}

model OAuthApp {
  id               String    @id @default(cuid())
  userId           String    // App owner
  name             String
  description      String?
  logoUrl          String?
  websiteUrl       String?
  redirectUris     String    // Comma-separated URIs
  clientId         String    @unique
  clientSecretHash String
  scopes           String    // Comma-separated allowed scopes
  status           String    @default("pending") // pending, approved, suspended
  approvedAt       DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  user           User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  authorizations OAuthAuthorization[]

  @@index([clientId])
}

model OAuthAuthorization {
  id                    String    @id @default(cuid())
  appId                 String
  userId                String
  scopes                String    // Comma-separated granted scopes
  // Authorization code (temporary, before token exchange)
  authCode              String?   @unique
  codeExpiresAt         DateTime?
  // Tokens (hashed for security)
  accessToken           String?   @unique
  accessTokenExpiresAt  DateTime?
  refreshToken          String?   @unique
  refreshTokenExpiresAt DateTime?
  revokedAt             DateTime?
  createdAt             DateTime  @default(now())

  app  OAuthApp @relation(fields: [appId], references: [id], onDelete: Cascade)
  user User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([accessToken])
  @@index([authCode])
  @@index([userId, appId])
}

// ============================================================================
// Plan 20: Smart Discovery & Recommendations
// ============================================================================

model UserInterestProfile {
  id            String   @id @default(cuid())
  userId        String   @unique
  categories    String   @default("{}") // JSON: { "education": 0.8, "environment": 0.6 }
  communities   String   @default("{}") // JSON: { "community_id": weight }
  projectTypes  String   @default("{}") // JSON: { "infrastructure": 0.7 }
  givingPatterns String  @default("{}") // JSON: { "avg_amount": 25, "frequency": "weekly" }
  locationPrefs String   @default("{}") // JSON: { "radius_miles": 50, "include_remote": true }
  timePrefs     String   @default("{}") // JSON: { "prefer_urgent": true }
  lastUpdated   DateTime @default(now())
  createdAt     DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model UserInteraction {
  id         String   @id @default(cuid())
  userId     String
  entityType String   // project, community, loan, business
  entityId   String
  action     String   // view, fund, follow, share, save, dismiss
  weight     Float    @default(1) // Interaction strength
  context    String?  // JSON: { "source": "feed", "duration_sec": 45 }
  createdAt  DateTime @default(now())

  @@index([userId, entityType, createdAt])
  @@index([entityId, action])
}

model UserSimilarity {
  id            String   @id @default(cuid())
  userId        String
  similarUserId String
  score         Float    // 0-1 similarity score
  basis         String   // funding, following, category
  calculatedAt  DateTime @default(now())

  @@unique([userId, similarUserId, basis])
  @@index([userId, score])
}

model ProjectSimilarity {
  id               String   @id @default(cuid())
  projectId        String
  similarProjectId String
  score            Float
  basis            String   // category, community, backers
  calculatedAt     DateTime @default(now())

  @@unique([projectId, similarProjectId])
  @@index([projectId, score])
}

model Recommendation {
  id         String    @id @default(cuid())
  userId     String
  entityType String    // project, community, loan
  entityId   String
  score      Float
  reason     String    // "similar_to_funded", "trending_in_area", etc.
  signals    String    // JSON: Contributing signals and weights
  shown      Boolean   @default(false)
  shownAt    DateTime?
  clicked    Boolean   @default(false)
  clickedAt  DateTime?
  converted  Boolean   @default(false) // Funded/joined
  expiresAt  DateTime
  createdAt  DateTime  @default(now())

  @@unique([userId, entityType, entityId])
  @@index([userId, entityType, score])
  @@index([expiresAt])
}

model MatchScore {
  id           String   @id @default(cuid())
  userId       String
  projectId    String
  score        Float    // 0-1 match quality
  breakdown    String   // JSON: { "category": 0.8, "location": 0.7, "history": 0.9 }
  calculatedAt DateTime @default(now())
  expiresAt    DateTime

  @@unique([userId, projectId])
  @@index([userId, score])
  @@index([projectId, score])
}

model DigestPreferences {
  id               String    @id @default(cuid())
  userId           String    @unique
  frequency        String    @default("weekly") // never, weekly, monthly
  dayOfWeek        Int?      // 0-6 for weekly
  categories       String    @default("[]") // JSON array of focus categories
  includeLoans     Boolean   @default(true)
  includeVolunteer Boolean   @default(true)
  lastSent         DateTime?
  nextSend         DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model DiscoveryChallenge {
  id           String    @id @default(cuid())
  userId       String
  type         String    // explore_categories, fund_new_community, etc.
  target       Int
  progress     Int       @default(0)
  reward       String    // badge, watershed_credit
  rewardAmount Float?
  status       String    @default("active") // active, completed, expired
  expiresAt    DateTime
  completedAt  DateTime?
  createdAt    DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, status])
}

model RecommendationMetrics {
  id          String   @id @default(cuid())
  date        DateTime
  algorithm   String   // collaborative, content, hybrid
  entityType  String
  impressions Int      @default(0)
  clicks      Int      @default(0)
  conversions Int      @default(0)
  avgPosition Float?
  avgScore    Float?
  createdAt   DateTime @default(now())

  @@unique([date, algorithm, entityType])
  @@index([date])
}

// ============================================================================
// Plan 21: Learning Resources & Financial Literacy
// ============================================================================

model LearningResource {
  id               String   @id @default(cuid())
  title            String
  slug             String   @unique
  description      String
  content          String   // JSON rich content blocks
  category         String   // giving, financial, impact, community
  format           String   // article, video, guide, tool, worksheet
  estimatedMinutes Int?
  imageUrl         String?
  isPublished      Boolean  @default(false)
  order            Int      @default(0)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  discussions LearningDiscussion[]

  @@index([category, isPublished])
}

model GivingPlan {
  id            String   @id @default(cuid())
  userId        String   @unique
  monthlyTarget Float?
  yearlyTarget  Float?
  method        String   @default("flexible") // percentage, fixed, flexible
  notes         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model ReflectionEntry {
  id        String   @id @default(cuid())
  userId    String
  prompt    String
  response  String
  isPrivate Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
}

model GivingScenario {
  id             String   @id @default(cuid())
  title          String
  scenario       String   // The situation to consider
  options        String   // JSON - possible approaches
  considerations String   // JSON - things to think about
  category       String
  createdAt      DateTime @default(now())

  @@index([category])
}

model LearningDiscussion {
  id         String   @id @default(cuid())
  resourceId String?
  topic      String
  content    String
  authorId   String
  isPinned   Boolean  @default(false)
  replyCount Int      @default(0)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  resource LearningResource?  @relation(fields: [resourceId], references: [id], onDelete: SetNull)
  replies  LearningReply[]

  @@index([resourceId, createdAt])
}

model LearningReply {
  id           String   @id @default(cuid())
  discussionId String
  content      String
  authorId     String
  createdAt    DateTime @default(now())

  discussion LearningDiscussion @relation(fields: [discussionId], references: [id], onDelete: Cascade)

  @@index([discussionId, createdAt])
}

model StudyCircle {
  id            String   @id @default(cuid())
  name          String
  description   String?
  topic         String?
  facilitatorId String
  isPrivate     Boolean  @default(false)
  maxMembers    Int      @default(12)
  createdAt     DateTime @default(now())

  members StudyCircleMember[]

  @@index([topic])
}

model StudyCircleMember {
  id       String   @id @default(cuid())
  circleId String
  userId   String
  joinedAt DateTime @default(now())

  circle StudyCircle @relation(fields: [circleId], references: [id], onDelete: Cascade)

  @@unique([circleId, userId])
}

model LearningCertificate {
  id             String   @id @default(cuid())
  userId         String
  topic          String   // "Effective Giving Fundamentals"
  issuedAt       DateTime @default(now())
  certificateUrl String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// ============================================================================
// Plan 22: Institutional Partnerships
// ============================================================================

model Institution {
  id             String    @id @default(cuid())
  name           String
  slug           String    @unique // subdomain: boise.deluge.fund
  type           String    // city, university, foundation, nonprofit, corporate
  description    String?
  logoUrl        String?
  faviconUrl     String?
  primaryColor   String    @default("#0D47A1")
  secondaryColor String    @default("#00897B")
  customDomain   String?   @unique // e.g., give.boise.gov
  adminEmail     String
  tier           String    @default("standard") // standard, premium, enterprise
  features       String    @default("[]") // JSON array of enabled features
  limits         String    @default("{}") // JSON { "projects": 100, "users": 5000 }
  contractStart  DateTime
  contractEnd    DateTime?
  monthlyFee     Float?
  status         String    @default("active") // pending, active, suspended, expired
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  admins       InstitutionAdmin[]
  pages        InstitutionPage[]
  reports      InstitutionReport[]
  settings     InstitutionSettings?
  ssoConfig    InstitutionSSO?
  universitySettings UniversitySettings?
  citySettings       CitySettings?
  foundationSettings FoundationSettings?

  @@index([status])
  @@index([customDomain])
}

model InstitutionAdmin {
  id            String   @id @default(cuid())
  institutionId String
  userId        String
  role          String   @default("admin") // owner, admin, editor, viewer
  permissions   String   @default("[]") // JSON array
  invitedBy     String?
  createdAt     DateTime @default(now())

  institution Institution @relation(fields: [institutionId], references: [id], onDelete: Cascade)
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([institutionId, userId])
  @@index([userId])
}

model InstitutionSettings {
  id                 String   @id @default(cuid())
  institutionId      String   @unique
  allowPublicProjects Boolean @default(true)
  requireApproval    Boolean  @default(true)
  enableLoans        Boolean  @default(true)
  enableCommunities  Boolean  @default(true)
  customCategories   String   @default("[]") // JSON array
  defaultWatershed   Float    @default(0) // Seed amount for new users
  emailFromName      String?
  emailReplyTo       String?
  socialLinks        String?  // JSON
  customFooter       String?
  customCss          String?
  analyticsId        String?  // Google Analytics, etc.
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  institution Institution @relation(fields: [institutionId], references: [id], onDelete: Cascade)
}

model InstitutionPage {
  id            String   @id @default(cuid())
  institutionId String
  slug          String
  title         String
  content       String   // JSON rich content blocks
  isPublished   Boolean  @default(false)
  order         Int      @default(0)
  showInNav     Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  institution Institution @relation(fields: [institutionId], references: [id], onDelete: Cascade)

  @@unique([institutionId, slug])
  @@index([institutionId, isPublished])
}

model InstitutionReport {
  id            String   @id @default(cuid())
  institutionId String
  type          String   // monthly, quarterly, annual, custom
  period        String   // "2024-Q1", "2024-01", etc.
  data          String   // JSON aggregated metrics
  pdfUrl        String?
  generatedAt   DateTime @default(now())

  institution Institution @relation(fields: [institutionId], references: [id], onDelete: Cascade)

  @@unique([institutionId, type, period])
  @@index([institutionId])
}

model InstitutionSSO {
  id            String   @id @default(cuid())
  institutionId String   @unique
  provider      String   // saml, oidc, google, microsoft
  config        String   // JSON provider-specific config
  entityId      String?
  metadataUrl   String?
  isEnabled     Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  institution Institution @relation(fields: [institutionId], references: [id], onDelete: Cascade)
}

model UniversitySettings {
  id                  String   @id @default(cuid())
  institutionId       String   @unique
  alumniAccess        Boolean  @default(true)
  studentVerification Boolean  @default(false)
  departmentCodes     String   @default("[]") // JSON array
  graduationYears     String   @default("{}") // JSON active graduation years
  greekLife           Boolean  @default(false)
  athletics           Boolean  @default(false)

  institution Institution @relation(fields: [institutionId], references: [id], onDelete: Cascade)
}

model CitySettings {
  id                String   @id @default(cuid())
  institutionId     String   @unique
  neighborhoods     String   @default("[]") // JSON array
  councilDistricts  String   @default("{}") // JSON district boundaries
  budgetIntegration Boolean  @default(false)
  publicMeetings    Boolean  @default(false)

  institution Institution @relation(fields: [institutionId], references: [id], onDelete: Cascade)
}

model FoundationSettings {
  id                  String   @id @default(cuid())
  institutionId       String   @unique
  grantCycles         String   @default("[]") // JSON grant cycle configurations
  fundTypes           String   @default("[]") // JSON: DAF, scholarship, project, general
  minimumGrant        Float    @default(1000)
  requiresApplication Boolean  @default(true)
  reviewProcess       String   @default("committee") // staff, committee, board

  institution Institution @relation(fields: [institutionId], references: [id], onDelete: Cascade)
}

// ============================================================================
// Plan 23: Mentorship & Community Support
// ============================================================================

model Mentor {
  id              String   @id @default(cuid())
  userId          String   @unique
  bio             String
  expertise       String   // JSON array: giving, loans, community, financial
  availability    String   // hours per month
  maxMentees      Int      @default(3)
  currentMentees  Int      @default(0)
  preferredStyle  String   // async, scheduled, casual
  languages       String   @default("[\"en\"]") // JSON array
  timezone        String?
  isAccepting     Boolean  @default(true)
  applicationDate DateTime
  approvedDate    DateTime?
  approvedBy      String?
  status          String   @default("pending") // pending, active, paused, retired
  totalMentees    Int      @default(0)
  avgRating       Float?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user        User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  mentorships Mentorship[]
  sessions    MentorSession[]
  reviews     MentorReview[]

  @@index([status, isAccepting])
}

model Mentee {
  id              String   @id @default(cuid())
  userId          String   @unique
  goals           String   // JSON array: learn_giving, build_budget, understand_loans
  challenges      String?
  preferredStyle  String   @default("any")
  timezone        String?
  status          String   @default("seeking") // seeking, matched, completed
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  mentorships Mentorship[]

  @@index([status])
}

model Mentorship {
  id              String   @id @default(cuid())
  mentorId        String
  menteeId        String
  status          String   @default("pending") // pending, active, paused, completed, ended
  goals           String   // JSON array
  startDate       DateTime @default(now())
  endDate         DateTime?
  nextCheckIn     DateTime?
  notes           String?
  completionNotes String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  mentor       Mentor          @relation(fields: [mentorId], references: [id], onDelete: Cascade)
  mentee       Mentee          @relation(fields: [menteeId], references: [id], onDelete: Cascade)
  sessions     MentorSession[]
  messages     MentorMessage[]
  menteeGoals  MenteeGoal[]

  @@unique([mentorId, menteeId])
  @@index([mentorId, status])
  @@index([menteeId, status])
}

model MentorMessage {
  id           String    @id @default(cuid())
  mentorshipId String
  senderId     String
  content      String
  attachments  String?   // JSON array of attachment URLs
  readAt       DateTime?
  createdAt    DateTime  @default(now())

  mentorship Mentorship @relation(fields: [mentorshipId], references: [id], onDelete: Cascade)

  @@index([mentorshipId, createdAt])
}

model MentorSession {
  id           String   @id @default(cuid())
  mentorshipId String?
  mentorId     String
  title        String
  description  String?
  scheduledAt  DateTime
  duration     Int      // minutes
  type         String   // one_on_one, group, workshop
  meetingLink  String?
  status       String   @default("scheduled") // scheduled, completed, cancelled, no_show
  notes        String?
  feedback     String?
  createdAt    DateTime @default(now())

  mentorship Mentorship? @relation(fields: [mentorshipId], references: [id])
  mentor     Mentor      @relation(fields: [mentorId], references: [id], onDelete: Cascade)

  @@index([mentorId, scheduledAt])
  @@index([mentorshipId])
}

model MentorReview {
  id           String   @id @default(cuid())
  mentorId     String
  mentorshipId String?
  reviewerId   String
  rating       Float    // 1-5
  content      String?
  isPublic     Boolean  @default(false)
  createdAt    DateTime @default(now())

  mentor Mentor @relation(fields: [mentorId], references: [id], onDelete: Cascade)

  @@index([mentorId])
}

model MenteeGoal {
  id           String    @id @default(cuid())
  mentorshipId String
  title        String
  description  String?
  targetDate   DateTime?
  status       String    @default("active") // active, completed, abandoned
  progress     Float     @default(0) // 0-100
  completedAt  DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  mentorship Mentorship        @relation(fields: [mentorshipId], references: [id], onDelete: Cascade)
  milestones MenteeMilestone[]

  @@index([mentorshipId, status])
}

model MenteeMilestone {
  id          String    @id @default(cuid())
  goalId      String
  title       String
  isCompleted Boolean   @default(false)
  completedAt DateTime?
  notes       String?
  createdAt   DateTime  @default(now())

  goal MenteeGoal @relation(fields: [goalId], references: [id], onDelete: Cascade)

  @@index([goalId])
}

model SupportGroup {
  id              String   @id @default(cuid())
  name            String
  description     String
  type            String   // new_givers, loan_funders, community_leaders
  facilitatorId   String?
  maxMembers      Int      @default(12)
  isPrivate       Boolean  @default(false)
  meetingSchedule String?  // "weekly_wednesday_7pm"
  timezone        String?
  status          String   @default("active") // forming, active, full, archived
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  members  SupportGroupMember[]
  meetings SupportGroupMeeting[]
  posts    SupportGroupPost[]

  @@index([type, status])
}

model SupportGroupMember {
  id       String   @id @default(cuid())
  groupId  String
  userId   String
  role     String   @default("member") // facilitator, member
  joinedAt DateTime @default(now())
  status   String   @default("active")

  group SupportGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@unique([groupId, userId])
  @@index([userId])
}

model SupportGroupMeeting {
  id            String   @id @default(cuid())
  groupId       String
  title         String?
  scheduledAt   DateTime
  duration      Int      @default(60)
  topic         String?
  notes         String?
  recordingUrl  String?
  attendeeCount Int?
  createdAt     DateTime @default(now())

  group SupportGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@index([groupId, scheduledAt])
}

model SupportGroupPost {
  id        String   @id @default(cuid())
  groupId   String
  authorId  String
  content   String
  isPinned  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  group   SupportGroup        @relation(fields: [groupId], references: [id], onDelete: Cascade)
  replies SupportGroupReply[]

  @@index([groupId, createdAt])
}

model SupportGroupReply {
  id        String   @id @default(cuid())
  postId    String
  authorId  String
  content   String
  createdAt DateTime @default(now())

  post SupportGroupPost @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@index([postId])
}

// ============================================================================
// Plan 24: Impact Storytelling & Social Proof
// ============================================================================

model ImpactStory {
  id            String    @id @default(cuid())
  title         String
  slug          String    @unique
  summary       String    // 280 char tweet-length
  content       String    // JSON rich content blocks
  type          String    // beneficiary, giver, community, project
  authorId      String?
  authorName    String?   // For non-users
  authorRole    String?   // beneficiary, volunteer, funder, organizer
  projectId     String?
  communityId   String?
  loanId        String?
  mediaUrls     String    @default("[]") // JSON array
  videoUrl      String?
  quotes        String?   // JSON array of pull quotes
  impactMetrics String?   // JSON { "people_helped": 50 }
  location      String?
  tags          String    @default("[]") // JSON array
  isFeatured    Boolean   @default(false)
  isPublished   Boolean   @default(false)
  publishedAt   DateTime?
  status        String    @default("draft") // draft, review, published, archived
  viewCount     Int       @default(0)
  shareCount    Int       @default(0)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  project   Project?   @relation(fields: [projectId], references: [id])
  community Community? @relation(fields: [communityId], references: [id])
  views     StoryView[]
  shares    StoryShare[]

  @@index([type, status])
  @@index([isFeatured])
  @@index([projectId])
  @@index([communityId])
}

model StoryPrompt {
  id                String   @id @default(cuid())
  trigger           String   // project_completed, loan_repaid, badge_earned
  targetType        String   // giver, borrower, beneficiary
  promptText        String
  followUpQuestions String   @default("[]") // JSON array
  isActive          Boolean  @default(true)
  createdAt         DateTime @default(now())

  @@index([trigger, isActive])
}

model Testimonial {
  id             String   @id @default(cuid())
  content        String   // Short testimonial text
  authorId       String?
  authorName     String
  authorTitle    String?  // "Parent in Boise"
  authorImageUrl String?
  rating         Float?   // 1-5 stars
  type           String   // platform, project, community, loan
  entityId       String?  // Related entity ID
  isVerified     Boolean  @default(false)
  isFeatured     Boolean  @default(false)
  isPublished    Boolean  @default(false)
  displayOrder   Int      @default(0)
  createdAt      DateTime @default(now())

  @@index([type, isPublished])
  @@index([isFeatured])
}

model PlatformImpact {
  id           String   @id @default(cuid())
  metric       String   @unique // total_funded, projects_completed, etc.
  value        Float
  displayValue String?  // Formatted value
  lastUpdated  DateTime @default(now())
}

model BeforeAfter {
  id          String    @id @default(cuid())
  projectId   String
  title       String?
  beforeImage String
  afterImage  String
  beforeDate  DateTime?
  afterDate   DateTime?
  caption     String?
  isPublished Boolean   @default(false)
  createdAt   DateTime  @default(now())

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
}

model StoryView {
  id        String   @id @default(cuid())
  storyId   String
  userId    String?
  source    String?  // direct, social, email
  createdAt DateTime @default(now())

  story ImpactStory @relation(fields: [storyId], references: [id], onDelete: Cascade)

  @@index([storyId, createdAt])
}

model StoryShare {
  id        String   @id @default(cuid())
  storyId   String
  platform  String   // twitter, facebook, email, copy
  userId    String?
  createdAt DateTime @default(now())

  story ImpactStory @relation(fields: [storyId], references: [id], onDelete: Cascade)

  @@index([storyId, platform])
}

model StoryCampaign {
  id           String   @id @default(cuid())
  name         String
  description  String?
  theme        String?  // "Back to School", "Year in Review"
  startDate    DateTime
  endDate      DateTime
  targetCount  Int?
  currentCount Int      @default(0)
  status       String   @default("active")
  createdAt    DateTime @default(now())

  @@index([status, startDate])
}

// ============================================================================
// PLAN 25: ACCESSIBILITY & INTERNATIONALIZATION
// ============================================================================

model Translation {
  id        String   @id @default(cuid())
  locale    String
  namespace String   // common, auth, projects, communities, loans, account, admin
  key       String
  value     String
  context   String?  // Additional context for translators
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([locale, namespace, key])
  @@index([locale, namespace])
}

model UserLocale {
  id           String   @id @default(cuid())
  userId       String   @unique
  locale       String   @default("en")
  timezone     String?
  dateFormat   String?  // short, medium, long
  numberFormat String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model ContentTranslation {
  id           String   @id @default(cuid())
  entityType   String   // project, community, story, etc.
  entityId     String
  field        String   // title, description, etc.
  locale       String
  content      String
  isVerified   Boolean  @default(false)
  translatedBy String?  // userId or "auto"
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([entityType, entityId, field, locale])
  @@index([entityType, entityId])
}

model AccessibilityPreferences {
  id            String   @id @default(cuid())
  userId        String   @unique
  fontSize      String   @default("medium") // small, medium, large, xl
  fontFamily    String   @default("default") // default, dyslexic, mono
  lineSpacing   String   @default("normal") // tight, normal, relaxed
  highContrast  Boolean  @default(false)
  reducedMotion Boolean  @default(false)
  screenReader  Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// ============================================================================
// PLAN 26: GRANTS & LARGE FUNDING PROGRAMS
// ============================================================================

model GrantProgram {
  id               String    @id @default(cuid())
  name             String
  slug             String    @unique
  description      String
  funderId         String
  funderType       String    // individual, corporate, foundation, institution
  totalBudget      Float
  remainingBudget  Float
  minGrant         Float     @default(1000)
  maxGrant         Float     @default(50000)
  categories       String    @default("[]") // JSON array
  eligibility      String    @default("{}") // JSON
  focusAreas       String    @default("[]") // JSON array
  geographicFocus  String    @default("[]") // JSON array
  applicationStart DateTime
  applicationEnd   DateTime
  reviewStart      DateTime?
  awardDate        DateTime?
  reportingRequired Boolean  @default(true)
  reportingFrequency String? // monthly, quarterly, final
  status           String    @default("draft") // draft, open, reviewing, awarded, completed
  isPublic         Boolean   @default(true)
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  applications GrantApplication[]
  awards       GrantAward[]
  reviewers    GrantReviewer[]
  reports      GrantReport[]
  questions    GrantQuestion[]
  rubric       GrantRubric?

  @@index([status, applicationEnd])
  @@index([funderId])
}

model GrantReviewer {
  id         String   @id @default(cuid())
  programId  String
  userId     String
  role       String   @default("reviewer") // lead, reviewer, advisor
  assignedAt DateTime @default(now())

  program GrantProgram @relation(fields: [programId], references: [id], onDelete: Cascade)

  @@unique([programId, userId])
}

model GrantApplication {
  id                 String    @id @default(cuid())
  programId          String
  applicantId        String
  projectTitle       String
  projectSummary     String
  requestedAmount    Float
  proposedBudget     String    @default("{}") // JSON
  timeline           String    @default("[]") // JSON
  teamMembers        String    @default("[]") // JSON
  impactStatement    String
  measurableOutcomes String    @default("[]") // JSON
  attachments        String    @default("[]") // JSON array
  answers            String    @default("{}") // JSON
  status             String    @default("draft") // draft, submitted, under_review, approved, rejected, withdrawn
  submittedAt        DateTime?
  lastSavedAt        DateTime  @default(now())
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  program   GrantProgram    @relation(fields: [programId], references: [id], onDelete: Cascade)
  applicant User            @relation(fields: [applicantId], references: [id], onDelete: Cascade)
  reviews   GrantReview[]
  feedback  GrantFeedback[]
  award     GrantAward?

  @@unique([programId, applicantId])
  @@index([programId, status])
  @@index([applicantId])
}

model GrantQuestion {
  id         String   @id @default(cuid())
  programId  String
  question   String
  type       String   // text, textarea, select, multiselect, file, number
  options    String   @default("[]") // JSON array
  isRequired Boolean  @default(true)
  maxLength  Int?
  helpText   String?
  order      Int      @default(0)
  section    String?
  createdAt  DateTime @default(now())

  program GrantProgram @relation(fields: [programId], references: [id], onDelete: Cascade)

  @@index([programId, order])
}

model GrantReview {
  id             String    @id @default(cuid())
  applicationId  String
  reviewerId     String
  scores         String    @default("{}") // JSON
  overallScore   Float?
  strengths      String?
  weaknesses     String?
  recommendation String?   // fund, fund_with_conditions, decline, needs_discussion
  isComplete     Boolean   @default(false)
  completedAt    DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  application GrantApplication @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  @@unique([applicationId, reviewerId])
  @@index([applicationId])
}

model GrantRubric {
  id        String   @id @default(cuid())
  programId String   @unique
  criteria  String   // JSON array
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  program GrantProgram @relation(fields: [programId], references: [id], onDelete: Cascade)
}

model GrantFeedback {
  id            String   @id @default(cuid())
  applicationId String
  authorId      String
  content       String
  isPublic      Boolean  @default(false)
  createdAt     DateTime @default(now())

  application GrantApplication @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  @@index([applicationId])
}

model GrantAward {
  id                   String    @id @default(cuid())
  programId            String
  applicationId        String    @unique
  recipientId          String
  awardedAmount        Float
  conditions           String?
  disbursementSchedule String    @default("[]") // JSON
  totalDisbursed       Float     @default(0)
  status               String    @default("pending") // pending, active, completed, terminated
  awardedAt            DateTime  @default(now())
  startDate            DateTime
  endDate              DateTime
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  program       GrantProgram       @relation(fields: [programId], references: [id], onDelete: Cascade)
  application   GrantApplication   @relation(fields: [applicationId], references: [id])
  disbursements GrantDisbursement[]

  @@index([programId, status])
  @@index([recipientId])
}

model GrantDisbursement {
  id            String    @id @default(cuid())
  awardId       String
  amount        Float
  scheduledDate DateTime
  disbursedAt   DateTime?
  status        String    @default("scheduled") // scheduled, pending, disbursed, failed
  notes         String?
  createdAt     DateTime  @default(now())

  award GrantAward @relation(fields: [awardId], references: [id], onDelete: Cascade)

  @@index([awardId, status])
}

model GrantReport {
  id          String    @id @default(cuid())
  awardId     String
  programId   String
  type        String    // progress, final, financial
  periodStart DateTime
  periodEnd   DateTime
  content     String    @default("{}") // JSON
  attachments String    @default("[]") // JSON array
  status      String    @default("draft") // draft, submitted, approved, revision_requested
  submittedAt DateTime?
  reviewedAt  DateTime?
  reviewedBy  String?
  feedback    String?
  dueDate     DateTime
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  program GrantProgram @relation(fields: [programId], references: [id], onDelete: Cascade)

  @@index([awardId, type])
  @@index([programId, status])
}

model GrantReportTemplate {
  id        String   @id @default(cuid())
  programId String
  type      String   // progress, final, financial
  sections  String   // JSON
  createdAt DateTime @default(now())

  @@unique([programId, type])
}

// =============================================================================
// PLAN 27: BLOCKCHAIN TRANSPARENCY LEDGER
// =============================================================================

model TransparencyRecord {
  id           String    @id @default(cuid())
  recordType   String    // contribution, allocation, disbursement, impact, loan, milestone
  entityType   String    // project, loan, community, watershed, user
  entityId     String
  amount       Float?
  metadata     String    @default("{}") // JSON - Record details
  hash         String    @unique // SHA-256 of record
  previousHash String?   // Chain link for sequential records
  anchorStatus String    @default("pending") // pending, anchored, failed
  anchorTxHash String?   // Blockchain transaction hash
  anchorChain  String?   // ethereum, polygon, solana
  anchoredAt   DateTime?
  createdAt    DateTime  @default(now())

  proofs TransparencyProof[]

  @@index([entityType, entityId])
  @@index([anchorStatus])
  @@index([hash])
  @@index([createdAt])
}

model TransparencyAnchor {
  id          String    @id @default(cuid())
  chain       String    // ethereum, polygon, solana
  merkleRoot  String    // Root hash of batch
  recordCount Int
  fromRecordId String
  toRecordId  String
  txHash      String    @unique
  blockNumber Int?
  gasUsed     Float?
  costUsd     Float?
  status      String    @default("pending") // pending, confirmed, failed
  confirmedAt DateTime?
  createdAt   DateTime  @default(now())

  @@index([chain, status])
  @@index([createdAt])
}

model TransparencyProof {
  id           String    @id @default(cuid())
  recordId     String
  proofType    String    // merkle, full_chain
  proof        String    @default("{}") // JSON - Merkle proof data
  rootHash     String
  anchorTxHash String?
  isValid      Boolean?
  validatedAt  DateTime?
  expiresAt    DateTime?
  accessCount  Int       @default(0)
  createdAt    DateTime  @default(now())

  record TransparencyRecord @relation(fields: [recordId], references: [id], onDelete: Cascade)

  @@index([recordId])
  @@index([rootHash])
}

model ImpactCertificate {
  id              String   @id @default(cuid())
  userId          String
  certificateType String   // contribution, project_backer, loan_funder, volunteer
  entityType      String   // project, loan, community
  entityId        String
  amount          Float?
  impactClaim     String   // Human-readable impact statement
  issuedAt        DateTime @default(now())
  recordHash      String   // Link to TransparencyRecord hash
  certificateHash String   @unique
  metadata        String   @default("{}") // JSON
  imageUrl        String?  // Generated certificate image
  isPublic        Boolean  @default(true)
  viewCount       Int      @default(0)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([certificateHash])
  @@index([entityType, entityId])
}

model OrganizationLedger {
  id               String   @id @default(cuid())
  organizationId   String
  organizationType String   // project, community, institution
  totalReceived    Float    @default(0)
  totalDisbursed   Float    @default(0)
  lastUpdated      DateTime @default(now())
  ledgerHash       String?  // Current state hash
  isPublic         Boolean  @default(true)

  entries LedgerEntry[]

  @@unique([organizationId, organizationType])
  @@index([organizationType])
}

model LedgerEntry {
  id          String   @id @default(cuid())
  ledgerId    String
  entryType   String   // received, disbursed, expense, transfer
  amount      Float
  description String
  category    String?
  documentUrl String?
  recordHash  String?  // Link to TransparencyRecord
  createdAt   DateTime @default(now())

  ledger OrganizationLedger @relation(fields: [ledgerId], references: [id], onDelete: Cascade)

  @@index([ledgerId, createdAt])
}

// =============================================================================
// PLAN 28: AI-POWERED PLATFORM FEATURES
// =============================================================================

model ContentFlag {
  id          String    @id @default(cuid())
  contentType String    // project, comment, story, loan, discussion
  contentId   String
  flagType    String    // spam, inappropriate, fraud_risk, off_topic, duplicate
  confidence  Float     // 0-1 AI confidence score
  reason      String?
  details     String    @default("{}") // JSON - detailed analysis
  status      String    @default("pending") // pending, reviewed, dismissed, actioned
  reviewedBy  String?
  reviewedAt  DateTime?
  action      String?   // hide, delete, warn, none
  createdAt   DateTime  @default(now())

  @@index([contentType, contentId])
  @@index([status, flagType])
  @@index([createdAt])
}

model SearchEmbedding {
  id         String   @id @default(cuid())
  entityType String   // project, community, story, resource
  entityId   String
  embedding  Bytes    // Vector embedding (serialized float array)
  text       String   // Original text that was embedded
  model      String   @default("text-embedding-3-small") // Model used
  dimensions Int      @default(1536)
  updatedAt  DateTime @default(now())

  @@unique([entityType, entityId])
  @@index([entityType])
}

model ProjectPrediction {
  id              String   @id @default(cuid())
  projectId       String   @unique
  successProb     Float    // 0-1 probability of reaching funding goal
  predictedDays   Int?     // Estimated days to full funding
  riskFactors     String   @default("[]") // JSON array of risk factors
  strengthFactors String   @default("[]") // JSON array of strength factors
  confidence      Float    @default(0.5) // Model confidence in prediction
  computedAt      DateTime @default(now())

  @@index([successProb])
}

model AIAssistanceLog {
  id           String   @id @default(cuid())
  userId       String
  assistType   String   // description, grant, story, moderation, search
  inputLength  Int      // Characters of input
  outputLength Int      // Characters of output
  model        String   // AI model used
  latencyMs    Int      // Response time
  tokensUsed   Int      // Total tokens consumed
  costUsd      Float?   // Estimated cost
  feedback     String?  // user_helpful, user_not_helpful
  createdAt    DateTime @default(now())

  @@index([userId, assistType])
  @@index([createdAt])
}

model AIConversation {
  id          String    @id @default(cuid())
  userId      String
  context     String    // help, grant_assistant, description_helper
  messages    String    @default("[]") // JSON array of messages
  status      String    @default("active") // active, resolved, abandoned
  resolvedAt  DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([userId, status])
  @@index([context])
}

model TrendAnalysis {
  id            String   @id @default(cuid())
  trendType     String   // category, community, topic, keyword
  identifier    String   // The specific category/community/topic
  period        String   // daily, weekly, monthly
  periodStart   DateTime
  periodEnd     DateTime
  metrics       String   @default("{}") // JSON - various metrics
  changePercent Float?   // Change from previous period
  momentum      Float    @default(0) // Trend momentum score
  createdAt     DateTime @default(now())

  @@unique([trendType, identifier, period, periodStart])
  @@index([trendType, period])
}

// =============================================================================
// PLAN 29: COMMUNITY MARKETPLACE
// =============================================================================

model MarketplaceListing {
  id             String    @id @default(cuid())
  sellerId       String
  communityId    String
  title          String
  description    String
  type           String    // product, service, skill, rental, free
  category       String
  subcategory    String?
  price          Float?    // null for free items
  pricingType    String    @default("fixed") // fixed, negotiable, hourly, daily
  images         String    @default("[]") // JSON array of image URLs
  condition      String?   // new, like_new, good, fair (for products)
  availability   String?   // JSON for services/rentals
  location       String?
  isDeliverable  Boolean   @default(false)
  deliveryRadius Float?    // Miles
  quantity       Int       @default(1)
  tags           String    @default("[]") // JSON array
  status         String    @default("active") // draft, active, sold, expired, removed
  viewCount      Int       @default(0)
  donatePercent  Float     @default(0) // % to donate to community
  expiresAt      DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  seller       User      @relation("SellerListings", fields: [sellerId], references: [id], onDelete: Cascade)
  community    Community @relation(fields: [communityId], references: [id], onDelete: Cascade)
  inquiries    ListingInquiry[]
  offers       ListingOffer[]
  reviews      MarketplaceReview[]
  transactions MarketplaceTransaction[]

  @@index([communityId, category, status])
  @@index([sellerId, status])
  @@index([type, status])
}

model ListingCategory {
  id       String  @id @default(cuid())
  name     String  @unique
  slug     String  @unique
  icon     String?
  parent   String? // For subcategories
  order    Int     @default(0)
  isActive Boolean @default(true)

  @@index([parent])
}

model ListingInquiry {
  id        String   @id @default(cuid())
  listingId String
  senderId  String
  message   String
  status    String   @default("pending") // pending, replied, closed
  createdAt DateTime @default(now())

  listing  MarketplaceListing @relation(fields: [listingId], references: [id], onDelete: Cascade)
  messages InquiryMessage[]

  @@index([listingId, status])
  @@index([senderId])
}

model InquiryMessage {
  id        String   @id @default(cuid())
  inquiryId String
  senderId  String
  content   String
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())

  inquiry ListingInquiry @relation(fields: [inquiryId], references: [id], onDelete: Cascade)

  @@index([inquiryId, createdAt])
}

model ListingOffer {
  id            String    @id @default(cuid())
  listingId     String
  buyerId       String
  amount        Float
  counterAmount Float?    // Seller's counter-offer amount
  message       String?
  status        String    @default("pending") // pending, accepted, rejected, countered, expired, withdrawn
  expiresAt     DateTime
  respondedAt   DateTime?
  createdAt     DateTime  @default(now())

  listing MarketplaceListing @relation(fields: [listingId], references: [id], onDelete: Cascade)

  @@index([listingId, status])
  @@index([buyerId, status])
}

model MarketplaceTransaction {
  id                String    @id @default(cuid())
  listingId         String
  buyerId           String
  sellerId          String
  communityId       String
  amount            Float
  platformFee       Float     @default(0)
  communityDonation Float     @default(0)
  status            String    @default("pending") // pending, in_progress, completed, cancelled, disputed
  paymentMethod     String?   // platform, cash, external
  paymentRef        String?
  completedAt       DateTime?
  createdAt         DateTime  @default(now())

  listing MarketplaceListing @relation(fields: [listingId], references: [id], onDelete: Cascade)
  buyer   User               @relation("BuyerTransactions", fields: [buyerId], references: [id])
  seller  User               @relation("SellerTransactions", fields: [sellerId], references: [id])
  review  MarketplaceReview?
  dispute MarketplaceDispute?

  @@index([sellerId, status])
  @@index([buyerId, status])
  @@index([communityId, createdAt])
  @@index([listingId])
}

model MarketplaceReview {
  id            String   @id @default(cuid())
  transactionId String   @unique
  listingId     String
  reviewerId    String
  revieweeId    String
  rating        Int      // 1-5
  content       String?
  isVerified    Boolean  @default(true) // From completed transaction
  createdAt     DateTime @default(now())

  transaction MarketplaceTransaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  listing     MarketplaceListing     @relation(fields: [listingId], references: [id], onDelete: Cascade)

  @@index([revieweeId, createdAt])
  @@index([listingId])
}

model MarketplaceDispute {
  id            String    @id @default(cuid())
  transactionId String    @unique
  reporterId    String
  reason        String
  description   String
  evidence      String    @default("[]") // JSON array of URLs
  status        String    @default("open") // open, investigating, resolved, closed
  resolution    String?
  resolvedBy    String?
  resolvedAt    DateTime?
  createdAt     DateTime  @default(now())

  transaction MarketplaceTransaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
}

model CommunityWish {
  id          String    @id @default(cuid())
  communityId String
  requesterId String
  title       String
  description String?
  category    String?
  urgency     String    @default("normal") // low, normal, high
  status      String    @default("open") // open, fulfilled, closed
  fulfilledBy String?
  fulfilledAt DateTime?
  createdAt   DateTime  @default(now())

  @@index([communityId, status])
}

// =============================================================================
// Plan 30: Fundraising Events & Ticketing
// =============================================================================

model FundraisingEvent {
  id                   String    @id @default(cuid())
  communityId          String
  projectId            String?   // Optional linked project
  organizerId          String
  title                String
  slug                 String    @unique
  description          String
  type                 String    // gala, auction, 5k, concert, dinner, festival, virtual
  format               String    @default("in_person") // in_person, virtual, hybrid
  startDate            DateTime
  endDate              DateTime
  timezone             String    @default("America/Los_Angeles")
  venue                String?
  address              String?
  virtualUrl           String?   // For virtual/hybrid events
  imageUrl             String?
  coverImageUrl        String?
  goalAmount           Float?
  raisedAmount         Float     @default(0)
  ticketingEnabled     Boolean   @default(true)
  donationsEnabled     Boolean   @default(true)
  registrationRequired Boolean   @default(true)
  capacity             Int?
  attendeeCount        Int       @default(0)
  status               String    @default("draft") // draft, published, live, completed, cancelled
  publishedAt          DateTime?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  community     Community           @relation(fields: [communityId], references: [id], onDelete: Cascade)
  tickets       EventTicketType[]
  registrations EventRegistration[]
  donations     EventDonation[]
  matches       EventMatch[]
  auctions      AuctionItem[]
  sponsors      EventSponsor[]
  volunteers    EventVolunteer[]
  updates       EventUpdate[]
  participants  EventParticipant[]
  groups        EventGroup[]

  @@index([communityId, status])
  @@index([startDate])
  @@index([type, status])
}

model EventTicketType {
  id            String    @id @default(cuid())
  eventId       String
  name          String    // "General Admission", "VIP", "Table of 10"
  description   String?
  price         Float
  quantity      Int?      // null for unlimited
  sold          Int       @default(0)
  reserved      Int       @default(0)
  maxPerOrder   Int       @default(10)
  salesStart    DateTime?
  salesEnd      DateTime?
  isVisible     Boolean   @default(true)
  includedItems String    @default("[]") // JSON array
  order         Int       @default(0)
  createdAt     DateTime  @default(now())

  event   FundraisingEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)
  tickets EventTicket[]

  @@index([eventId])
}

model EventTicket {
  id             String    @id @default(cuid())
  ticketTypeId   String
  registrationId String
  ticketNumber   String    @unique
  qrCode         String?
  attendeeName   String?
  attendeeEmail  String?
  status         String    @default("valid") // valid, used, cancelled, refunded
  checkedInAt    DateTime?
  createdAt      DateTime  @default(now())

  ticketType   EventTicketType   @relation(fields: [ticketTypeId], references: [id], onDelete: Cascade)
  registration EventRegistration @relation(fields: [registrationId], references: [id], onDelete: Cascade)

  @@index([registrationId])
  @@index([ticketNumber])
}

model EventRegistration {
  id               String   @id @default(cuid())
  eventId          String
  userId           String?  // null for guest
  email            String
  firstName        String
  lastName         String
  phone            String?
  totalAmount      Float
  donationAmount   Float    @default(0)
  paymentStatus    String   @default("pending") // pending, completed, failed, refunded
  paymentRef       String?
  registrationCode String   @unique
  status           String   @default("confirmed") // confirmed, cancelled
  createdAt        DateTime @default(now())

  event   FundraisingEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)
  tickets EventTicket[]

  @@index([eventId, status])
  @@index([userId])
  @@index([email])
}

model EventDonation {
  id            String   @id @default(cuid())
  eventId       String
  userId        String?
  donorName     String?
  donorEmail    String?
  amount        Float
  isAnonymous   Boolean  @default(false)
  honoree       String?  // "In honor of..."
  message       String?
  paymentStatus String   @default("pending")
  paymentRef    String?
  matchedAmount Float    @default(0)
  createdAt     DateTime @default(now())

  event FundraisingEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([eventId, createdAt])
}

model EventMatch {
  id            String   @id @default(cuid())
  eventId       String
  matcherName   String
  maxAmount     Float
  matchedAmount Float    @default(0)
  ratio         Float    @default(1) // 1:1, 2:1, etc.
  message       String?
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())

  event FundraisingEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([eventId, isActive])
}

model AuctionItem {
  id             String   @id @default(cuid())
  eventId        String
  title          String
  description    String
  images         String   @default("[]") // JSON array
  category       String?
  startingBid    Float
  bidIncrement   Float    @default(5)
  currentBid     Float?
  reservePrice   Float?
  buyNowPrice    Float?
  donorName      String?
  estimatedValue Float?
  biddingStart   DateTime
  biddingEnd     DateTime
  status         String   @default("pending") // pending, active, sold, unsold
  winnerId       String?
  order          Int      @default(0)
  createdAt      DateTime @default(now())

  event FundraisingEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)
  bids  AuctionBid[]

  @@index([eventId, status])
}

model AuctionBid {
  id        String   @id @default(cuid())
  itemId    String
  bidderId  String
  amount    Float
  isWinning Boolean  @default(false)
  createdAt DateTime @default(now())

  item   AuctionItem @relation(fields: [itemId], references: [id], onDelete: Cascade)
  bidder User        @relation(fields: [bidderId], references: [id])

  @@index([itemId, amount])
  @@index([bidderId])
}

model EventParticipant {
  id              String   @id @default(cuid())
  eventId         String
  userId          String
  personalMessage String?  // Why this event matters to them
  shareCount      Int      @default(0) // For their own info, not public
  createdAt       DateTime @default(now())

  event FundraisingEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@unique([eventId, userId])
  @@index([eventId])
}

model EventGroup {
  id          String   @id @default(cuid())
  eventId     String
  name        String   // "The Smith Family", "Boise Rotary"
  description String?
  imageUrl    String?
  createdAt   DateTime @default(now())

  event   FundraisingEvent   @relation(fields: [eventId], references: [id], onDelete: Cascade)
  members EventGroupMember[]

  @@unique([eventId, name])
  @@index([eventId])
}

model EventGroupMember {
  id       String   @id @default(cuid())
  groupId  String
  userId   String
  joinedAt DateTime @default(now())

  group EventGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@unique([groupId, userId])
}

model EventVolunteer {
  id        String   @id @default(cuid())
  eventId   String
  userId    String
  role      String?  // greeter, check-in, auction, setup
  shift     String?
  status    String   @default("confirmed") // applied, confirmed, declined
  notes     String?
  createdAt DateTime @default(now())

  event FundraisingEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@unique([eventId, userId])
}

model EventSponsor {
  id               String   @id @default(cuid())
  eventId          String
  organizationName String
  contactName      String?
  contactEmail     String?
  tier             String   // presenting, gold, silver, bronze, friend
  amount           Float
  logoUrl          String?
  websiteUrl       String?
  benefits         String   @default("[]") // JSON array
  status           String   @default("confirmed") // pending, confirmed, cancelled
  createdAt        DateTime @default(now())

  event FundraisingEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([eventId, tier])
}

model EventUpdate {
  id        String   @id @default(cuid())
  eventId   String
  authorId  String
  title     String?
  content   String
  imageUrl  String?
  createdAt DateTime @default(now())

  event FundraisingEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([eventId, createdAt])
}

// ==========================================
// PLAN 31: PLEDGE & CROWDFUNDING CAMPAIGNS
// ==========================================

model PledgeCampaign {
  id              String    @id @default(cuid())
  projectId       String
  creatorId       String
  title           String
  slug            String    @unique
  description     String
  story           String?   // Rich campaign story (JSON stringified)
  videoUrl        String?
  coverImageUrl   String?
  goalAmount      Float
  minimumAmount   Float?    // Minimum to consider success (for flexible funding)
  pledgedAmount   Float     @default(0)
  backerCount     Int       @default(0)
  fundingType     String    @default("all_or_nothing") // all_or_nothing, flexible, milestone
  startDate       DateTime
  endDate         DateTime
  timezone        String    @default("America/Los_Angeles")
  status          String    @default("draft") // draft, active, successful, failed, cancelled
  fundedAt        DateTime?
  settledAt       DateTime? // When pledges were collected
  stretchGoals    String?   // JSON: [{ amount, title, description, unlocked }]
  faqs            String?   // JSON: [{ question, answer }]
  updateCount     Int       @default(0)
  shareCount      Int       @default(0)
  viewCount       Int       @default(0)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  project  Project           @relation(fields: [projectId], references: [id], onDelete: Cascade)
  creator  User              @relation("CampaignsCreated", fields: [creatorId], references: [id])
  pledges  Pledge[]
  rewards  CampaignReward[]
  updates  CampaignUpdate[]
  comments CampaignComment[]

  @@index([status, endDate])
  @@index([projectId])
  @@index([creatorId])
}

model Pledge {
  id              String    @id @default(cuid())
  campaignId      String
  userId          String
  rewardId        String?
  amount          Float
  tipAmount       Float     @default(0) // Optional platform tip
  status          String    @default("active") // active, cancelled, collected, failed, refunded
  paymentMethodId String?   // Stored payment method
  paymentIntentId String?   // For collection
  collectedAt     DateTime?
  cancelledAt     DateTime?
  refundedAt      DateTime?
  isAnonymous     Boolean   @default(false)
  message         String?   // Public backer message
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  campaign    PledgeCampaign    @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  user        User              @relation("Pledges", fields: [userId], references: [id])
  reward      CampaignReward?   @relation(fields: [rewardId], references: [id])
  fulfillment RewardFulfillment?

  @@index([campaignId, status])
  @@index([userId, status])
}

model CampaignReward {
  id                String    @id @default(cuid())
  campaignId        String
  title             String
  description       String
  amount            Float     // Minimum pledge for reward
  quantity          Int?      // null for unlimited
  claimed           Int       @default(0)
  estimatedDelivery DateTime?
  deliveryType      String    @default("digital") // digital, physical, experience
  shippingRequired  Boolean   @default(false)
  shippingCost      Float?
  imageUrl          String?
  items             String?   // JSON: [{ name, quantity }]
  order             Int       @default(0)
  isVisible         Boolean   @default(true)
  createdAt         DateTime  @default(now())

  campaign PledgeCampaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  pledges  Pledge[]

  @@index([campaignId, amount])
}

model RewardFulfillment {
  id              String    @id @default(cuid())
  pledgeId        String    @unique
  rewardId        String
  status          String    @default("pending") // pending, processing, shipped, delivered
  shippingAddress String?   // JSON: { name, line1, line2, city, state, zip, country }
  trackingNumber  String?
  trackingUrl     String?
  notes           String?
  fulfilledAt     DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  pledge Pledge @relation(fields: [pledgeId], references: [id], onDelete: Cascade)

  @@index([rewardId, status])
}

model CampaignUpdate {
  id            String   @id @default(cuid())
  campaignId    String
  authorId      String
  title         String
  content       String   // Rich content (JSON stringified or markdown)
  isBackersOnly Boolean  @default(false)
  attachments   String?  // JSON array of URLs
  commentCount  Int      @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  campaign PledgeCampaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@index([campaignId, createdAt])
}

model CampaignComment {
  id         String   @id @default(cuid())
  campaignId String
  userId     String
  parentId   String?  // For replies
  content    String
  isCreator  Boolean  @default(false) // Whether the commenter is the campaign creator
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  campaign PledgeCampaign    @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  user     User              @relation("CampaignComments", fields: [userId], references: [id])
  parent   CampaignComment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies  CampaignComment[] @relation("CommentReplies")

  @@index([campaignId, createdAt])
  @@index([parentId])
}

// ==========================================
// PLAN 32: GIFT CARDS & STORE CREDIT
// ==========================================

model GiftCard {
  id              String    @id @default(cuid())
  code            String    @unique
  purchaserId     String?   // null for platform-issued
  recipientEmail  String?
  recipientName   String?
  amount          Float
  balance         Float
  currency        String    @default("USD")
  type            String    @default("standard") // standard, promotional, reward, refund
  status          String    @default("active") // pending, active, redeemed, expired, cancelled
  designId        String?
  personalMessage String?
  deliveryMethod  String    @default("email") // email, print, physical
  deliveryDate    DateTime?
  deliveredAt     DateTime?
  redeemedBy      String?
  redeemedAt      DateTime?
  expiresAt       DateTime?
  orderId         String?   // For bulk orders
  purchasedAt     DateTime  @default(now())
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  purchaser    User?                 @relation("PurchasedGiftCards", fields: [purchaserId], references: [id])
  redeemer     User?                 @relation("RedeemedGiftCards", fields: [redeemedBy], references: [id])
  design       GiftCardDesign?       @relation(fields: [designId], references: [id])
  order        GiftCardOrder?        @relation(fields: [orderId], references: [id])
  transactions GiftCardTransaction[]

  @@index([code])
  @@index([recipientEmail])
  @@index([purchaserId])
  @@index([status])
}

model GiftCardDesign {
  id           String   @id @default(cuid())
  name         String
  category     String   // birthday, holiday, thank_you, general, seasonal
  imageUrl     String
  thumbnailUrl String?
  isActive     Boolean  @default(true)
  order        Int      @default(0)
  createdAt    DateTime @default(now())

  giftCards GiftCard[]

  @@index([category, isActive])
}

model GiftCardTransaction {
  id            String   @id @default(cuid())
  giftCardId    String
  userId        String
  type          String   // redemption, usage, refund
  amount        Float
  balanceBefore Float
  balanceAfter  Float
  reference     String?  // Related transaction ID
  description   String?
  createdAt     DateTime @default(now())

  giftCard GiftCard @relation(fields: [giftCardId], references: [id], onDelete: Cascade)

  @@index([giftCardId, createdAt])
  @@index([userId])
}

model GiftCardOrder {
  id               String    @id @default(cuid())
  purchaserId      String
  organizationName String?
  quantity         Int
  denomination     Float
  totalAmount      Float
  discountPercent  Float?
  discountAmount   Float?
  paymentStatus    String    @default("pending")
  paymentRef       String?
  status           String    @default("pending") // pending, processing, completed, cancelled
  deliveryType     String    @default("codes") // codes, physical, email
  notes            String?
  createdAt        DateTime  @default(now())
  completedAt      DateTime?

  giftCards     GiftCard[]
  physicalOrder PhysicalCardOrder?

  @@index([purchaserId])
  @@index([status])
}

model PhysicalCardOrder {
  id              String    @id @default(cuid())
  orderId         String    @unique
  shippingAddress String    // JSON: { name, line1, line2, city, state, zip, country }
  shippingMethod  String    // standard, express, overnight
  shippingCost    Float
  trackingNumber  String?
  carrier         String?
  status          String    @default("pending") // pending, printing, shipped, delivered
  printedAt       DateTime?
  shippedAt       DateTime?
  deliveredAt     DateTime?
  createdAt       DateTime  @default(now())

  order GiftCardOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)
}

model StoreCredit {
  id             String   @id @default(cuid())
  userId         String   @unique
  balance        Float    @default(0)
  lifetimeEarned Float    @default(0)
  lifetimeSpent  Float    @default(0)
  updatedAt      DateTime @updatedAt

  user         User                     @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions StoreCreditTransaction[]
}

model StoreCreditTransaction {
  id            String    @id @default(cuid())
  creditId      String
  type          String    // earned, spent, expired, adjusted
  source        String    // refund, reward, promotion, referral, adjustment
  amount        Float
  balanceBefore Float
  balanceAfter  Float
  reference     String?   // Related entity ID
  description   String?
  expiresAt     DateTime?
  createdAt     DateTime  @default(now())

  credit StoreCredit @relation(fields: [creditId], references: [id], onDelete: Cascade)

  @@index([creditId, createdAt])
}

model PromoCode {
  id           String   @id @default(cuid())
  code         String   @unique
  type         String   // discount, bonus_credit, free_card
  value        Float    // Percentage or fixed amount
  valueType    String   @default("fixed") // fixed, percentage
  minPurchase  Float?
  maxDiscount  Float?
  usageLimit   Int?     // Total uses allowed
  usageCount   Int      @default(0)
  userLimit    Int?     // Uses per user
  validFrom    DateTime
  validUntil   DateTime
  isActive     Boolean  @default(true)
  applicableTo String?  // JSON array of product types
  createdBy    String
  createdAt    DateTime @default(now())

  usages PromoCodeUsage[]

  @@index([code, isActive])
}

model PromoCodeUsage {
  id          String   @id @default(cuid())
  promoCodeId String
  userId      String
  orderId     String?
  discount    Float
  createdAt   DateTime @default(now())

  promoCode PromoCode @relation(fields: [promoCodeId], references: [id], onDelete: Cascade)

  @@unique([promoCodeId, userId, orderId])
}

// ============================================================================
// Plan 33: Nonprofit Partner Portal
// ============================================================================

model NonprofitOrganization {
  id                 String   @id @default(cuid())
  name               String
  slug               String   @unique
  legalName          String?
  ein                String?  // Tax ID
  type               String   // 501c3, 501c4, fiscal_sponsor, other
  mission            String
  description        String?
  website            String?
  email              String
  phone              String?
  logoUrl            String?
  coverImageUrl      String?
  address            String?  // JSON: { street, city, state, zip, country }
  focusAreas         String?  // JSON array
  geographicScope    String   @default("local") // local, regional, national, international
  foundedYear        Int?
  annualBudget       String?  // Range: <100k, 100k-500k, 500k-1m, 1m-5m, 5m+
  employeeCount      String?  // Range
  verificationStatus String   @default("pending") // pending, verified, rejected
  verifiedAt         DateTime?
  verifiedBy         String?
  isActive           Boolean  @default(true)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  members    OrganizationMember[]
  documents  OrganizationDocument[]
  donations  OrganizationDonation[]
  donors     DonorRelationship[]
  reports    OrganizationReport[]
  activities OrganizationActivity[]
  integrations OrganizationIntegration[]
  // Plan 35: Multi-Currency & Global
  payoutAccounts PayoutAccount[]
  taxStatuses    OrganizationTaxStatus[]

  @@index([type, verificationStatus])
  @@index([slug])
}

model OrganizationMember {
  id             String   @id @default(cuid())
  organizationId String
  userId         String
  role           String   @default("member") // owner, admin, member, viewer
  title          String?  // Job title
  permissions    String?  // JSON array of specific permissions
  invitedBy      String?
  invitedAt      DateTime?
  joinedAt       DateTime @default(now())
  status         String   @default("active") // invited, active, inactive

  organization NonprofitOrganization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User                   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([organizationId, userId])
  @@index([userId])
}

model OrganizationDocument {
  id             String   @id @default(cuid())
  organizationId String
  type           String   // ein_letter, 501c3_determination, bylaws, annual_report, audit
  name           String
  fileUrl        String
  fileSize       Int
  mimeType       String
  status         String   @default("pending") // pending, approved, rejected
  reviewedBy     String?
  reviewedAt     DateTime?
  reviewNotes    String?
  expiresAt      DateTime?
  uploadedBy     String
  uploadedAt     DateTime @default(now())

  organization NonprofitOrganization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId, type])
}

model OrganizationDonation {
  id             String   @id @default(cuid())
  organizationId String
  projectId      String?
  donorId        String?
  donorName      String?
  donorEmail     String?
  amount         Float
  isAnonymous    Boolean  @default(false)
  source         String   // platform, direct, external
  status         String   @default("completed")
  acknowledgedAt DateTime?
  createdAt      DateTime @default(now())

  organization NonprofitOrganization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId, createdAt])
  @@index([projectId])
}

model DonorRelationship {
  id              String   @id @default(cuid())
  organizationId  String
  userId          String?  // Null for external donors
  externalId      String?  // External CRM ID
  email           String
  firstName       String?
  lastName        String?
  totalDonated    Float    @default(0)
  donationCount   Int      @default(0)
  firstDonation   DateTime?
  lastDonation    DateTime?
  averageDonation Float?
  segment         String?  // major_donor, recurring, lapsed, new
  notes           String?
  tags            String?  // JSON array
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  organization NonprofitOrganization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, email])
  @@index([organizationId, segment])
}

model OrganizationReport {
  id             String   @id @default(cuid())
  organizationId String
  type           String   // annual, quarterly, impact, tax
  year           Int
  quarter        Int?
  data           String?  // JSON
  fileUrl        String?
  status         String   @default("draft") // draft, published
  publishedAt    DateTime?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization NonprofitOrganization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, type, year, quarter])
}

model OrganizationActivity {
  id             String   @id @default(cuid())
  organizationId String
  userId         String
  action         String   // project_created, donation_acknowledged, report_published
  entityType     String?
  entityId       String?
  metadata       String?  // JSON
  createdAt      DateTime @default(now())

  organization NonprofitOrganization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId, createdAt])
}

model OrganizationIntegration {
  id             String   @id @default(cuid())
  organizationId String
  provider       String   // salesforce, hubspot, bloomerang, neon, quickbooks, xero
  status         String   @default("active")
  config         String?  // JSON: Encrypted credentials
  lastSyncAt     DateTime?
  syncStatus     String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization NonprofitOrganization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, provider])
}

// ============================================================================
// Plan 34: Advanced Analytics & Business Intelligence
// ============================================================================

model AnalyticsEvent {
  id         String   @id @default(cuid())
  eventType  String   // page_view, action, conversion, error
  eventName  String   // fund_project, watch_ad, create_loan
  userId     String?
  sessionId  String?
  properties String?  // JSON: Event-specific data
  context    String?  // JSON: Device, browser, location
  timestamp  DateTime @default(now())

  @@index([eventType, eventName, timestamp])
  @@index([userId, timestamp])
  @@index([sessionId])
}

model UserSession {
  id          String   @id @default(cuid())
  userId      String?
  deviceId    String
  startedAt   DateTime @default(now())
  lastSeenAt  DateTime @default(now())
  duration    Int?     // Seconds
  pageViews   Int      @default(0)
  device      String?  // JSON: Device info
  referrer    String?
  utmSource   String?
  utmMedium   String?
  utmCampaign String?

  @@index([userId, startedAt])
  @@index([deviceId])
}

model MetricSnapshot {
  id          String   @id @default(cuid())
  metricType  String   // daily_active_users, revenue, projects_funded
  period      String   // hourly, daily, weekly, monthly
  periodStart DateTime
  periodEnd   DateTime
  value       Float
  dimensions  String?  // JSON: { community: "boise", category: "education" }
  computedAt  DateTime @default(now())

  @@unique([metricType, period, periodStart])
  @@index([metricType, period, periodStart])
}

model Dashboard {
  id          String   @id @default(cuid())
  ownerId     String
  ownerType   String   @default("user") // user, organization, admin
  name        String
  description String?
  isPublic    Boolean  @default(false)
  layout      String?  // JSON: Widget positions and sizes
  filters     String?  // JSON: Default filters
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  widgets DashboardWidget[]
  shares  DashboardShare[]

  @@index([ownerId, ownerType])
}

model DashboardWidget {
  id          String   @id @default(cuid())
  dashboardId String
  type        String   // chart, metric, table, map
  title       String
  config      String?  // JSON: Widget configuration
  dataSource  String   // Query or metric name
  position    String?  // JSON: { x, y, width, height }
  refreshRate Int?     // Seconds
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  dashboard Dashboard @relation(fields: [dashboardId], references: [id], onDelete: Cascade)

  @@index([dashboardId])
}

model DashboardShare {
  id          String   @id @default(cuid())
  dashboardId String
  sharedWith  String   // User ID or email
  permission  String   @default("view") // view, edit
  createdAt   DateTime @default(now())

  dashboard Dashboard @relation(fields: [dashboardId], references: [id], onDelete: Cascade)

  @@unique([dashboardId, sharedWith])
}

model AnalyticsFunnel {
  id          String   @id @default(cuid())
  name        String
  description String?
  steps       String   // JSON: [{ name, eventName, filters }]
  ownerId     String
  isPublic    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([ownerId])
}

model SavedQuery {
  id          String   @id @default(cuid())
  name        String
  description String?
  query       String   // JSON: Query definition
  ownerId     String
  isPublic    Boolean  @default(false)
  lastRunAt   DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([ownerId])
}

model Anomaly {
  id          String   @id @default(cuid())
  metricType  String
  detectedAt  DateTime
  severity    String   // low, medium, high, critical
  expected    Float
  actual      Float
  deviation   Float
  description String?
  status      String   @default("open") // open, acknowledged, resolved
  resolvedBy  String?
  resolvedAt  DateTime?
  createdAt   DateTime @default(now())

  @@index([metricType, detectedAt])
  @@index([status, severity])
}

// =============================================================================
// Plan 35: Multi-Currency & Global Expansion
// =============================================================================

model Currency {
  id        String   @id @default(cuid())
  code      String   @unique // USD, EUR, GBP, CAD
  name      String   // US Dollar, Euro, British Pound
  symbol    String   // $, , 
  decimals  Int      @default(2)
  isActive  Boolean  @default(true)
  isDefault Boolean  @default(false)
  order     Int      @default(0)
}

model ExchangeRate {
  id           String    @id @default(cuid())
  fromCurrency String
  toCurrency   String
  rate         Float
  source       String    // api_provider, manual
  validFrom    DateTime
  validUntil   DateTime?
  createdAt    DateTime  @default(now())

  @@unique([fromCurrency, toCurrency, validFrom])
  @@index([fromCurrency, toCurrency, validFrom])
}

model UserCurrencyPreference {
  id              String  @id @default(cuid())
  userId          String  @unique
  displayCurrency String  @default("USD")
  paymentCurrency String  @default("USD")
  autoConvert     Boolean @default(true)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model TransactionCurrency {
  id                String   @id @default(cuid())
  transactionId     String
  transactionType   String   // allocation, loan_share, donation
  originalAmount    Float
  originalCurrency  String
  convertedAmount   Float
  convertedCurrency String
  exchangeRate      Float
  rateTimestamp     DateTime
  createdAt         DateTime @default(now())

  @@unique([transactionId, transactionType])
}

model Region {
  id           String    @id @default(cuid())
  code         String    @unique // US, CA, GB, EU
  name         String
  currency     String    // Default currency
  timezone     String
  dateFormat   String    @default("MM/DD/YYYY")
  numberFormat String    // 1,000.00 vs 1.000,00
  taxIdLabel   String?   // EIN, CRN, ABN
  taxIdFormat  String?   // Validation regex
  isActive     Boolean   @default(true)
  launchDate   DateTime?
  config       String?   // JSON: Region-specific config

  @@index([isActive])
}

model UserRegion {
  id             String    @id @default(cuid())
  userId         String    @unique
  regionCode     String
  detectedAt     DateTime  @default(now())
  confirmedAt    DateTime?
  overrideRegion String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model PaymentMethod {
  id         String   @id @default(cuid())
  code       String   @unique // card, bank_transfer, paypal, ideal, sepa
  name       String
  type       String   // card, bank, wallet, local
  regions    String   // JSON: Supported regions
  currencies String   // JSON: Supported currencies
  minAmount  Float?
  maxAmount  Float?
  isActive   Boolean  @default(true)
  config     String?  // JSON: Additional config

  @@index([type, isActive])
}

model UserPaymentMethod {
  id         String    @id @default(cuid())
  userId     String
  methodCode String
  isDefault  Boolean   @default(false)
  metadata   String?   // JSON: Provider-specific data
  lastUsedAt DateTime?
  createdAt  DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model PayoutAccount {
  id             String    @id @default(cuid())
  organizationId String
  country        String
  currency       String
  accountType    String    // bank, paypal, wise
  accountDetails String    // JSON: Encrypted bank details
  isVerified     Boolean   @default(false)
  verifiedAt     DateTime?
  isDefault      Boolean   @default(false)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  organization NonprofitOrganization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
}

model TaxJurisdiction {
  id              String  @id @default(cuid())
  code            String  @unique
  name            String
  country         String
  taxType         String  // vat, gst, sales_tax, none
  rate            Float?
  threshold       Float?  // Registration threshold
  registrationReq Boolean @default(false)
  rules           String? // JSON: Complex rules
  isActive        Boolean @default(true)

  statuses OrganizationTaxStatus[]
}

model OrganizationTaxStatus {
  id             String    @id @default(cuid())
  organizationId String
  jurisdictionId String
  taxExempt      Boolean   @default(false)
  taxId          String?
  exemptionDoc   String?
  verifiedAt     DateTime?
  expiresAt      DateTime?
  createdAt      DateTime  @default(now())

  organization NonprofitOrganization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  jurisdiction TaxJurisdiction       @relation(fields: [jurisdictionId], references: [id])

  @@unique([organizationId, jurisdictionId])
}

model RegionLaunch {
  id         String    @id @default(cuid())
  regionCode String    @unique
  status     String    @default("planning") // planning, beta, soft_launch, launched
  betaUsers  String    // JSON: Beta tester IDs
  launchDate DateTime?
  checklist  String?   // JSON: Launch checklist items
  notes      String?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
}

// =============================================================================
// Plan 36: Notification & Communication Center
// =============================================================================

model NotificationDelivery {
  id                String    @id @default(cuid())
  notificationId    String
  channel           String    // email, push, sms
  status            String    @default("pending") // pending, sent, delivered, failed, bounced
  provider          String?   // sendgrid, twilio, firebase
  providerMessageId String?
  sentAt            DateTime?
  deliveredAt       DateTime?
  failedAt          DateTime?
  errorMessage      String?
  retryCount        Int       @default(0)
  createdAt         DateTime  @default(now())

  @@index([notificationId])
  @@index([channel, status])
}

model NotificationChannel {
  id         String    @id @default(cuid())
  userId     String
  channel    String    // push, sms
  identifier String    // device token, phone number
  name       String?   // "iPhone", "Work Phone"
  isVerified Boolean   @default(false)
  isActive   Boolean   @default(true)
  lastUsedAt DateTime?
  createdAt  DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, channel, identifier])
  @@index([userId, channel])
}

model NotificationDigest {
  id              String   @id @default(cuid())
  userId          String
  frequency       String   // daily, weekly
  periodStart     DateTime
  periodEnd       DateTime
  notificationIds String   // JSON: array of notification IDs
  status          String   @default("pending") // pending, sent
  sentAt          DateTime?
  createdAt       DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, frequency, periodStart])
  @@index([status])
}

model NotificationTemplate {
  id               String   @id @default(cuid())
  name             String   @unique
  type             String
  subject          String?  // For email
  titleTemplate    String
  bodyTemplate     String
  richBodyTemplate String?  // JSON
  emailTemplate    String?  // HTML template ID
  pushTemplate     String?  // JSON
  smsTemplate      String?
  variables        String   // JSON: Required variables
  isActive         Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

model NotificationTrigger {
  id         String   @id @default(cuid())
  name       String   @unique
  eventType  String   // project_funded, loan_repaid, etc.
  conditions String?  // JSON: Trigger conditions
  templateId String
  channels   String   // JSON: array of channels
  delay      Int?     // Delay in seconds
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model NotificationMetric {
  id           String   @id @default(cuid())
  date         DateTime
  type         String
  channel      String
  sent         Int      @default(0)
  delivered    Int      @default(0)
  opened       Int      @default(0)
  clicked      Int      @default(0)
  failed       Int      @default(0)
  unsubscribed Int      @default(0)

  @@unique([date, type, channel])
}

// =============================================================================
// Plan 37: Social Media Integration
// =============================================================================

model SocialAccount {
  id           String    @id @default(cuid())
  userId       String
  provider     String    // google, facebook, twitter, linkedin, apple
  providerId   String    // Provider's user ID
  email        String?
  name         String?
  profileUrl   String?
  avatarUrl    String?
  accessToken  String?   // Encrypted
  refreshToken String?   // Encrypted
  tokenExpiry  DateTime?
  scope        String?   // JSON: Authorized scopes
  isConnected  Boolean   @default(true)
  lastSyncAt   DateTime?
  connectedAt  DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerId])
  @@index([userId])
}

model SocialShare {
  id          String   @id @default(cuid())
  userId      String?
  entityType  String   // project, campaign, community, story
  entityId    String
  platform    String   // twitter, facebook, linkedin, whatsapp, email
  shareType   String   // link, card, story
  shareUrl    String?
  postId      String?  // Platform's post ID if available
  impressions Int?
  clicks      Int?
  conversions Int?
  metadata    String?  // JSON
  createdAt   DateTime @default(now())

  @@index([entityType, entityId])
  @@index([userId, platform])
  @@index([createdAt])
}

model SocialPost {
  id           String    @id @default(cuid())
  userId       String
  accountId    String    // SocialAccount ID
  platform     String
  content      String
  mediaUrls    String?   // JSON: array of media URLs
  linkUrl      String?
  scheduledFor DateTime?
  postedAt     DateTime?
  postId       String?   // Platform's post ID
  status       String    @default("draft") // draft, scheduled, posted, failed
  errorMessage String?
  metrics      String?   // JSON: likes, shares, comments
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, status])
  @@index([scheduledFor, status])
}

model ImportedContact {
  id            String    @id @default(cuid())
  userId        String
  source        String    // google, facebook, phone
  email         String?
  phone         String?
  name          String?
  matchedUserId String?   // If found on Deluge
  invitedAt     DateTime?
  status        String    @default("pending") // pending, matched, invited, joined
  importedAt    DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, source, email])
  @@index([userId, status])
  @@index([matchedUserId])
}

model SocialChallenge {
  id               String   @id @default(cuid())
  creatorId        String
  projectId        String?
  name             String
  hashtag          String   @unique
  description      String
  instructions     String
  mediaExample     String?
  goalType         String   // participants, raised, shares
  goalValue        Float
  currentValue     Float    @default(0)
  startDate        DateTime
  endDate          DateTime
  status           String   @default("active")
  participantCount Int      @default(0)
  createdAt        DateTime @default(now())

  participants SocialChallengeParticipant[]

  @@index([hashtag])
  @@index([status, endDate])
}

model SocialChallengeParticipant {
  id           String   @id @default(cuid())
  challengeId  String
  userId       String
  postUrl      String?
  platform     String?
  amountRaised Float    @default(0)
  joinedAt     DateTime @default(now())

  challenge SocialChallenge @relation(fields: [challengeId], references: [id], onDelete: Cascade)

  @@unique([challengeId, userId])
}

// =============================================================================
// Plan 38: Community Celebrations & Milestones
// =============================================================================

model Milestone {
  id            String    @id @default(cuid())
  entityType    String    // user, community, family, platform
  entityId      String
  milestoneType String    // first_project, projects_10, funding_1k, etc.
  title         String
  description   String
  reachedAt     DateTime  @default(now())
  celebratedAt  DateTime? // When user saw celebration
  sharedAt      DateTime? // If they chose to share
  metadata      String?   // JSON: Context about the milestone

  @@unique([entityType, entityId, milestoneType])
  @@index([entityType, entityId])
  @@index([reachedAt])
}

model ReflectionCard {
  id        String   @id @default(cuid())
  userId    String
  cardType  String   // monthly, yearly, milestone
  period    String?  // "2026-01" or "2026"
  stats     String   // JSON: Impact statistics
  imageUrl  String?  // Generated card image
  isPublic  Boolean  @default(false)
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, cardType])
}

model SharedJourney {
  id           String   @id @default(cuid())
  name         String
  description  String
  purpose      String   // What we're working toward together
  creatorId    String
  imageUrl     String?
  targetType   String?  // Optional: projects_funded, amount_raised
  targetValue  Float?
  currentValue Float    @default(0)
  startDate    DateTime @default(now())
  visibility   String   @default("members") // members, community, public
  status       String   @default("active")  // active, completed, paused
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  members JourneyMember[]
  moments JourneyMoment[]

  @@index([status])
}

model JourneyMember {
  id           String   @id @default(cuid())
  journeyId    String
  userId       String
  role         String   @default("member") // creator, member
  contribution Float    @default(0) // Not displayed publicly
  joinedAt     DateTime @default(now())

  journey SharedJourney @relation(fields: [journeyId], references: [id], onDelete: Cascade)
  user    User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([journeyId, userId])
}

model JourneyMoment {
  id        String   @id @default(cuid())
  journeyId String
  type      String   // member_joined, milestone_reached, project_funded
  message   String
  metadata  String?  // JSON
  createdAt DateTime @default(now())

  journey SharedJourney @relation(fields: [journeyId], references: [id], onDelete: Cascade)

  @@index([journeyId, createdAt])
}

model ReflectionPeriod {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  description String
  theme       String   // giving_tuesday, year_end, spring_renewal
  startDate   DateTime
  endDate     DateTime
  isActive    Boolean  @default(true)
  content     String?  // JSON: Reflection prompts, suggested actions
  createdAt   DateTime @default(now())

  @@index([isActive, startDate])
}

model ThankYouNote {
  id          String    @id @default(cuid())
  recipientId String    // The giver
  projectId   String
  message     String
  fromName    String?   // Beneficiary name (optional)
  isAnonymous Boolean   @default(true)
  mediaUrl    String?
  readAt      DateTime?
  createdAt   DateTime  @default(now())

  @@index([recipientId, readAt])
}

// =============================================================================
// Plan 39: Privacy & Security
// =============================================================================

model UserConsent {
  id          String    @id @default(cuid())
  userId      String
  consentType String    // marketing, analytics, third_party, data_sharing
  granted     Boolean
  version     String    // Policy version
  ipAddress   String?
  userAgent   String?
  grantedAt   DateTime?
  revokedAt   DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, consentType])
  @@index([userId])
  @@index([consentType, granted])
}

model ConsentPolicy {
  id            String   @id @default(cuid())
  type          String   @unique
  version       String
  title         String
  description   String
  content       String
  isActive      Boolean  @default(true)
  effectiveDate DateTime
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([type, isActive])
}

model PrivacySettings {
  id                 String   @id @default(cuid())
  userId             String   @unique
  profileVisibility  String   @default("public") // public, community, private
  showGivingHistory  Boolean  @default(false)
  showBadges         Boolean  @default(true)
  showCommunities    Boolean  @default(true)
  allowTagging       Boolean  @default(true)
  allowMessages      String   @default("followers") // anyone, followers, none
  showOnLeaderboards Boolean  @default(true)
  dataRetention      String   @default("indefinite") // 1y, 3y, 5y, indefinite
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model DataCategory {
  id          String   @id @default(cuid())
  name        String   @unique
  description String
  retention   String   // Duration or "indefinite"
  legalBasis  String   // consent, contract, legal, legitimate_interest
  purposes    String   // JSON array of purposes
  recipients  String   // JSON array of third parties
  isRequired  Boolean  @default(false)
  createdAt   DateTime @default(now())
}

model DataRequest {
  id          String    @id @default(cuid())
  userId      String
  type        String    // access, export, deletion, rectification, portability
  status      String    @default("pending") // pending, processing, completed, failed
  requestedAt DateTime  @default(now())
  processedAt DateTime?
  processedBy String?
  resultUrl   String?   // Download link
  expiresAt   DateTime?
  notes       String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, type])
  @@index([status])
}

model SecurityEvent {
  id        String   @id @default(cuid())
  userId    String?
  eventType String   // login, logout, password_change, 2fa_enabled
  severity  String   @default("info") // info, warning, critical
  ipAddress String?
  userAgent String?
  location  String?  // JSON geo data
  metadata  String?  // JSON
  createdAt DateTime @default(now())

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId, eventType])
  @@index([createdAt])
  @@index([severity])
}

model SecuritySession {
  id           String   @id @default(cuid())
  userId       String
  token        String   @unique
  deviceName   String?
  deviceType   String?  // desktop, mobile, tablet
  ipAddress    String?
  location     String?
  lastActiveAt DateTime @default(now())
  expiresAt    DateTime
  isRevoked    Boolean  @default(false)
  createdAt    DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRevoked])
  @@index([token])
}

model TwoFactorAuth {
  id          String    @id @default(cuid())
  userId      String    @unique
  method      String    // totp, sms, email
  secret      String?   // Encrypted TOTP secret
  phone       String?
  backupCodes String    // JSON array of hashed backup codes
  isEnabled   Boolean   @default(false)
  verifiedAt  DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model SecurityAuditLog {
  id            String   @id @default(cuid())
  userId        String?
  action        String   // create, read, update, delete
  entityType    String
  entityId      String
  previousState String?  // JSON
  newState      String?  // JSON
  ipAddress     String?
  userAgent     String?
  metadata      String?  // JSON
  createdAt     DateTime @default(now())

  @@index([entityType, entityId])
  @@index([userId, createdAt])
  @@index([action, createdAt])
}

model RateLimit {
  id           String    @id @default(cuid())
  identifier   String    // IP, user ID, or API key
  endpoint     String
  count        Int       @default(0)
  windowStart  DateTime
  windowEnd    DateTime
  isBlocked    Boolean   @default(false)
  blockedUntil DateTime?

  @@unique([identifier, endpoint, windowStart])
  @@index([identifier, isBlocked])
}

model SuspiciousActivity {
  id          String    @id @default(cuid())
  userId      String?
  type        String    // velocity, location, device, pattern
  severity    String    // low, medium, high, critical
  description String
  indicators  String    // JSON
  status      String    @default("pending") // pending, reviewed, false_positive, confirmed
  reviewedBy  String?
  reviewedAt  DateTime?
  createdAt   DateTime  @default(now())

  @@index([userId, status])
  @@index([severity, status])
}

model AccountRecovery {
  id        String    @id @default(cuid())
  userId    String
  type      String    // email, phone, backup_code
  token     String    @unique
  expiresAt DateTime
  usedAt    DateTime?
  ipAddress String?
  createdAt DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
}

// =============================================================================
// Plan 40: Admin Automation & Workflows
// =============================================================================

model Automation {
  id          String    @id @default(cuid())
  name        String
  description String?
  trigger     String    // JSON: Event or schedule trigger
  conditions  String?   // JSON: When to run
  actions     String    // JSON: What to do
  isActive    Boolean   @default(true)
  runCount    Int       @default(0)
  lastRunAt   DateTime?
  lastStatus  String?
  createdBy   String
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  runs AutomationRun[]

  @@index([isActive])
}

model AutomationRun {
  id           String    @id @default(cuid())
  automationId String
  triggeredBy  String    // event, schedule, manual
  triggerData  String?   // JSON
  status       String    @default("pending") // pending, running, completed, failed
  result       String?   // JSON
  error        String?
  startedAt    DateTime  @default(now())
  completedAt  DateTime?
  duration     Int?      // milliseconds

  automation Automation @relation(fields: [automationId], references: [id], onDelete: Cascade)

  @@index([automationId, status])
  @@index([startedAt])
}

model AdminWorkflow {
  id          String   @id @default(cuid())
  name        String
  description String?
  entityType  String   // project, loan, proposal, grant
  trigger     String   // on_create, on_update, manual
  steps       String   // JSON: [{ order, type, config, approvers }]
  isActive    Boolean  @default(true)
  createdBy   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  instances WorkflowInstance[]

  @@index([entityType, isActive])
}

model WorkflowInstance {
  id          String    @id @default(cuid())
  workflowId  String
  entityType  String
  entityId    String
  currentStep Int       @default(0)
  status      String    @default("active") // active, completed, cancelled, failed
  stepHistory String    // JSON: History of step completions
  startedAt   DateTime  @default(now())
  completedAt DateTime?
  metadata    String?   // JSON

  workflow  AdminWorkflow      @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  approvals WorkflowApproval[]

  @@index([entityType, entityId])
  @@index([workflowId, status])
}

model WorkflowApproval {
  id         String   @id @default(cuid())
  instanceId String
  stepNumber Int
  approverId String
  decision   String   // approved, rejected, escalated
  comment    String?
  decidedAt  DateTime @default(now())

  instance WorkflowInstance @relation(fields: [instanceId], references: [id], onDelete: Cascade)

  @@index([instanceId, stepNumber])
  @@index([approverId])
}

model ScheduledTask {
  id           String    @id @default(cuid())
  name         String
  description  String?
  taskType     String    // report, cleanup, sync, notification
  schedule     String    // Cron expression
  timezone     String    @default("America/Los_Angeles")
  config       String?   // JSON: Task-specific config
  isActive     Boolean   @default(true)
  lastRunAt    DateTime?
  lastStatus   String?
  nextRunAt    DateTime?
  failureCount Int       @default(0)
  createdBy    String
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  runs TaskRun[]

  @@index([isActive, nextRunAt])
}

model TaskRun {
  id          String    @id @default(cuid())
  taskId      String
  status      String    @default("running") // running, completed, failed
  output      String?   // JSON
  error       String?
  startedAt   DateTime  @default(now())
  completedAt DateTime?
  duration    Int?

  task ScheduledTask @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@index([taskId, startedAt])
}

model BusinessRule {
  id          String   @id @default(cuid())
  name        String
  description String?
  category    String   // validation, pricing, eligibility, routing
  entityType  String?  // Entity this rule applies to
  conditions  String   // JSON: Rule conditions
  actions     String   // JSON: Actions when matched
  priority    Int      @default(0) // Higher = evaluated first
  isActive    Boolean  @default(true)
  testMode    Boolean  @default(false) // Log but don't execute
  createdBy   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  evaluations RuleEvaluation[]

  @@index([category, isActive])
  @@index([entityType, isActive])
}

model RuleEvaluation {
  id          String   @id @default(cuid())
  ruleId      String
  entityType  String
  entityId    String
  matched     Boolean
  result      String?  // JSON
  evaluatedAt DateTime @default(now())

  rule BusinessRule @relation(fields: [ruleId], references: [id], onDelete: Cascade)

  @@index([ruleId, evaluatedAt])
  @@index([entityType, entityId])
}

model BulkOperation {
  id             String    @id @default(cuid())
  type           String    // update, delete, export, import
  entityType     String
  criteria       String?   // JSON: Selection criteria
  entityIds      String    // JSON array of IDs
  action         String    // JSON: What to do
  totalCount     Int
  processedCount Int       @default(0)
  successCount   Int       @default(0)
  failureCount   Int       @default(0)
  status         String    @default("pending") // pending, running, completed, failed, cancelled
  errors         String?   // JSON
  createdBy      String
  startedAt      DateTime?
  completedAt    DateTime?
  createdAt      DateTime  @default(now())

  @@index([status])
  @@index([createdBy])
}

model WorkQueue {
  id             String   @id @default(cuid())
  name           String   @unique
  description    String?
  entityType     String   // What items are queued
  assignmentType String   @default("manual") // manual, round_robin, load_balanced
  assignees      String   // JSON array of user IDs
  priority       Int      @default(0)
  slaMinutes     Int?     // Time to process
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  items QueueItem[]

  @@index([isActive])
}

model QueueItem {
  id          String    @id @default(cuid())
  queueId     String
  entityType  String
  entityId    String
  priority    Int       @default(0)
  assignedTo  String?
  status      String    @default("pending") // pending, assigned, in_progress, completed
  dueAt       DateTime?
  assignedAt  DateTime?
  startedAt   DateTime?
  completedAt DateTime?
  metadata    String?   // JSON
  createdAt   DateTime  @default(now())

  queue WorkQueue @relation(fields: [queueId], references: [id], onDelete: Cascade)

  @@index([queueId, status, priority])
  @@index([assignedTo, status])
}

