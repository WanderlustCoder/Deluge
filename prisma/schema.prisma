generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id                 String   @id @default(cuid())
  email              String   @unique
  name               String
  passwordHash       String
  accountType        String   @default("user")
  creditTier         Int      @default(1)
  creditLimit        Float    @default(100)
  lastTierUpdate     DateTime?
  onboardingComplete Boolean  @default(false)
  interests          String?   // Comma-separated interest tags
  lastLoginAt        DateTime?
  archivedAt         DateTime?
  profileVisibility  String   @default("private") // private, community, public
  bio                String?
  avatarUrl          String?
  followerCount      Int      @default(0)
  followingCount     Int      @default(0)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  watershed          Watershed?
  allocations        Allocation[]
  adViews            AdView[]
  contributions      Contribution[]
  borrowerLoans      Loan[]      @relation("BorrowerLoans")
  fundedShares       LoanShare[] @relation("FunderShares")
  referrals          Referral[]  @relation("Referrals")
  referredBy         Referral?   @relation("ReferredBy")
  badges             UserBadge[]
  streaks            Streak[]
  communities        CommunityMember[]
  createdCommunities Community[] @relation("CreatedCommunities")
  adPreference       AdPreference?
  notifications      Notification[]
  discussions        Discussion[]
  comments           Comment[]
  projectVotes       ProjectVote[]
  tierHistory        LoanTierHistory[]
  roles              UserRole[]
  sponsorships           LoanSponsorship[] @relation("SponsorShips")
  aquiferContributions   AquiferContribution[]
  flagshipVotes          FlagshipVote[]
  flagshipSponsors       FlagshipSponsor[]
  loanQuestions          LoanQuestion[]    @relation("LoanQuestionsAsked")
  businessListings          BusinessListing[]
  businessViews             BusinessView[]    @relation("BusinessViews")
  savedBusinesses           SavedBusiness[]   @relation("SavedBusinesses")
  businessRecommendations   BusinessRecommendation[] @relation("BusinessRecommendations")
  grantVolunteering         CommunityGrantVolunteer[] @relation("GrantVolunteers")
  notificationPreference    NotificationPreference?
  proposals                 ProjectProposal[] @relation("ProposedProjects")
  deadlineExtensions        LoanDeadlineExtension[] @relation("DeadlineExtensions")
  projectFollows            ProjectFollow[]
  ralliesCreated            Rally[]             @relation("RalliesCreated")
  rallyParticipations       RallyParticipant[]  @relation("RallyParticipations")
  following                 UserFollow[]        @relation("Following")
  followers                 UserFollow[]        @relation("Followers")
  communityFollows          CommunityFollow[]   @relation("CommunityFollows")
  feedItems                 FeedItem[]          @relation("FeedItems")
  mentionedIn               DiscussionMention[] @relation("DiscussionMentions")
  badgeProgress             BadgeProgress[]
  pushSubscriptions         PushSubscription[]
  familyMembership          FamilyMember?
  receipts                  ContributionReceipt[]
  annualSummaries           AnnualGivingSummary[]
  recurringContributions    RecurringContribution[]
  projectSubscriptions      ProjectSubscription[]
  communitySubscriptions    CommunitySubscription[]
  givingGoals               PersonalGivingGoal[]
  volunteerSignups          VolunteerSignup[]
  volunteerLogs             VolunteerLog[]
  skills                    UserSkill[]
  inKindDonations           InKindDonation[]
  totalVerifiedHours        Float     @default(0)
  corporateEmployee         CorporateEmployee?
  circleMemberships         CircleMember[]
  giftContributions         GiftContribution[]
  birthdayFundraisers       BirthdayFundraiser[]
  scheduledGifts            ScheduledGift[]
  creditReportingConsents   CreditReportingConsent[]
  creditDisputes            CreditDispute[]
  advocateProfile           CommunityAdvocate?
  advocateInterest          AdvocateInterest?
  identityVerifications     IdentityVerification[]
  auditorProfile            Auditor?
  apiKeys                   ApiKey[]
  webhooks                  Webhook[]
  oauthApps                 OAuthApp[]
  oauthAuthorizations       OAuthAuthorization[]
  // Plan 20: Smart Discovery
  interestProfile           UserInterestProfile?
  digestPreferences         DigestPreferences?
  discoveryChallenges       DiscoveryChallenge[]
}

model Watershed {
  id               String   @id @default(cuid())
  userId           String   @unique
  balance          Float    @default(0)
  totalInflow      Float    @default(0)
  totalOutflow     Float    @default(0)
  floatContributed Float    @default(0) // Cumulative float interest attributed to this watershed
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  user         User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions WatershedTransaction[]
  familyShared Family[]
}

model WatershedTransaction {
  id           String   @id @default(cuid())
  watershedId  String
  type         String // ad_credit, cash_contribution, project_allocation
  amount       Float
  description  String?
  balanceAfter Float
  createdAt    DateTime @default(now())

  watershed Watershed @relation(fields: [watershedId], references: [id], onDelete: Cascade)
}

model Project {
  id                 String   @id @default(cuid())
  title              String
  description        String
  category           String
  fundingGoal        Float
  fundingRaised      Float    @default(0)
  backerCount        Int      @default(0)
  status             String   @default("active") // active, funded, completed
  location           String
  imageUrl           String?
  isFlagship         Boolean  @default(false)
  disbursedAmount    Float    @default(0)
  disbursementStatus String   @default("none") // "none" | "partial" | "disbursed"
  completedAt        DateTime?
  impactSummary      String?
  // Tax info
  taxDeductible      Boolean  @default(false)
  ein                String?  // Employer Identification Number
  orgName            String?  // Legal organization name
  orgType            String?  // 501c3, 501c4, government, etc.
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  allocations    Allocation[]
  communities    CommunityProject[]
  votes          ProjectVote[]
  flagship       FlagshipProject?
  disbursements  ProjectDisbursement[]
  updates        ProjectUpdate[]
  grant          CommunityGrant?
  proposal       ProjectProposal?
  impactMetrics  ImpactMetric[]
  followers      ProjectFollow[]
  rallies               Rally[]
  shareEvents           ShareEvent[]
  momentumScore         Float     @default(0)
  momentumUpdatedAt     DateTime?
  cascadeSponsorEvents  CascadeSponsorEvent[]
  subscriptions         ProjectSubscription[]
  volunteerOpportunities VolunteerOpportunity[]
  inKindDonations        InKindDonation[]
  needs                  ProjectNeed[]
  birthdayFundraisers    BirthdayFundraiser[]
  verification           ProjectVerification?
  outcomeVerifications   OutcomeVerification[]
  flags                  ProjectFlag[]
}

model Allocation {
  id             String    @id @default(cuid())
  userId         String
  projectId      String
  amount         Float
  status         String    @default("pledged") // "pledged" | "disbursed"
  disbursedAt    DateTime?
  disbursementId String?
  createdAt      DateTime  @default(now())

  user         User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  project      Project              @relation(fields: [projectId], references: [id], onDelete: Cascade)
  disbursement ProjectDisbursement? @relation(fields: [disbursementId], references: [id], onDelete: SetNull)

  @@index([status])
}

model AdView {
  id               String   @id @default(cuid())
  userId           String
  grossRevenue     Float
  platformCut      Float
  watershedCredit  Float
  completionRate   Float    @default(1.0)
  provider         String   @default("demo")
  format           String   @default("video")
  adUnitId         String?
  eCPM             Float?
  impressionId     String?
  settlementId     String?
  settlementStatus String   @default("pending") // "pending" | "cleared"
  createdAt        DateTime @default(now())

  user       User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  settlement RevenueSettlement? @relation(fields: [settlementId], references: [id], onDelete: SetNull)

  @@index([settlementStatus])
}

model Contribution {
  id              String   @id @default(cuid())
  userId          String
  amount          Float
  type            String // cash, simulated
  watershedCredit Float
  createdAt       DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Loan {
  id              String   @id @default(cuid())
  borrowerId      String
  amount          Float
  totalShares     Int
  sharesRemaining Int
  purpose         String
  purposeCategory String
  story           String?
  location        String
  status          String   @default("funding") // funding, active, repaying, completed, defaulted, expired, recovering
  tier            Int      @default(1)
  latePayments    Int      @default(0)
  fundingDeadline DateTime
  repaymentMonths Int
  monthlyPayment  Float
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  seekingSponsor    Boolean  @default(false)
  sponsorshipAmount Float    @default(0)

  // Default/recovery tracking
  recoveryStartedAt DateTime?
  defaultedAt       DateTime?
  recoveryPayments  Int       @default(0) // Consecutive on-time payments during recovery

  borrower           User                    @relation("BorrowerLoans", fields: [borrowerId], references: [id])
  shares             LoanShare[]
  repayments         LoanRepayment[]
  sponsorships       LoanSponsorship[]
  stretchGoals       LoanStretchGoal[]
  questions          LoanQuestion[]
  goalVerification   GoalVerification?
  refinances         LoanRefinance[]
  deadlineExtensions LoanDeadlineExtension[]
  creditReportingConsent CreditReportingConsent?
  creditReportingStatus  CreditReportingStatus?
  metro2Records          Metro2Record[]
  creditDisputes         CreditDispute[]
}

model LoanStretchGoal {
  id        String   @id @default(cuid())
  loanId    String
  priority  Int      // 1, 2, or 3
  amount    Float
  purpose   String
  funded    Boolean  @default(false)
  createdAt DateTime @default(now())

  loan Loan @relation(fields: [loanId], references: [id], onDelete: Cascade)

  @@unique([loanId, priority])
}

model LoanQuestion {
  id         String    @id @default(cuid())
  loanId     String
  askerId    String
  question   String    // max 280 chars
  answer     String?
  answeredAt DateTime?
  flagCount  Int       @default(0)
  hidden     Boolean   @default(false)
  createdAt  DateTime  @default(now())

  loan  Loan @relation(fields: [loanId], references: [id], onDelete: Cascade)
  asker User @relation("LoanQuestionsAsked", fields: [askerId], references: [id])

  @@index([loanId])
}

model GoalVerification {
  id          String   @id @default(cuid())
  loanId      String   @unique
  photoUrls   String   // JSON array of URLs
  receiptUrls String?  // JSON array of URLs
  description String?
  status      String   @default("pending") // pending, approved, flagged
  flagCount   Int      @default(0)
  submittedAt DateTime @default(now())

  loan Loan @relation(fields: [loanId], references: [id], onDelete: Cascade)
}

model LoanRefinance {
  id              String   @id @default(cuid())
  loanId          String
  previousPayment Float
  newPayment      Float
  previousTerm    Int
  newTerm         Int
  fee             Float
  reason          String?
  createdAt       DateTime @default(now())

  loan Loan @relation(fields: [loanId], references: [id], onDelete: Cascade)
}

model LoanDeadlineExtension {
  id            String   @id @default(cuid())
  loanId        String
  sponsorId     String
  extensionDays Int
  extendedAt    DateTime @default(now())

  loan    Loan @relation(fields: [loanId], references: [id], onDelete: Cascade)
  sponsor User @relation("DeadlineExtensions", fields: [sponsorId], references: [id])

  @@index([loanId])
}

model LoanShare {
  id        String   @id @default(cuid())
  loanId    String
  funderId  String
  count     Int
  amount    Float
  repaid    Float    @default(0)
  createdAt DateTime @default(now())

  loan   Loan @relation(fields: [loanId], references: [id], onDelete: Cascade)
  funder User @relation("FunderShares", fields: [funderId], references: [id])
}

model LoanRepayment {
  id            String   @id @default(cuid())
  loanId        String
  amount        Float
  principalPaid Float
  servicingFee  Float
  createdAt     DateTime @default(now())

  loan Loan @relation(fields: [loanId], references: [id], onDelete: Cascade)
}

model LoanTierHistory {
  id        String   @id @default(cuid())
  userId    String
  fromTier  Int
  toTier    Int
  reason    String
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Referral {
  id                  String    @id @default(cuid())
  referrerId          String
  referredId          String?   @unique
  code                String    @unique
  status              String    @default("pending") // pending, signed_up, activated, expired
  signupCredit        Float     @default(0)
  actionCredit        Float     @default(0)
  retentionCredit     Float     @default(0)
  retentionCheckedAt  DateTime?
  createdAt           DateTime  @default(now())
  activatedAt         DateTime?

  referrer User  @relation("Referrals", fields: [referrerId], references: [id])
  referred User? @relation("ReferredBy", fields: [referredId], references: [id])
}

model Badge {
  id          String @id @default(cuid())
  key         String @unique
  name        String
  description String
  tier        String
  icon        String
  createdAt   DateTime @default(now())

  userBadges UserBadge[]
}

model UserBadge {
  id       String   @id @default(cuid())
  userId   String
  badgeId  String
  earnedAt DateTime @default(now())
  featured Boolean  @default(false) // Show on profile

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  badge Badge @relation(fields: [badgeId], references: [id], onDelete: Cascade)

  @@unique([userId, badgeId])
  @@index([userId])
}

model BadgeProgress {
  id           String   @id @default(cuid())
  userId       String
  badgeKey     String   // Badge key (e.g., "projects_10")
  currentValue Float    @default(0)
  targetValue  Float
  updatedAt    DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, badgeKey])
  @@index([userId])
}

model Streak {
  id              String    @id @default(cuid())
  userId          String
  type            String
  currentDays     Int       @default(0)
  longestDays     Int       @default(0)
  lastActiveDate  DateTime?
  gracePeriodUsed Boolean   @default(false)
  graceExpiresAt  DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, type])
}

model Community {
  id           String   @id @default(cuid())
  name         String
  description  String
  location     String?
  category     String?
  imageUrl     String?
  createdBy    String
  memberCount  Int      @default(1)
  followerCount Int     @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Type: geographic (uses hierarchy) or interest (flat, no hierarchy)
  type        String   @default("geographic")

  // Hierarchy (geographic communities only)
  parentId    String?
  level       String?  // country, state, county, city, district, neighborhood (null for interest)
  slug        String?  @unique // url-friendly: "usa/idaho/ada-county/boise"

  // Geographic coordinates
  latitude    Float?
  longitude   Float?
  bounds      String?  // GeoJSON polygon for map rendering (JSON string)

  // Relations
  creator     User              @relation("CreatedCommunities", fields: [createdBy], references: [id])
  members     CommunityMember[]
  projects    CommunityProject[]
  discussions Discussion[]
  votes       ProjectVote[]    @relation("CommunityVotes")
  elections   CommunityElection[]

  // Hierarchy relations
  parent      Community?  @relation("CommunityHierarchy", fields: [parentId], references: [id])
  children    Community[] @relation("CommunityHierarchy")

  // Community Enhancement Features
  goals              CommunityGoal[]
  milestones         CommunityMilestone[]
  events             CommunityEvent[]
  flagshipNominations FlagshipProject[]
  followers          CommunityFollow[] @relation("CommunityFollowers")
  subscriptions      CommunitySubscription[]

  @@index([parentId])
  @@index([level])
  @@index([type])
}

model CommunityMember {
  id          String   @id @default(cuid())
  communityId String
  userId      String
  role        String   @default("member") // member, admin
  joinedAt    DateTime @default(now())

  community Community @relation(fields: [communityId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([communityId, userId])
}

model CommunityProject {
  id          String   @id @default(cuid())
  communityId String
  projectId   String
  addedBy     String
  createdAt   DateTime @default(now())

  community Community @relation(fields: [communityId], references: [id], onDelete: Cascade)
  project   Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([communityId, projectId])
}

// --- Notifications System (Plan 22) ---
model Notification {
  id        String   @id @default(cuid())
  userId    String
  type      String   // loan_funded, loan_payment_received, badge_earned, project_milestone, referral_signup, referral_activated
  title     String
  message   String
  data      String?  // JSON string for navigation/context data
  read      Boolean  @default(false)
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, read])
}

// --- Voting & Discussions (Plan 21) ---
model Discussion {
  id          String   @id @default(cuid())
  communityId String
  userId      String
  title       String
  body        String
  parentId    String?  // For threaded replies
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  community Community @relation(fields: [communityId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  comments  Comment[]
  parent    Discussion?  @relation("DiscussionReplies", fields: [parentId], references: [id])
  replies   Discussion[] @relation("DiscussionReplies")
  mentions  DiscussionMention[]

  @@index([parentId])
}

model Comment {
  id           String   @id @default(cuid())
  discussionId String
  userId       String
  body         String
  createdAt    DateTime @default(now())

  discussion Discussion @relation(fields: [discussionId], references: [id], onDelete: Cascade)
  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model ProjectVote {
  id          String @id @default(cuid())
  communityId String
  projectId   String
  userId      String
  vote        Int    // 1 = up, -1 = down

  community Community @relation("CommunityVotes", fields: [communityId], references: [id], onDelete: Cascade)
  project   Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([communityId, projectId, userId])
}

model AdPreference {
  id                String   @id @default(cuid())
  userId            String   @unique
  blockedCategories String   @default("") // comma-separated category keys
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model AuditLog {
  id         String   @id @default(cuid())
  adminId    String
  adminEmail String
  action     String
  targetType String?
  targetId   String?
  details    String?
  createdAt  DateTime @default(now())

  @@index([adminId])
  @@index([action])
  @@index([createdAt])
}

// --- Admin Invites (Phase 2) ---
model AdminInvite {
  id         String    @id @default(cuid())
  email      String    @unique
  invitedBy  String
  token      String    @unique
  status     String    @default("pending") // pending, accepted, expired
  expiresAt  DateTime
  acceptedAt DateTime?
  createdAt  DateTime  @default(now())

  @@index([token])
  @@index([email])
}

// --- Platform Roles (Phase 3) ---
model UserRole {
  id        String    @id @default(cuid())
  userId    String
  role      String    // verified_giver, sponsor, trusted_borrower, mentor
  grantedAt DateTime  @default(now())
  revokedAt DateTime?
  isActive  Boolean   @default(true)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, role])
  @@index([role])
}

model RoleConfig {
  id          String   @id @default(cuid())
  role        String   @unique // verified_giver, sponsor, trusted_borrower, mentor
  displayName String
  description String
  thresholds  String   // JSON string: configurable criteria
  isAutomatic Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// --- Loan Sponsorship (Phase 5) ---
model LoanSponsorship {
  id        String   @id @default(cuid())
  loanId    String
  sponsorId String
  amount    Float
  message   String?
  status    String   @default("active") // active, withdrawn
  createdAt DateTime @default(now())

  loan    Loan @relation(fields: [loanId], references: [id], onDelete: Cascade)
  sponsor User @relation("SponsorShips", fields: [sponsorId], references: [id])

  @@unique([loanId, sponsorId])
}

// --- Community Elections (Phase 6) ---
model CommunityElection {
  id            String   @id @default(cuid())
  communityId   String
  role          String   // steward, steward:projects, steward:finance, steward:membership, champion
  status        String   @default("nominating") // nominating, voting, completed, cancelled
  nominationEnd DateTime
  votingEnd     DateTime
  termEnd       DateTime
  winnerId      String?
  createdAt     DateTime @default(now())

  community   Community             @relation(fields: [communityId], references: [id], onDelete: Cascade)
  nominations ElectionNomination[]
  votes       ElectionVote[]

  @@index([communityId, status])
}

model ElectionNomination {
  id          String   @id @default(cuid())
  electionId  String
  nomineeId   String
  nominatedBy String
  createdAt   DateTime @default(now())

  election CommunityElection @relation(fields: [electionId], references: [id], onDelete: Cascade)

  @@unique([electionId, nomineeId])
}

model ElectionVote {
  id         String   @id @default(cuid())
  electionId String
  voterId    String
  nomineeId  String
  createdAt  DateTime @default(now())

  election CommunityElection @relation(fields: [electionId], references: [id], onDelete: Cascade)

  @@unique([electionId, voterId])
}

// --- Aquifer System ---
model StrategicPlan {
  id          String   @id @default(cuid())
  title       String
  description String
  vision      String   // Long-form explanation of what we're building and why
  fundingGoal Float
  status      String   @default("active") // active, funded, completed, archived
  order       Int      @default(0) // For queuing next plans
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  flagships FlagshipProject[]
}

model Aquifer {
  id        String   @id @default(cuid())
  type      String   @unique // "reserve" or "pool"
  balance   Float    @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  contributions AquiferContribution[]
}

model AquiferContribution {
  id         String   @id @default(cuid())
  aquiferId  String
  userId     String?  // null if Deluge contribution
  amount     Float
  isDeluge   Boolean  @default(false)
  note       String?
  createdAt  DateTime @default(now())

  aquifer Aquifer @relation(fields: [aquiferId], references: [id], onDelete: Cascade)
  user    User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([aquiferId])
}

model FlagshipProject {
  id                    String    @id @default(cuid())
  projectId             String    @unique
  strategicPlanId       String?   // Required for reserve-funded, null for pool-funded
  nominatingCommunityId String?   // Community that nominated this for Aquifer (Phase 7)
  status                String    @default("active") // active, voting, funded, tabled, rejected
  fundingSource         String    @default("reserve") // reserve, pool
  votingEndsAt          DateTime?
  tabledAt              DateTime?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  project             Project          @relation(fields: [projectId], references: [id], onDelete: Cascade)
  strategicPlan       StrategicPlan?   @relation(fields: [strategicPlanId], references: [id], onDelete: SetNull)
  nominatingCommunity Community?       @relation(fields: [nominatingCommunityId], references: [id], onDelete: SetNull)
  votes               FlagshipVote[]
  sponsors            FlagshipSponsor[]

  @@index([strategicPlanId])
  @@index([nominatingCommunityId])
}

model FlagshipVote {
  id                String   @id @default(cuid())
  flagshipProjectId String
  userId            String
  vote              String   // approve, reject, table
  createdAt         DateTime @default(now())

  flagshipProject FlagshipProject @relation(fields: [flagshipProjectId], references: [id], onDelete: Cascade)
  user            User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([flagshipProjectId, userId])
}

model FlagshipSponsor {
  id                String   @id @default(cuid())
  flagshipProjectId String
  userId            String
  createdAt         DateTime @default(now())

  flagshipProject FlagshipProject @relation(fields: [flagshipProjectId], references: [id], onDelete: Cascade)
  user            User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([flagshipProjectId, userId])
}

// --- Revenue Settlement & Reserve System ---

model RevenueSettlement {
  id                    String    @id @default(cuid())
  batchDate             DateTime  @default(now())
  totalGross            Float
  totalPlatformCut      Float
  totalWatershedCredit  Float
  adViewCount           Int
  status                String    @default("pending") // "pending" | "cleared"
  netTermDays           Int       @default(30)
  expectedClearDate     DateTime
  clearedAt             DateTime?
  providerRef           String?
  notes                 String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  adViews AdView[]

  @@index([status])
}

model PlatformReserve {
  id               String   @id @default(cuid())
  balance          Float    @default(0)
  totalInflow      Float    @default(0)
  totalOutflow     Float    @default(0)
  totalReplenished Float    @default(0)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  transactions ReserveTransaction[]
}

model ReserveTransaction {
  id            String   @id @default(cuid())
  reserveId     String
  type          String   // "platform_cut_accrual" | "disbursement_fronted" | "revenue_cleared" | "manual_adjustment"
  amount        Float
  balanceAfter  Float
  referenceType String?  // "settlement" | "disbursement" | null
  referenceId   String?
  description   String?
  createdAt     DateTime @default(now())

  reserve PlatformReserve @relation(fields: [reserveId], references: [id], onDelete: Cascade)

  @@index([reserveId])
  @@index([type])
}

model ProjectDisbursement {
  id          String    @id @default(cuid())
  projectId   String
  amount      Float
  source      String    // "reserve_fronted" | "cleared_revenue" | "direct"
  status      String    @default("pending") // "pending" | "processing" | "completed" | "failed"
  initiatedBy String?
  paymentRef  String?
  notes       String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  project     Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  allocations Allocation[]

  @@index([projectId])
  @@index([status])
}

// --- Project Updates ---
model ProjectUpdate {
  id        String   @id @default(cuid())
  projectId String
  type      String   @default("text") // text, photo, milestone, completion
  title     String
  body      String
  imageUrls String?  // JSON array
  createdAt DateTime @default(now())

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId, createdAt])
}

model ImpactMetric {
  id         String   @id @default(cuid())
  projectId  String
  name       String   // e.g., "Students Served", "Trees Planted"
  value      Float
  unit       String   // e.g., "students", "trees"
  reportedAt DateTime @default(now())

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
}

model ProjectFollow {
  id        String   @id @default(cuid())
  userId    String
  projectId String
  createdAt DateTime @default(now())

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([userId, projectId])
}

model Rally {
  id          String   @id @default(cuid())
  projectId   String
  creatorId   String
  title       String   // "Let's get 50 backers by Friday!"
  targetType  String   // "backers" or "amount"
  targetValue Float    // 50 backers or $500
  deadline    DateTime
  status      String   @default("active") // active, succeeded, failed
  createdAt   DateTime @default(now())

  project      Project            @relation(fields: [projectId], references: [id], onDelete: Cascade)
  creator      User               @relation("RalliesCreated", fields: [creatorId], references: [id])
  participants RallyParticipant[]

  @@index([projectId, status])
  @@index([deadline])
}

model RallyParticipant {
  id       String   @id @default(cuid())
  rallyId  String
  userId   String
  joinedAt DateTime @default(now())

  rally Rally @relation(fields: [rallyId], references: [id], onDelete: Cascade)
  user  User  @relation("RallyParticipations", fields: [userId], references: [id])

  @@unique([rallyId, userId])
}

model ShareEvent {
  id        String   @id @default(cuid())
  projectId String
  userId    String?  // null for anonymous shares
  platform  String   // twitter, facebook, email, copy, other
  createdAt DateTime @default(now())

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId, createdAt])
}

// --- Activity Feed ---
model ActivityFeedItem {
  id          String   @id @default(cuid())
  type        String   // cascade, loan_funded, milestone, community_join
  actorId     String?
  subjectType String   // project, loan, community
  subjectId   String
  metadata    String?  // JSON
  isPublic    Boolean  @default(true)
  createdAt   DateTime @default(now())

  @@index([subjectType, subjectId])
  @@index([createdAt])
}

// --- Notification Preferences ---
model NotificationPreference {
  id            String  @id @default(cuid())
  userId        String  @unique
  cascades      String  @default("all") // all, push, in_app, none
  loanUpdates   String  @default("all")
  referrals     String  @default("all")
  communityNews String  @default("in_app")
  weeklyDigest  Boolean @default(true)
  pushToken     String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// --- Business Card Directory ---
model BusinessListing {
  id          String   @id @default(cuid())
  ownerId     String
  name        String
  category    String
  description String   // max 50 words
  location    String
  address     String?
  latitude    Float?
  longitude   Float?
  phone       String?
  website     String?
  imageUrl    String?
  tier        String   @default("basic") // basic, enhanced
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  owner           User           @relation(fields: [ownerId], references: [id])
  views           BusinessView[]
  saves           SavedBusiness[]
  recommendations BusinessRecommendation[]
  cascadeSponsors     CascadeSponsor[]
  notificationSponsors NotificationSponsor[]

  @@index([category])
  @@index([location])
}

model BusinessView {
  id          String   @id @default(cuid())
  listingId   String
  viewerId    String
  revenue     Float    // ~$0.001-0.003
  platformCut Float
  projectId   String?  // Where revenue flows (optional)
  createdAt   DateTime @default(now())

  listing BusinessListing @relation(fields: [listingId], references: [id], onDelete: Cascade)
  viewer  User            @relation("BusinessViews", fields: [viewerId], references: [id])

  @@index([listingId])
  @@index([viewerId, createdAt])
}

model SavedBusiness {
  id        String   @id @default(cuid())
  userId    String
  listingId String
  savedAt   DateTime @default(now())

  user    User            @relation("SavedBusinesses", fields: [userId], references: [id], onDelete: Cascade)
  listing BusinessListing @relation(fields: [listingId], references: [id], onDelete: Cascade)

  @@unique([userId, listingId])
}

model BusinessRecommendation {
  id        String   @id @default(cuid())
  userId    String
  listingId String
  note      String
  createdAt DateTime @default(now())

  user    User            @relation("BusinessRecommendations", fields: [userId], references: [id], onDelete: Cascade)
  listing BusinessListing @relation(fields: [listingId], references: [id], onDelete: Cascade)

  @@unique([userId, listingId])
}

// --- Corporate Matching Campaigns ---
model MatchingCampaign {
  id              String    @id @default(cuid())
  name            String
  corporateName   String
  description     String
  logoUrl         String?
  matchRatio      Float     @default(1.0) // 2x = 2.0, 3x = 3.0
  totalBudget     Float
  remainingBudget Float
  targetType      String    // all, category, project
  targetValue     String?   // category name or project ID
  startsAt        DateTime
  endsAt          DateTime
  status          String    @default("active") // draft, active, paused, completed
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  matches         MatchingContribution[]
  cascadeSponsors CascadeSponsor[]
}

model MatchingContribution {
  id          String   @id @default(cuid())
  campaignId  String
  userId      String
  projectId   String
  userAmount  Float
  matchAmount Float
  createdAt   DateTime @default(now())

  campaign MatchingCampaign @relation(fields: [campaignId], references: [id])
}

// --- Community Grants ---
model CommunityGrant {
  id             String    @id @default(cuid())
  projectId      String    @unique
  volunteerSlots Int
  watershedCredit Float    // Credit per volunteer
  requirements   String    // What volunteers need to do
  beforePhotos   String?   // JSON array
  afterPhotos    String?   // JSON array
  completedAt    DateTime?
  createdAt      DateTime  @default(now())

  project    Project                   @relation(fields: [projectId], references: [id])
  volunteers CommunityGrantVolunteer[]
}

model CommunityGrantVolunteer {
  id          String    @id @default(cuid())
  grantId     String
  userId      String
  status      String    @default("claimed") // claimed, completed, verified, cancelled
  completedAt DateTime?
  verifiedAt  DateTime?
  createdAt   DateTime  @default(now())

  grant CommunityGrant @relation(fields: [grantId], references: [id], onDelete: Cascade)
  user  User           @relation("GrantVolunteers", fields: [userId], references: [id])

  @@unique([grantId, userId])
}

// --- Community Enhancement Features ---

// Community Goals/Campaigns (Phase 2)
model CommunityGoal {
  id            String   @id @default(cuid())
  communityId   String
  title         String
  description   String
  targetAmount  Float
  currentAmount Float    @default(0)
  deadline      DateTime
  status        String   @default("active") // active, completed, expired
  category      String?
  createdBy     String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  community Community @relation(fields: [communityId], references: [id], onDelete: Cascade)

  @@index([communityId, status])
}

// Community Milestones (Phase 4)
model CommunityMilestone {
  id          String   @id @default(cuid())
  communityId String
  type        String   // funding_1k, funding_5k, members_100, projects_10
  reachedAt   DateTime @default(now())

  community Community @relation(fields: [communityId], references: [id], onDelete: Cascade)

  @@unique([communityId, type])
}

// Community Events (Phase 5)
model CommunityEvent {
  id           String    @id @default(cuid())
  communityId  String
  title        String
  description  String
  date         DateTime
  endDate      DateTime?
  location     String?
  type         String    // meetup, volunteer, celebration, launch
  createdBy    String
  createdAt    DateTime  @default(now())

  community Community   @relation(fields: [communityId], references: [id], onDelete: Cascade)
  rsvps     EventRSVP[]

  @@index([communityId, date])
}

model EventRSVP {
  id        String   @id @default(cuid())
  eventId   String
  userId    String
  status    String   @default("attending") // attending, maybe, declined
  createdAt DateTime @default(now())

  event CommunityEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@unique([eventId, userId])
}

// Community Challenges (Phase 8)
model CommunityChallenge {
  id          String   @id @default(cuid())
  title       String
  description String
  startDate   DateTime
  endDate     DateTime
  category    String?
  metric      String   // funding_amount, projects_funded
  status      String   @default("active") // draft, active, completed
  createdBy   String
  createdAt   DateTime @default(now())

  entries ChallengeEntry[]

  @@index([status, startDate])
}

model ChallengeEntry {
  id           String   @id @default(cuid())
  challengeId  String
  communityId  String
  currentValue Float    @default(0)
  updatedAt    DateTime @updatedAt

  challenge CommunityChallenge @relation(fields: [challengeId], references: [id], onDelete: Cascade)

  @@unique([challengeId, communityId])
}

// --- Project Proposals (Plan 1) ---
model ProjectProposal {
  id             String    @id @default(cuid())
  proposerId     String
  title          String
  description    String
  fundingGoal    Float
  deadline       DateTime
  category       String
  location       String
  imageUrl       String?
  gallery        String?   // JSON array of URLs

  // Organization info
  orgName        String
  orgType        String    // nonprofit, school, community_org, small_business, individual
  ein            String?   // if nonprofit
  verificationDocs String? // JSON array of URLs

  // Impact plan
  fundsCover     String    // What the funds will cover
  successMetrics String    // How success will be measured
  reportingPlan  String    // Commitment to reporting

  // Review workflow
  status         String    @default("draft") // draft, submitted, in_review, approved, rejected
  reviewerNotes  String?
  reviewedBy     String?
  reviewedAt     DateTime?

  // Converted project (after approval)
  projectId      String?   @unique

  submittedAt    DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  proposer User     @relation("ProposedProjects", fields: [proposerId], references: [id], onDelete: Cascade)
  project  Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)

  @@index([proposerId])
  @@index([status])
}

// --- Social Features (Plan 4) ---

model UserFollow {
  id         String   @id @default(cuid())
  followerId String
  followeeId String
  createdAt  DateTime @default(now())

  follower User @relation("Following", fields: [followerId], references: [id], onDelete: Cascade)
  followee User @relation("Followers", fields: [followeeId], references: [id], onDelete: Cascade)

  @@unique([followerId, followeeId])
  @@index([followerId])
  @@index([followeeId])
}

model CommunityFollow {
  id          String   @id @default(cuid())
  userId      String
  communityId String
  createdAt   DateTime @default(now())

  user      User      @relation("CommunityFollows", fields: [userId], references: [id], onDelete: Cascade)
  community Community @relation("CommunityFollowers", fields: [communityId], references: [id], onDelete: Cascade)

  @@unique([userId, communityId])
  @@index([userId])
  @@index([communityId])
}

model FeedItem {
  id          String   @id @default(cuid())
  userId      String   // Who this feed item is for

  // Activity details
  actorId     String?  // Who did the action (null for system)
  actionType  String   // funded, cascaded, posted_update, joined, proposed, rally_created, loan_funded, milestone

  // Target references
  projectId   String?
  communityId String?
  loanId      String?
  updateId    String?

  // Denormalized for fast display
  title       String
  description String?

  read        Boolean  @default(false)
  createdAt   DateTime @default(now())

  user User @relation("FeedItems", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([userId, read])
}

model DiscussionMention {
  id           String   @id @default(cuid())
  discussionId String
  userId       String
  createdAt    DateTime @default(now())

  discussion Discussion @relation(fields: [discussionId], references: [id], onDelete: Cascade)
  user       User       @relation("DiscussionMentions", fields: [userId], references: [id])

  @@unique([discussionId, userId])
}

// --- Sponsorship & Push Notifications (Plan 6) ---

model CascadeSponsor {
  id            String    @id @default(cuid())

  // Sponsor details
  sponsorType   String    // business, corporate, matching_campaign
  businessId    String?
  campaignId    String?
  corporateName String?

  // Sponsorship configuration
  tier          String    // basic ($100), featured ($250), premium ($500)
  logoUrl       String?
  message       String?
  linkUrl       String?

  // Targeting (JSON arrays)
  categories    String?
  locations     String?

  // Budget & scheduling
  budgetTotal   Float
  budgetUsed    Float     @default(0)
  costPerCascade Float
  startDate     DateTime
  endDate       DateTime?

  status        String    @default("active") // active, paused, exhausted, expired
  createdAt     DateTime  @default(now())

  business      BusinessListing?  @relation(fields: [businessId], references: [id])
  campaign      MatchingCampaign? @relation(fields: [campaignId], references: [id])
  cascades      CascadeSponsorEvent[]

  @@index([status, startDate])
}

model CascadeSponsorEvent {
  id          String   @id @default(cuid())
  sponsorId   String
  projectId   String

  impressions Int      @default(0)
  clicks      Int      @default(0)

  createdAt   DateTime @default(now())

  sponsor     CascadeSponsor @relation(fields: [sponsorId], references: [id], onDelete: Cascade)
  project     Project        @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([sponsorId])
}

model NotificationSponsor {
  id            String   @id @default(cuid())
  businessId    String

  message       String
  linkUrl       String?

  // Hyperlocal targeting
  latitude      Float
  longitude     Float
  radiusMeters  Int      @default(1000)

  notificationTypes String  // JSON array

  budgetTotal   Float
  budgetUsed    Float    @default(0)
  costPerNotification Float

  status        String   @default("active")
  createdAt     DateTime @default(now())

  business      BusinessListing @relation(fields: [businessId], references: [id])
  events        NotificationSponsorEvent[]

  @@index([status])
}

model NotificationSponsorEvent {
  id          String   @id @default(cuid())
  sponsorId   String
  userId      String

  notificationType String
  delivered   Boolean  @default(false)
  clicked     Boolean  @default(false)

  createdAt   DateTime @default(now())

  sponsor     NotificationSponsor @relation(fields: [sponsorId], references: [id], onDelete: Cascade)

  @@index([sponsorId])
}

model PushSubscription {
  id          String   @id @default(cuid())
  userId      String

  endpoint    String
  p256dh      String
  auth        String

  userAgent   String?

  createdAt   DateTime @default(now())

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// --- Financial Transparency (Plan 7) ---

model FloatSnapshot {
  id              String   @id @default(cuid())
  date            DateTime @unique
  totalWatersheds Float
  totalReserve    Float
  interestRate    Float
  dailyInterest   Float
  createdAt       DateTime @default(now())

  @@index([date])
}

model RevenueRecord {
  id            String   @id @default(cuid())
  date          DateTime
  source        String   // ads, directory, float, corporate, loans, cascade_sponsor, notification_sponsor
  amount        Float
  adViewCount   Int?
  businessCount Int?
  loanVolume    Float?
  createdAt     DateTime @default(now())

  @@index([date, source])
}

model CostRecord {
  id          String   @id @default(cuid())
  date        DateTime
  category    String   // infrastructure, payment_processing, legal, marketing, staffing, other
  description String
  amount      Float
  createdAt   DateTime @default(now())

  @@index([date, category])
}

model TransparencyReport {
  id                String    @id @default(cuid())
  period            String    // "2026-Q1", "2026"
  periodType        String    // quarterly, annual
  totalRevenue      Float
  totalCosts        Float
  netMargin         Float
  revenueBreakdown  String    // JSON
  totalFunded       Float
  totalLoansIssued  Float
  totalUsersActive  Int
  pdfUrl            String?
  publishedAt       DateTime?
  createdAt         DateTime  @default(now())

  @@unique([period, periodType])
}

// --- Family Accounts (Plan 8) ---

model Family {
  id                     String   @id @default(cuid())
  name                   String
  sharedWatershedEnabled Boolean  @default(false)
  sharedWatershedId      String?
  createdAt              DateTime @default(now())

  members         FamilyMember[]
  sharedWatershed Watershed?     @relation(fields: [sharedWatershedId], references: [id])
  goals           FamilyGoal[]

  @@index([sharedWatershedId])
}

model FamilyMember {
  id                String   @id @default(cuid())
  familyId          String
  userId            String   @unique
  role              String   // admin, adult, child
  nickname          String?
  monthlyLimit      Float?
  requireApproval   Boolean  @default(false)
  allowedCategories String?  // JSON array
  joinedAt          DateTime @default(now())

  family Family @relation(fields: [familyId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([familyId])
}

model FamilyGoal {
  id           String    @id @default(cuid())
  familyId     String
  title        String
  description  String?
  targetType   String    // projects_funded, amount_given, categories_supported
  targetValue  Float
  currentValue Float     @default(0)
  deadline     DateTime?
  status       String    @default("active")
  createdAt    DateTime  @default(now())

  family Family @relation(fields: [familyId], references: [id], onDelete: Cascade)

  @@index([familyId, status])
}

model FamilyActivity {
  id          String   @id @default(cuid())
  familyId    String
  memberId    String
  actionType  String
  description String
  projectId   String?
  communityId String?
  badgeId     String?
  amount      Float?
  createdAt   DateTime @default(now())

  @@index([familyId, createdAt])
}

model PendingFamilyAction {
  id         String    @id @default(cuid())
  familyId   String
  memberId   String
  approverId String?
  actionType String
  targetId   String
  amount     Float
  status     String    @default("pending")
  note       String?
  createdAt  DateTime  @default(now())
  resolvedAt DateTime?

  @@index([familyId, status])
}

model FamilyBadge {
  id            String @id @default(cuid())
  slug          String @unique
  name          String
  description   String
  icon          String
  criteriaType  String
  criteriaValue String
}

model FamilyBadgeEarned {
  id       String   @id @default(cuid())
  familyId String
  badgeId  String
  earnedAt DateTime @default(now())

  @@unique([familyId, badgeId])
}

model FamilyInvite {
  id        String   @id @default(cuid())
  familyId  String
  email     String
  role      String   // adult, child
  token     String   @unique
  status    String   @default("pending") // pending, accepted, expired
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([token])
}

// --- Tax & Giving Documentation (Plan 10) ---

model ContributionReceipt {
  id              String    @id @default(cuid())
  userId          String
  contributionId  String?   // For cash contributions
  allocationId    String?   // For project funding
  type            String    // cash, ad_funded, referral, matching
  amount          Float
  date            DateTime
  projectName     String?
  communityName   String?
  receiptNumber   String    @unique
  downloadedAt    DateTime?
  createdAt       DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, date])
  @@index([receiptNumber])
}

model AnnualGivingSummary {
  id                    String    @id @default(cuid())
  userId                String
  year                  Int
  totalCashContributed  Float     @default(0)
  totalAdFunded         Float     @default(0)
  totalReferralCredits  Float     @default(0)
  totalMatchingReceived Float     @default(0)
  totalAllocated        Float     @default(0)
  projectsFunded        Int       @default(0)
  loansFunded           Int       @default(0)
  loansRepaid           Float     @default(0)
  communitiesSupported  Int       @default(0)
  deductibleAmount      Float     @default(0)
  nonDeductibleAmount   Float     @default(0)
  generatedAt           DateTime?
  pdfUrl                String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, year])
}

model FamilyAnnualSummary {
  id                String    @id @default(cuid())
  familyId          String
  year              Int
  totalFamilyGiving Float     @default(0)
  memberBreakdown   String    // JSON: { memberId: amount }
  projectsFunded    Int       @default(0)
  generatedAt       DateTime?
  pdfUrl            String?
  createdAt         DateTime  @default(now())

  @@unique([familyId, year])
}

// ==========================================
// PLAN 11: RECURRING GIVING & SUBSCRIPTIONS
// ==========================================

model RecurringContribution {
  id              String    @id @default(cuid())
  userId          String
  amount          Float     // Amount per charge
  frequency       String    @default("monthly") // monthly, weekly, biweekly
  nextChargeDate  DateTime
  lastChargeDate  DateTime?
  status          String    @default("active") // active, paused, cancelled
  paymentMethodId String?   // Stripe payment method ID
  failureCount    Int       @default(0)
  pausedUntil     DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  user    User                          @relation(fields: [userId], references: [id], onDelete: Cascade)
  history RecurringContributionHistory[]

  @@index([userId, status])
  @@index([nextChargeDate, status])
}

model RecurringContributionHistory {
  id                      String   @id @default(cuid())
  recurringContributionId String
  amount                  Float
  status                  String   // succeeded, failed, pending
  chargeDate              DateTime
  failureReason           String?
  contributionId          String?  // Reference to actual contribution created
  createdAt               DateTime @default(now())

  recurringContribution RecurringContribution @relation(fields: [recurringContributionId], references: [id], onDelete: Cascade)

  @@index([recurringContributionId, chargeDate])
}

model ProjectSubscription {
  id              String    @id @default(cuid())
  userId          String
  projectId       String
  amount          Float
  frequency       String    @default("monthly")
  nextChargeDate  DateTime
  lastChargeDate  DateTime?
  status          String    @default("active") // active, paused, cancelled, completed
  pausedUntil     DateTime?
  pauseReason     String?   // user_paused, project_funded, no_payment_method
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([userId, projectId])
  @@index([nextChargeDate, status])
}

model CommunitySubscription {
  id              String    @id @default(cuid())
  userId          String
  communityId     String
  amount          Float
  frequency       String    @default("monthly")
  allocationRule  String    @default("neediest") // newest, neediest, random
  nextChargeDate  DateTime
  lastChargeDate  DateTime?
  status          String    @default("active")
  pausedUntil     DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  community Community @relation(fields: [communityId], references: [id], onDelete: Cascade)

  @@unique([userId, communityId])
  @@index([nextChargeDate, status])
}

model PersonalGivingGoal {
  id            String   @id @default(cuid())
  userId        String
  targetAmount  Float
  currentAmount Float    @default(0)
  period        String   // monthly, quarterly, yearly
  periodStart   DateTime
  periodEnd     DateTime
  status        String   @default("active") // active, completed, expired
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, status])
  @@index([periodEnd, status])
}

// ==========================================
// PLAN 12: VOLUNTEER & IN-KIND CONTRIBUTIONS
// ==========================================

model VolunteerOpportunity {
  id              String    @id @default(cuid())
  projectId       String
  title           String
  description     String
  hoursNeeded     Float?    // Target hours (optional)
  hoursLogged     Float     @default(0)
  skillsRequired  String?   // JSON array: ["construction", "teaching", "admin"]
  location        String?
  isRemote        Boolean   @default(false)
  startDate       DateTime?
  endDate         DateTime?
  status          String    @default("open") // open, filled, closed
  maxVolunteers   Int?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  project  Project           @relation(fields: [projectId], references: [id], onDelete: Cascade)
  signups  VolunteerSignup[]
  logs     VolunteerLog[]

  @@index([projectId, status])
  @@index([status, startDate])
}

model VolunteerSignup {
  id            String   @id @default(cuid())
  opportunityId String
  userId        String
  status        String   @default("interested") // interested, confirmed, completed, cancelled
  message       String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  opportunity VolunteerOpportunity @relation(fields: [opportunityId], references: [id], onDelete: Cascade)
  user        User                 @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([opportunityId, userId])
}

model VolunteerLog {
  id            String    @id @default(cuid())
  opportunityId String
  userId        String
  hours         Float
  date          DateTime
  description   String?
  verified      Boolean   @default(false)
  verifiedBy    String?
  verifiedAt    DateTime?
  createdAt     DateTime  @default(now())

  opportunity VolunteerOpportunity @relation(fields: [opportunityId], references: [id], onDelete: Cascade)
  user        User                 @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, date])
  @@index([opportunityId])
}

model UserSkill {
  id          String   @id @default(cuid())
  userId      String
  skill       String
  category    String   // technical, professional, trade, education, administrative
  level       String   @default("intermediate") // beginner, intermediate, expert
  description String?
  isPublic    Boolean  @default(true)
  createdAt   DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, skill])
  @@index([skill])
  @@index([category])
}

model InKindDonation {
  id          String    @id @default(cuid())
  projectId   String
  userId      String
  type        String    // materials, equipment, space, services
  description String
  value       Float?    // Estimated value (optional)
  status      String    @default("offered") // offered, accepted, received, declined
  receivedAt  DateTime?
  notes       String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([projectId, status])
  @@index([userId])
}

model ProjectNeed {
  id             String   @id @default(cuid())
  projectId      String
  type           String   // materials, equipment, space, services, volunteer_hours
  description    String
  quantity       Int?
  estimatedValue Float?
  fulfilled      Boolean  @default(false)
  fulfilledBy    String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId, fulfilled])
}

// ==================== Corporate Portal ====================

model CorporateAccount {
  id                String    @id @default(cuid())
  name              String    // Company name
  slug              String    @unique
  logoUrl           String?
  primaryColor      String?   // Brand color hex
  secondaryColor    String?
  adminEmail        String
  tier              String    @default("starter") // starter, growth, enterprise
  employeeLimit     Int?
  matchingBudget    Float     @default(0)
  matchingSpent     Float     @default(0)
  matchingRatio     Float     @default(1) // 1:1, 2:1, etc.
  matchingCategories String?  // JSON array of categories, empty = all
  billingEmail      String?
  contractStart     DateTime?
  contractEnd       DateTime?
  status            String    @default("active") // active, suspended, expired
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  employees       CorporateEmployee[]
  invites         CorporateInvite[]
  campaigns       CorporateCampaign[]
  reports         CorporateReport[]
  matchingHistory CorporateMatchingRecord[]

  @@index([status])
}

model CorporateEmployee {
  id                 String   @id @default(cuid())
  corporateAccountId String
  userId             String   @unique
  employeeId         String?  // Internal employee ID (optional)
  department         String?
  isAdmin            Boolean  @default(false)
  joinedAt           DateTime @default(now())
  status             String   @default("active") // active, inactive

  corporateAccount CorporateAccount @relation(fields: [corporateAccountId], references: [id], onDelete: Cascade)
  user             User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([corporateAccountId, employeeId])
  @@index([corporateAccountId, status])
}

model CorporateInvite {
  id                 String    @id @default(cuid())
  corporateAccountId String
  email              String
  token              String    @unique
  expiresAt          DateTime
  usedAt             DateTime?
  usedBy             String?
  createdAt          DateTime  @default(now())

  corporateAccount CorporateAccount @relation(fields: [corporateAccountId], references: [id], onDelete: Cascade)

  @@index([corporateAccountId])
  @@index([token])
}

model CorporateMatchingRecord {
  id                 String   @id @default(cuid())
  corporateAccountId String
  userId             String
  originalAmount     Float
  matchedAmount      Float
  projectId          String?
  loanId             String?
  category           String?
  matchDate          DateTime @default(now())

  corporateAccount CorporateAccount @relation(fields: [corporateAccountId], references: [id], onDelete: Cascade)

  @@index([corporateAccountId, matchDate])
  @@index([userId])
}

model CorporateCampaign {
  id                 String   @id @default(cuid())
  corporateAccountId String
  name               String
  description        String?
  startDate          DateTime
  endDate            DateTime
  targetAmount       Float?
  currentAmount      Float    @default(0)
  matchingBonus      Float?   // Extra matching during campaign
  featuredProjects   String?  // JSON array of project IDs
  categories         String?  // JSON array of focus categories
  status             String   @default("draft") // draft, active, completed
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  corporateAccount CorporateAccount @relation(fields: [corporateAccountId], references: [id], onDelete: Cascade)

  @@index([corporateAccountId, status])
  @@index([status, startDate])
}

model CorporateReport {
  id                 String   @id @default(cuid())
  corporateAccountId String
  type               String   // monthly, quarterly, annual, custom
  startDate          DateTime
  endDate            DateTime
  data               String   // JSON aggregated metrics
  pdfUrl             String?
  generatedAt        DateTime @default(now())

  corporateAccount CorporateAccount @relation(fields: [corporateAccountId], references: [id], onDelete: Cascade)

  @@index([corporateAccountId, type])
}

// ============================================================================
// GIVING CIRCLES
// ============================================================================

model GivingCircle {
  id               String   @id @default(cuid())
  name             String
  slug             String   @unique
  description      String?
  imageUrl         String?
  isPrivate        Boolean  @default(false)
  memberLimit      Int?     // null = unlimited
  minContribution  Float?   // Monthly minimum (optional)
  pooledBalance    Float    @default(0)
  totalContributed Float    @default(0)
  totalDeployed    Float    @default(0)
  votingThreshold  Float    @default(0.5) // % needed to approve
  votingPeriod     Int      @default(7) // days
  focusCategories  String?  // JSON array of preferred categories
  focusCommunities String?  // JSON array of preferred community IDs
  status           String   @default("active") // active, paused, archived
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  members       CircleMember[]
  contributions CircleContribution[]
  proposals     CircleProposal[]
  activity      CircleActivity[]
  invites       CircleInvite[]
  discussions   CircleDiscussion[]
  recurring     CircleRecurring[]

  @@index([status])
}

model CircleMember {
  id               String   @id @default(cuid())
  circleId         String
  userId           String
  role             String   @default("member") // founder, admin, member
  totalContributed Float    @default(0)
  joinedAt         DateTime @default(now())
  status           String   @default("active") // active, inactive, left

  circle GivingCircle @relation(fields: [circleId], references: [id], onDelete: Cascade)
  user   User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([circleId, userId])
  @@index([userId])
}

model CircleContribution {
  id        String   @id @default(cuid())
  circleId  String
  userId    String
  amount    Float
  note      String?
  createdAt DateTime @default(now())

  circle GivingCircle @relation(fields: [circleId], references: [id], onDelete: Cascade)

  @@index([circleId, createdAt])
  @@index([userId])
}

model CircleInvite {
  id        String    @id @default(cuid())
  circleId  String
  email     String?
  token     String    @unique
  invitedBy String
  expiresAt DateTime
  usedAt    DateTime?
  usedBy    String?
  createdAt DateTime  @default(now())

  circle GivingCircle @relation(fields: [circleId], references: [id], onDelete: Cascade)

  @@index([circleId])
  @@index([token])
}

model CircleProposal {
  id           String    @id @default(cuid())
  circleId     String
  proposerId   String
  projectId    String?   // For project funding
  loanId       String?   // For loan funding
  type         String    // project, loan, custom
  title        String
  description  String?
  amount       Float
  votingEnds   DateTime
  status       String    @default("voting") // voting, approved, rejected, funded, expired
  yesVotes     Int       @default(0)
  noVotes      Int       @default(0)
  abstainVotes Int       @default(0)
  fundedAt     DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  circle GivingCircle @relation(fields: [circleId], references: [id], onDelete: Cascade)
  votes  CircleVote[]

  @@index([circleId, status])
  @@index([votingEnds])
}

model CircleVote {
  id         String   @id @default(cuid())
  proposalId String
  userId     String
  vote       String   // yes, no, abstain
  comment    String?
  createdAt  DateTime @default(now())

  proposal CircleProposal @relation(fields: [proposalId], references: [id], onDelete: Cascade)

  @@unique([proposalId, userId])
}

model CircleActivity {
  id        String   @id @default(cuid())
  circleId  String
  type      String   // contribution, proposal_created, vote_cast, proposal_funded, member_joined, member_left, discussion
  actorId   String?
  data      String   // JSON data
  createdAt DateTime @default(now())

  circle GivingCircle @relation(fields: [circleId], references: [id], onDelete: Cascade)

  @@index([circleId, createdAt])
}

model CircleDiscussion {
  id        String   @id @default(cuid())
  circleId  String
  userId    String
  content   String
  parentId  String?  // For threading
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  circle GivingCircle @relation(fields: [circleId], references: [id], onDelete: Cascade)

  @@index([circleId, createdAt])
  @@index([parentId])
}

model CircleRecurring {
  id             String   @id @default(cuid())
  circleId       String
  userId         String
  amount         Float
  frequency      String   @default("monthly")
  nextChargeDate DateTime
  status         String   @default("active") // active, paused, cancelled
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  circle GivingCircle @relation(fields: [circleId], references: [id], onDelete: Cascade)

  @@unique([circleId, userId])
  @@index([nextChargeDate, status])
}

// ============================================
// Plan 15: Seasonal & Event-Driven Giving
// ============================================

model GivingOccasion {
  id              String   @id @default(cuid())
  name            String
  slug            String   @unique
  type            String   // holiday, awareness, disaster, personal, local
  description     String?
  startDate       DateTime
  endDate         DateTime
  imageUrl        String?
  iconName        String?  // Lucide icon name
  color           String?  // Theme color
  isRecurring     Boolean  @default(false)
  recurrenceRule  String?  // iCal RRULE for annual events
  matchingBonus   Float?   // Extra matching during occasion
  featuredProjects String? // Comma-separated project IDs
  categories      String?  // Comma-separated categories
  isGlobal        Boolean  @default(true) // vs community-specific
  communityId     String?  // For local occasions
  status          String   @default("active") // draft, active, completed
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  scheduledGifts ScheduledGift[]

  @@index([status, startDate])
  @@index([type])
}

model GiftContribution {
  id               String    @id @default(cuid())
  contributorId    String
  recipientName    String
  recipientEmail   String?
  occasionType     String    // birthday, memorial, celebration, thank_you, holiday
  message          String?
  amount           Float
  projectId        String?
  communityId      String?
  isAnonymous      Boolean   @default(false)
  notificationSent Boolean   @default(false)
  notificationDate DateTime?
  certificateUrl   String?
  createdAt        DateTime  @default(now())

  contributor User @relation(fields: [contributorId], references: [id], onDelete: Cascade)

  @@index([contributorId])
  @@index([notificationDate])
}

model BirthdayFundraiser {
  id            String   @id @default(cuid())
  userId        String
  projectId     String?
  communityId   String?
  title         String
  description   String
  birthdayDate  DateTime
  goalAmount    Float
  currentAmount Float    @default(0)
  backerCount   Int      @default(0)
  status        String   @default("active") // active, completed, cancelled
  shareUrl      String   @unique
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  project Project? @relation(fields: [projectId], references: [id])

  @@index([userId])
  @@index([birthdayDate])
  @@index([shareUrl])
  @@index([status])
}

model EmergencyCampaign {
  id              String    @id @default(cuid())
  title           String
  slug            String    @unique
  description     String
  type            String    // natural_disaster, crisis, emergency, humanitarian
  location        String?
  affectedArea    String?   // GeoJSON as string
  startDate       DateTime  @default(now())
  endDate         DateTime?
  targetAmount    Float?
  currentAmount   Float     @default(0)
  backerCount     Int       @default(0)
  verifiedOrgs    String?   // Comma-separated organization IDs
  status          String    @default("active") // active, resolved, closed
  updateFrequency String    @default("daily") // How often updates are posted
  priority        Int       @default(0) // For ordering (higher = more urgent)
  createdBy       String    // Admin who created
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  updates EmergencyUpdate[]

  @@index([status])
  @@index([priority])
}

model EmergencyUpdate {
  id         String   @id @default(cuid())
  campaignId String
  title      String
  content    String
  authorId   String
  createdAt  DateTime @default(now())

  campaign EmergencyCampaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@index([campaignId, createdAt])
}

model ScheduledGift {
  id             String    @id @default(cuid())
  userId         String
  occasionId     String?   // Link to GivingOccasion
  customOccasion String?   // User-defined occasion
  scheduledDate  DateTime
  amount         Float
  projectId      String?
  communityId    String?
  recipientName  String?   // For gift contributions
  recipientEmail String?
  message        String?
  status         String    @default("scheduled") // scheduled, completed, skipped, failed
  completedAt    DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  user     User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  occasion GivingOccasion? @relation(fields: [occasionId], references: [id], onDelete: SetNull)

  @@index([userId, scheduledDate])
  @@index([scheduledDate, status])
}

model SeasonalCampaign {
  id               String   @id @default(cuid())
  name             String
  slug             String   @unique
  tagline          String?
  description      String
  startDate        DateTime
  endDate          DateTime
  platformGoal     Float?
  platformProgress Float    @default(0)
  matchingPartner  String?
  matchingRatio    Float?
  heroImageUrl     String?
  themeColor       String?
  featuredProjects String?  // Comma-separated project IDs
  badges           String?  // Comma-separated badge keys for this campaign
  status           String   @default("draft") // draft, active, completed
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([status, startDate])
}

// ==========================================
// Credit Bureau Reporting (Plan 16)
// ==========================================

model CreditReportingConsent {
  id              String    @id @default(cuid())
  userId          String
  loanId          String    @unique
  consentGiven    Boolean
  consentDate     DateTime
  consentVersion  String    // Version of consent form
  ipAddress       String?
  userAgent       String?
  withdrawnAt     DateTime?
  withdrawnReason String?
  createdAt       DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  loan Loan @relation(fields: [loanId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model CreditReportingStatus {
  id              String    @id @default(cuid())
  loanId          String    @unique
  isReporting     Boolean   @default(false)
  bureaus         String?   // Comma-separated: experian,transunion,equifax
  firstReportDate DateTime?
  lastReportDate  DateTime?
  reportingErrors String?   // JSON string for errors
  status          String    @default("pending") // pending, active, completed, error
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  loan Loan @relation(fields: [loanId], references: [id], onDelete: Cascade)
}

model Metro2Record {
  id              String    @id @default(cuid())
  loanId          String
  recordType      String    // header, base, trailer
  reportingPeriod DateTime
  accountStatus   String    // 11=current, 71=30days, 78=60days, etc.
  paymentHistory  String    // 24-month payment pattern
  currentBalance  Float
  amountPastDue   Float     @default(0)
  dateOpened      DateTime
  scheduledPayment Float
  actualPayment   Float?
  rawData         String    // The formatted Metro 2 record
  submitted       Boolean   @default(false)
  submittedAt     DateTime?
  accepted        Boolean?
  rejectionReason String?
  createdAt       DateTime  @default(now())

  loan Loan @relation(fields: [loanId], references: [id], onDelete: Cascade)

  @@index([loanId, reportingPeriod])
  @@index([submitted, reportingPeriod])
}

model BureauConnection {
  id              String    @id @default(cuid())
  bureau          String    @unique // experian, transunion, equifax
  furnisherId     String    // Deluge's furnisher ID with this bureau
  apiEndpoint     String
  apiKeyEncrypted String    // Encrypted API credentials
  status          String    @default("pending") // pending, active, suspended
  lastSubmission  DateTime?
  lastSuccess     DateTime?
  lastError       String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

model BureauSubmission {
  id              String    @id @default(cuid())
  bureau          String
  reportingPeriod DateTime
  recordCount     Int
  fileReference   String    // Submission file ID
  status          String    @default("pending") // pending, submitted, accepted, rejected
  submittedAt     DateTime?
  responseAt      DateTime?
  acceptedCount   Int?
  rejectedCount   Int?
  errorDetails    String?   // JSON string for error details
  createdAt       DateTime  @default(now())

  @@index([bureau, reportingPeriod])
  @@index([status])
}

model CreditDispute {
  id               String    @id @default(cuid())
  loanId           String
  userId           String
  disputeType      String    // balance, payment_history, account_status, identity
  description      String
  evidence         String?   // JSON string for uploaded documents
  status           String    @default("open") // open, investigating, resolved, escalated
  resolution       String?
  resolvedAt       DateTime?
  resolvedBy       String?
  bureauNotified   Boolean   @default(false)
  bureauNotifiedAt DateTime?
  dueDate          DateTime  // 30 days from creation
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  loan  Loan               @relation(fields: [loanId], references: [id], onDelete: Cascade)
  user  User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  notes CreditDisputeNote[]

  @@index([status, dueDate])
  @@index([loanId])
  @@index([userId])
}

model CreditDisputeNote {
  id         String   @id @default(cuid())
  disputeId  String
  authorId   String
  content    String
  isInternal Boolean  @default(true)
  createdAt  DateTime @default(now())

  dispute CreditDispute @relation(fields: [disputeId], references: [id], onDelete: Cascade)

  @@index([disputeId])
}

// ============================================================================
// COMMUNITY ADVOCATES
// Natural leaders who help others - no tiers, points, or gamification
// ============================================================================

model CommunityAdvocate {
  id            String   @id @default(cuid())
  userId        String   @unique
  status        String   @default("active") // active, paused, alumni
  region        String?  // Geographic focus
  communityIds  String?  // Comma-separated community IDs they support
  interests     String?  // Comma-separated areas (events, onboarding, content)
  bio           String?
  publicProfile Boolean  @default(true)
  joinedAt      DateTime @default(now())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user       User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  activities AdvocateActivity[]
  events     AdvocateEvent[]

  @@index([status])
  @@index([region])
}

model AdvocateInterest {
  id           String    @id @default(cuid())
  userId       String    @unique
  motivation   String    // Why they want to help
  interests    String?   // Comma-separated interests
  availability String?   // General availability
  region       String?
  status       String    @default("pending") // pending, welcomed, declined
  welcomedBy   String?
  welcomedAt   DateTime?
  createdAt    DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([status])
}

model AdvocateActivity {
  id          String   @id @default(cuid())
  advocateId  String
  type        String   // welcome, event, content, support, outreach
  description String
  communityId String?  // Which community this was for
  createdAt   DateTime @default(now())

  advocate CommunityAdvocate @relation(fields: [advocateId], references: [id], onDelete: Cascade)

  @@index([advocateId, type])
  @@index([createdAt])
}

model AdvocateEvent {
  id          String    @id @default(cuid())
  advocateId  String
  communityId String?
  title       String
  description String
  type        String    // meetup, workshop, welcome_session, info_session
  date        DateTime
  endDate     DateTime?
  location    String?
  isVirtual   Boolean   @default(false)
  virtualLink String?
  recap       String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  advocate CommunityAdvocate   @relation(fields: [advocateId], references: [id], onDelete: Cascade)
  rsvps    AdvocateEventRSVP[]

  @@index([advocateId, date])
  @@index([communityId, date])
  @@index([date])
}

model AdvocateEventRSVP {
  id        String   @id @default(cuid())
  eventId   String
  userId    String?
  email     String?  // For non-users
  name      String?
  attended  Boolean  @default(false)
  createdAt DateTime @default(now())

  event AdvocateEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@unique([eventId, userId])
  @@index([eventId])
}

model AdvocateResource {
  id          String   @id @default(cuid())
  title       String
  description String?
  type        String   // presentation, flyer, video, guide, template
  category    String   // welcome, events, outreach
  fileUrl     String?
  content     String?  // For text-based resources
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([category, type])
}

model AdvocateAppreciation {
  id          String   @id @default(cuid())
  advocateId  String
  type        String   // thank_you, highlight, invite, swag
  message     String?
  sentBy      String   // Admin who sent it
  sentAt      DateTime @default(now())

  @@index([advocateId])
}

// =============================================================================
// Project Verification & Auditing (Plan 18)
// =============================================================================

model ProjectVerification {
  id                   String    @id @default(cuid())
  projectId            String    @unique
  level                String    @default("unverified") // unverified, basic, verified, audited
  organizationVerified Boolean   @default(false)
  documentsVerified    Boolean   @default(false)
  outcomeVerified      Boolean   @default(false)
  trustScore           Float?    // Calculated trust score 0-100
  lastVerifiedAt       DateTime?
  lastVerifiedBy       String?
  expiresAt            DateTime?
  notes                String?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  project Project             @relation(fields: [projectId], references: [id], onDelete: Cascade)
  checks  VerificationCheck[]
  audits  ProjectAudit[]
}

model VerificationCheck {
  id             String    @id @default(cuid())
  verificationId String
  checkType      String    // identity, documents, location, organization, outcome
  status         String    @default("pending") // pending, passed, failed, expired
  evidence       String?   // JSON string of submitted evidence
  reviewedBy     String?
  reviewedAt     DateTime?
  reviewNotes    String?
  expiresAt      DateTime?
  createdAt      DateTime  @default(now())

  verification ProjectVerification @relation(fields: [verificationId], references: [id], onDelete: Cascade)

  @@index([verificationId, checkType])
  @@index([status])
}

model IdentityVerification {
  id              String    @id @default(cuid())
  userId          String
  type            String    // personal, business
  status          String    @default("pending") // pending, verified, rejected, expired
  provider        String?   // stripe_identity, manual
  providerRef     String?   // External verification ID
  documentType    String?   // drivers_license, passport, ein
  verifiedName    String?
  verifiedAddress String?
  verifiedAt      DateTime?
  expiresAt       DateTime?
  rejectionReason String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, status])
}

model OrganizationVerification {
  id                  String    @id @default(cuid())
  projectId           String?
  businessId          String?   // For business directory
  organizationName    String
  ein                 String?
  registrationNumber  String?
  registrationType    String?   // 501c3, 501c4, government, llc
  verificationStatus  String    @default("pending") // pending, verified, rejected, expired
  verifiedAt          DateTime?
  verifiedBy          String?
  documents           String?   // JSON string of document URLs
  notes               String?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  @@index([ein])
  @@index([verificationStatus])
  @@index([projectId])
}

model OutcomeVerification {
  id                  String    @id @default(cuid())
  projectId           String
  outcomeType         String    // completion, impact_metric, milestone
  description         String
  targetValue         Float?
  actualValue         Float?
  evidence            String?   // JSON string of evidence (photos, receipts, documents)
  status              String    @default("pending") // pending, verified, disputed, unverified
  verifiedBy          String?
  verifiedAt          DateTime?
  verificationMethod  String?   // self_reported, community, third_party
  notes               String?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  project              Project                 @relation(fields: [projectId], references: [id], onDelete: Cascade)
  communityVerifications CommunityVerification[]

  @@index([projectId, status])
}

model CommunityVerification {
  id           String   @id @default(cuid())
  outcomeId    String
  userId       String
  relationship String   // beneficiary, witness, neighbor, volunteer
  verification String   // confirmed, disputed
  comment      String?
  evidence     String?  // JSON string of evidence
  createdAt    DateTime @default(now())

  outcome OutcomeVerification @relation(fields: [outcomeId], references: [id], onDelete: Cascade)

  @@unique([outcomeId, userId])
  @@index([outcomeId])
}

model ProjectAudit {
  id             String    @id @default(cuid())
  verificationId String
  auditorId      String    // User who conducted audit
  auditorOrg     String?   // Auditing organization
  auditType      String    // financial, impact, compliance
  scope          String    // What was audited
  findings       String?   // JSON string of audit findings
  rating         String?   // pass, conditional, fail
  reportUrl      String?
  startDate      DateTime
  completedDate  DateTime?
  status         String    @default("scheduled") // scheduled, in_progress, completed, cancelled
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  verification ProjectVerification @relation(fields: [verificationId], references: [id], onDelete: Cascade)

  @@index([verificationId])
  @@index([status])
}

model Auditor {
  id              String    @id @default(cuid())
  userId          String    @unique
  organization    String
  credentials     String    // Comma-separated credentials
  specialties     String    // Comma-separated specialties/categories
  status          String    @default("pending") // pending, approved, suspended
  approvedAt      DateTime?
  approvedBy      String?
  auditsCompleted Int       @default(0)
  averageRating   Float?
  bio             String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([status])
}

model ProjectFlag {
  id          String    @id @default(cuid())
  projectId   String
  type        String    // duplicate, suspicious_funding, unresponsive, misuse, fraud
  severity    String    // low, medium, high, critical
  description String
  evidence    String?   // JSON string of evidence
  status      String    @default("open") // open, investigating, resolved, dismissed
  reportedBy  String?   // User ID or "system"
  assignedTo  String?   // Admin investigating
  resolvedBy  String?
  resolvedAt  DateTime?
  resolution  String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId, status])
  @@index([severity, status])
  @@index([type])
}

// =============================================================================
// Developer API & Integrations (Plan 19)
// =============================================================================

model ApiKey {
  id           String    @id @default(cuid())
  userId       String
  name         String
  keyHash      String    @unique // Hashed key for lookup
  keyPrefix    String    // First 8 chars for identification
  scopes       String    // Comma-separated: read, write, webhooks
  rateLimit    Int       @default(1000) // Requests per hour
  status       String    @default("active") // active, revoked, expired
  lastUsedAt   DateTime?
  usageCount   Int       @default(0)
  expiresAt    DateTime?
  createdAt    DateTime  @default(now())
  revokedAt    DateTime?
  revokedReason String?

  user User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  logs ApiRequestLog[]

  @@index([keyHash])
  @@index([userId, status])
}

model ApiRequestLog {
  id           String   @id @default(cuid())
  apiKeyId     String
  endpoint     String
  method       String
  statusCode   Int
  responseTime Int      // ms
  ipAddress    String?
  userAgent    String?
  createdAt    DateTime @default(now())

  apiKey ApiKey @relation(fields: [apiKeyId], references: [id], onDelete: Cascade)

  @@index([apiKeyId, createdAt])
  @@index([endpoint, createdAt])
}

model Webhook {
  id              String    @id @default(cuid())
  userId          String
  name            String
  url             String
  secret          String    // For signature verification
  events          String    // Comma-separated: project.funded, loan.repaid, etc.
  status          String    @default("active") // active, paused, failed
  failureCount    Int       @default(0)
  lastTriggeredAt DateTime?
  lastSuccessAt   DateTime?
  lastErrorAt     DateTime?
  lastError       String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  user       User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  deliveries WebhookDelivery[]

  @@index([userId, status])
}

model WebhookDelivery {
  id           String    @id @default(cuid())
  webhookId    String
  event        String
  payload      String    // JSON string
  statusCode   Int?
  responseBody String?
  duration     Int?      // ms
  status       String    @default("pending") // pending, delivered, failed
  attempts     Int       @default(0)
  nextRetry    DateTime?
  createdAt    DateTime  @default(now())

  webhook Webhook @relation(fields: [webhookId], references: [id], onDelete: Cascade)

  @@index([webhookId, createdAt])
  @@index([status, nextRetry])
}

model OAuthApp {
  id               String    @id @default(cuid())
  userId           String    // App owner
  name             String
  description      String?
  logoUrl          String?
  websiteUrl       String?
  redirectUris     String    // Comma-separated URIs
  clientId         String    @unique
  clientSecretHash String
  scopes           String    // Comma-separated allowed scopes
  status           String    @default("pending") // pending, approved, suspended
  approvedAt       DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  user           User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  authorizations OAuthAuthorization[]

  @@index([clientId])
}

model OAuthAuthorization {
  id                    String    @id @default(cuid())
  appId                 String
  userId                String
  scopes                String    // Comma-separated granted scopes
  // Authorization code (temporary, before token exchange)
  authCode              String?   @unique
  codeExpiresAt         DateTime?
  // Tokens (hashed for security)
  accessToken           String?   @unique
  accessTokenExpiresAt  DateTime?
  refreshToken          String?   @unique
  refreshTokenExpiresAt DateTime?
  revokedAt             DateTime?
  createdAt             DateTime  @default(now())

  app  OAuthApp @relation(fields: [appId], references: [id], onDelete: Cascade)
  user User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([accessToken])
  @@index([authCode])
  @@index([userId, appId])
}

// ============================================================================
// Plan 20: Smart Discovery & Recommendations
// ============================================================================

model UserInterestProfile {
  id            String   @id @default(cuid())
  userId        String   @unique
  categories    String   @default("{}") // JSON: { "education": 0.8, "environment": 0.6 }
  communities   String   @default("{}") // JSON: { "community_id": weight }
  projectTypes  String   @default("{}") // JSON: { "infrastructure": 0.7 }
  givingPatterns String  @default("{}") // JSON: { "avg_amount": 25, "frequency": "weekly" }
  locationPrefs String   @default("{}") // JSON: { "radius_miles": 50, "include_remote": true }
  timePrefs     String   @default("{}") // JSON: { "prefer_urgent": true }
  lastUpdated   DateTime @default(now())
  createdAt     DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model UserInteraction {
  id         String   @id @default(cuid())
  userId     String
  entityType String   // project, community, loan, business
  entityId   String
  action     String   // view, fund, follow, share, save, dismiss
  weight     Float    @default(1) // Interaction strength
  context    String?  // JSON: { "source": "feed", "duration_sec": 45 }
  createdAt  DateTime @default(now())

  @@index([userId, entityType, createdAt])
  @@index([entityId, action])
}

model UserSimilarity {
  id            String   @id @default(cuid())
  userId        String
  similarUserId String
  score         Float    // 0-1 similarity score
  basis         String   // funding, following, category
  calculatedAt  DateTime @default(now())

  @@unique([userId, similarUserId, basis])
  @@index([userId, score])
}

model ProjectSimilarity {
  id               String   @id @default(cuid())
  projectId        String
  similarProjectId String
  score            Float
  basis            String   // category, community, backers
  calculatedAt     DateTime @default(now())

  @@unique([projectId, similarProjectId])
  @@index([projectId, score])
}

model Recommendation {
  id         String    @id @default(cuid())
  userId     String
  entityType String    // project, community, loan
  entityId   String
  score      Float
  reason     String    // "similar_to_funded", "trending_in_area", etc.
  signals    String    // JSON: Contributing signals and weights
  shown      Boolean   @default(false)
  shownAt    DateTime?
  clicked    Boolean   @default(false)
  clickedAt  DateTime?
  converted  Boolean   @default(false) // Funded/joined
  expiresAt  DateTime
  createdAt  DateTime  @default(now())

  @@unique([userId, entityType, entityId])
  @@index([userId, entityType, score])
  @@index([expiresAt])
}

model MatchScore {
  id           String   @id @default(cuid())
  userId       String
  projectId    String
  score        Float    // 0-1 match quality
  breakdown    String   // JSON: { "category": 0.8, "location": 0.7, "history": 0.9 }
  calculatedAt DateTime @default(now())
  expiresAt    DateTime

  @@unique([userId, projectId])
  @@index([userId, score])
  @@index([projectId, score])
}

model DigestPreferences {
  id               String    @id @default(cuid())
  userId           String    @unique
  frequency        String    @default("weekly") // never, weekly, monthly
  dayOfWeek        Int?      // 0-6 for weekly
  categories       String    @default("[]") // JSON array of focus categories
  includeLoans     Boolean   @default(true)
  includeVolunteer Boolean   @default(true)
  lastSent         DateTime?
  nextSend         DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model DiscoveryChallenge {
  id           String    @id @default(cuid())
  userId       String
  type         String    // explore_categories, fund_new_community, etc.
  target       Int
  progress     Int       @default(0)
  reward       String    // badge, watershed_credit
  rewardAmount Float?
  status       String    @default("active") // active, completed, expired
  expiresAt    DateTime
  completedAt  DateTime?
  createdAt    DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, status])
}

model RecommendationMetrics {
  id          String   @id @default(cuid())
  date        DateTime
  algorithm   String   // collaborative, content, hybrid
  entityType  String
  impressions Int      @default(0)
  clicks      Int      @default(0)
  conversions Int      @default(0)
  avgPosition Float?
  avgScore    Float?
  createdAt   DateTime @default(now())

  @@unique([date, algorithm, entityType])
  @@index([date])
}

